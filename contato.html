<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Divisão de Mantimentos — Versão Moderna</title>

<!-- Tipografia -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
<!-- Icons (Material Symbols) -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,500,0,0" />

<!-- jsPDF e autoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --bg: #f6f8fb;
  --card: #ffffff;
  --text: #273143;
  --muted: #6b7280;
  --brand-1: #7dd3fc;  /* azul claro */
  --brand-2: #a7f3d0;  /* verde água */
  --brand-3: #c7d2fe;  /* lilás */
  --accent: #4f46e5;   /* índigo */
  --ok: #16a34a;
  --warn: #ef4444;
  --shadow: 0 8px 24px rgba(17, 24, 39, .08);
  --radius: 14px;
  --radius-sm: 10px;
  --transition: 220ms cubic-bezier(.2,.8,.2,1);
}

/* page */
*{ box-sizing: border-box; }
html, body{ height:100%; }
body{
  margin:0;
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(167,243,208,.25), transparent 60%),
    radial-gradient(1000px 500px at 110% 0%, rgba(125,211,252,.30), transparent 60%),
    var(--bg);
  color: var(--text);
  font: 400 15px/1.5 'Poppins', 'Roboto', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
  letter-spacing:.2px;
}

/* header */
header{
  position: sticky; top:0; z-index:10;
  padding:16px clamp(12px, 3vw, 24px);
  background: linear-gradient(135deg, rgba(79,70,229,.95), rgba(14,165,233,.95));
  color:#fff;
  backdrop-filter: blur(6px);
  box-shadow: var(--shadow);
}
.header-wrap{
  max-width:1100px; margin:0 auto; display:flex; align-items:center; gap:12px;
}
.header-icon{
  display:grid; place-items:center; width:40px; height:40px; border-radius:12px;
  background: linear-gradient(135deg, rgba(255,255,255,.3), rgba(255,255,255,.1));
}
header h1{ margin:0; font-size:clamp(18px, 2.6vw, 22px); letter-spacing:.3px; font-weight:600; }

/* main container */
main{
  max-width:1100px;
  margin:18px auto 80px;
  padding:0 clamp(10px, 3vw, 18px);
}

/* tabs */
.tab{
  display:flex; flex-wrap:wrap; gap:8px;
  margin-bottom:12px;
}
.tab button{
  appearance:none; border:none; cursor:pointer;
  padding:10px 14px; font-weight:600; border-radius:999px;
  background: linear-gradient(135deg, #eef2ff, #ecfeff);
  color:#334155;
  box-shadow: 0 2px 0 rgba(0,0,0,.04) inset;
  transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
}
.tab button:hover{ transform: translateY(-1px); }
.tab button.active{
  background: linear-gradient(135deg, var(--brand-3), var(--brand-1));
  box-shadow: var(--shadow);
  color:#111827;
}

.tabcontent{ display:none; }
.tabcontent.active{ display:block; }

/* section shells */
.section{
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: clamp(12px, 2.4vw, 18px);
}

/* helpers */
h2{ font-size:1rem; margin:0 0 8px; font-weight:600; }
h3{ font-size:.95rem; margin:12px 0 8px; font-weight:600; }
p.instrucao{
  margin:8px 0 12px;
  padding:10px 12px;
  border-radius: 10px;
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  color: var(--muted);
  border:1px solid #e5e7eb;
}

/* group selector */
.group-grid{
  display:grid; gap:10px;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
}
.group-card{
  display:flex; gap:12px; align-items:center;
  background: linear-gradient(135deg, #ffffff, #fbfdff);
  border:1px solid #eef2f7;
  padding:12px; border-radius: var(--radius);
  transition: transform var(--transition), box-shadow var(--transition), border-color var(--transition);
}
.group-card:hover{ transform: translateY(-2px); box-shadow: var(--shadow); border-color:#e5e7eb; }
.group-card input{ accent-color: var(--accent); width:18px; height:18px; }
.group-card strong{ display:block; }

/* professor cards (saldos) */
.card-grid{
  display:grid; gap:14px;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
}
.prof-card{
  display:flex; flex-direction:column; gap:10px;
  background: linear-gradient(160deg, #ffffff 0%, #fafcff 60%, #f8fbff 100%);
  border:1px solid #eef2f7;
  border-radius: var(--radius);
  padding:14px;
  transition: transform var(--transition), box-shadow var(--transition), border-color var(--transition);
}
.prof-card:hover{ transform: translateY(-3px); box-shadow: var(--shadow); border-color:#e5e7eb; }
.prof-head{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.prof-name{
  display:flex; align-items:center; gap:10px; font-weight:600;
}
.prof-name .avatar{
  width:36px; height:36px; border-radius:50%;
  background: linear-gradient(135deg, var(--brand-1), var(--brand-3));
  display:grid; place-items:center; color:#111827; font-weight:700;
}
.badge{
  padding:4px 10px; border-radius:999px; font-size:.8rem; font-weight:600;
  border:1px solid #e5e7eb; background:#fff;
}
.badge.ok{ color:var(--ok); border-color: rgba(22,163,74,.25); background: rgba(16,185,129,.06); }
.badge.neg{ color:var(--warn); border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.06); }

.prof-body{
  display:flex; gap:12px; align-items:flex-start;
}
.prof-col{
  flex:1 1 50%;
}
.prof-label{ font-size:.8rem; color:var(--muted); margin-bottom:4px; }
.prof-amount{ font-size:1.05rem; font-weight:600; }

/* compras list inside card */
.card-list{
  max-height: 140px; overflow:auto; padding-right:4px;
  border:1px dashed #e5e7eb; border-radius: var(--radius-sm);
  background: #fff;
}
.list-item{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:8px 10px; border-bottom:1px solid #f1f5f9;
}
.list-item:last-child{ border-bottom:none; }
.list-item .left{
  display:flex; flex-direction:column;
}
.list-item .title{ font-weight:600; font-size:.92rem; }
.list-item .meta{ font-size:.8rem; color:var(--muted); }

/* purchases table (aba Compras) */
.table-wrap{
  background: var(--card); border:1px solid #eef2f7; border-radius: var(--radius);
  box-shadow: var(--shadow); overflow:auto; white-space: nowrap;
}
table{ width:100%; border-collapse: collapse; font-size:.9rem; }
th, td{ text-align:left; padding:10px 12px; border-bottom:1px solid #eef2f7; }
th{ background: linear-gradient(180deg, #fafcff, #f6f8fb); position: sticky; top:0; z-index:1; }

/* bottões */
.button{
  appearance:none; border:none; cursor:pointer;
  padding:10px 12px; border-radius: 10px;
  font-weight:600; display:inline-flex; align-items:center; gap:8px;
  background: linear-gradient(135deg, #eef2ff, #ecfeff);
  transition: transform var(--transition), box-shadow var(--transition), opacity var(--transition), background var(--transition);
}
.button:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }
.button.primary{
  background: linear-gradient(135deg, #c7d2fe, #a7f3d0);
}
.button.danger{
  background: linear-gradient(135deg, #fee2e2, #fff1f2);
  color:#b91c1c;
}
.icon{ font-family: 'Material Symbols Rounded'; font-size:20px; line-height:0; }

/* FAB */
.fab{
  position: fixed; right: 18px; bottom: 76px; z-index: 50;
  width:56px; height:56px; border-radius:50%;
  display:grid; place-items:center;
  border:none; cursor:pointer; color:#fff;
  background: linear-gradient(135deg, #4f46e5, #06b6d4);
  box-shadow: 0 10px 28px rgba(79,70,229,.35);
  transition: transform var(--transition), box-shadow var(--transition), opacity var(--transition);
}
.fab:hover{ transform: translateY(-2px) scale(1.02); box-shadow: 0 12px 32px rgba(79,70,229,.45); }

/* modal */
.modal{
  position: fixed; inset:0; display:none; place-items:center; z-index:1000;
}
.modal.open{ display:grid; }
.modal-backdrop{
  position:absolute; inset:0; background: rgba(15,23,42,.45);
  backdrop-filter: blur(3px);
  animation: fadeIn .22s ease-out;
}
@keyframes fadeIn{ from{opacity:.0} to{opacity:1} }
.modal-card{
  position:relative; width:min(640px, 94vw);
  background:#fff; border-radius:16px; box-shadow: var(--shadow);
  overflow:hidden;
  transform: translateY(6px);
  animation: slideUp var(--transition) forwards;
}
@keyframes slideUp{ to{ transform: translateY(0);} }
.modal-head{
  padding:14px 16px;
  background: linear-gradient(135deg, #eef2ff, #ecfeff);
  border-bottom:1px solid #e5e7eb;
  display:flex; align-items:center; justify-content:space-between;
}
.modal-title{ font-weight:600; }
.modal-body{ padding:14px 16px; display:grid; gap:12px; }
.modal-actions{
  padding:12px 16px; display:flex; justify-content:flex-end; gap:10px;
  border-top:1px solid #e5e7eb; background:#fbfdff;
}

/* form inside modal */
.form-grid{ display:grid; gap:10px; grid-template-columns: 1fr 160px; }
.form-grid label{ font-size:.85rem; color:var(--muted); }
.form-grid input[type="text"],
.form-grid input[type="number"],
.form-grid select{
  width:100%; padding:10px 12px;
  border:1px solid #e5e7eb; border-radius:10px; outline:none;
  transition: border-color var(--transition), box-shadow var(--transition);
}
.form-grid input:focus, .form-grid select:focus{
  border-color:#c7d2fe; box-shadow: 0 0 0 4px rgba(199,210,254,.35);
}
.consumidores-box{
  max-height: 160px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px; padding:8px;
  background:#fff;
}
.consumidores-box label{ display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px; }
.consumidores-box label:hover{ background:#f8fafc; }
.consumidores-box input{ accent-color: var(--accent); }

/* toast */
.toast{
  position: fixed; right: 18px; bottom: 18px; z-index: 60;
  background: #111827; color:#fff; padding:10px 14px; border-radius: 10px;
  box-shadow: var(--shadow); opacity:0; transform: translateY(8px); pointer-events:none;
  transition: opacity var(--transition), transform var(--transition);
}
.toast.show{ opacity:1; transform: translateY(0); }

/* footer */
.site-footer{
  position: fixed; left:0; right:0; bottom:0; height: 50px;
  background:#0b1220; color:#e5e7eb; display:flex; align-items:center; justify-content:center;
  font-size:.9rem; z-index: 30; box-shadow: 0 -6px 20px rgba(2,6,23,.25);
}

/* minimal scrollbars */
*{ scrollbar-width: thin; scrollbar-color: #d1d5db transparent; }
*::-webkit-scrollbar{ width:10px; height:10px; }
*::-webkit-scrollbar-thumb{ background:#d1d5db; border-radius:999px; border:3px solid transparent; background-clip: padding-box; }
*::-webkit-scrollbar-track{ background: transparent; }

/* small */
@media (max-width:560px){
  .form-grid{ grid-template-columns: 1fr; }
  .prof-body{ flex-direction: column; }
}
</style>
</head>
<body>

<header>
  <div class="header-wrap">
    <div class="header-icon"><span class="icon">shelves</span></div>
    <h1>Divisão de Mantimentos</h1>
  </div>
</header>

<main>
  <!-- tabs -->
  <div class="tab">
    <button class="tablinks active" data-target="professores">Professores</button>
    <button class="tablinks" data-target="compras">Compras</button>
    <button class="tablinks" data-target="saldos">Saldos</button>
    <button class="tablinks" data-target="relatorio">Relatório</button>
  </div>

  <!-- Professores -->
  <section id="professores" class="tabcontent active section">
    <h2>Escolher Grupo</h2>
    <p class="instrucao">Selecione um grupo. Os professores do grupo serão usados nas compras, saldos e relatório.</p>

    <div class="group-grid">
      <label class="group-card">
        <input id="grupoA" type="radio" name="grupo" value="A">
        <div>
          <strong>Grupo A</strong>
          <div>Wanderson, Gu, Cris</div>
        </div>
      </label>

      <label class="group-card">
        <input id="grupoB" type="radio" name="grupo" value="B">
        <div>
          <strong>Grupo B</strong>
          <div>Gu, Emerson, Galeno</div>
        </div>
      </label>
    </div>

    <h3 style="margin-top:14px;">Professores selecionados</h3>
    <p id="listaProfessores" style="margin:6px 0 0;"></p>
  </section>

  <!-- Compras -->
  <section id="compras" class="tabcontent section">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div>
        <h2>Compras</h2>
        <p class="instrucao">Use o botão <strong>+</strong> no canto inferior para adicionar novas compras. Clique em editar no item para alterar.</p>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="button" id="btnCalcularTop"><span class="icon">equal</span> Calcular</button>
        <button class="button danger" id="btnLimparCompras"><span class="icon">delete</span> Limpar compras</button>
      </div>
    </div>

    <div class="table-wrap" style="margin-top:10px;">
      <table id="tabelaCompras">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Valor (R$)</th>
            <th>Comprador</th>
            <th>Consumidores</th>
            <th style="min-width:120px;">Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Saldos (com cards) -->
  <section id="saldos" class="tabcontent section">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div>
        <h2>Saldos & Cards</h2>
        <p class="instrucao">Cards com nome do professor, quanto pagou/deveria e saldo. Abaixo, as compras associadas.</p>
      </div>
      <button class="button primary" id="btnCalcular"><span class="icon">equal</span> Calcular</button>
    </div>

    <div id="resumoTotais" style="margin:8px 0 10px; font-weight:600;"></div>

    <div class="card-grid" id="cardsProfessores"></div>

    <h3 style="margin-top:14px;">Sugestão de acertos</h3>
    <div id="transferencias" class="section" style="padding:10px; background:linear-gradient(180deg,#fafcff,#ffffff); border:1px dashed #e5e7eb;"></div>
  </section>

  <!-- Relatório -->
  <section id="relatorio" class="tabcontent section">
    <h2>Relatório PDF</h2>
    <p class="instrucao">Gere um PDF com as compras, saldos e sugestões de acerto.</p>
    <button class="button primary" id="btnPDF"><span class="icon">picture_as_pdf</span> Gerar Relatório PDF</button>
  </section>
</main>

<!-- FAB -->
<button class="fab" id="fabAdd" title="Adicionar compra">
  <span class="icon">add</span>
</button>

<!-- Modal Compra -->
<div class="modal" id="modalCompra" aria-hidden="true">
  <div class="modal-backdrop" data-close></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-head">
      <div class="modal-title" id="modalTitle">Nova compra</div>
      <button class="button" data-close><span class="icon">close</span></button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div>
          <label>Produto</label>
          <input id="m_produto" type="text" placeholder="Ex: Arroz" />
        </div>
        <div>
          <label>Valor (R$)</label>
          <input id="m_valor" type="number" inputmode="decimal" step="0.01" min="0.01" placeholder="25.50" />
        </div>
      </div>

      <div class="form-grid">
        <div>
          <label>Quem comprou</label>
          <select id="m_comprador"></select>
        </div>
        <div>
          <label>Consumidores (marque pelo menos 1)</label>
          <!-- espaço vazio; abaixo a caixa com checkboxes ocupa toda a largura -->
        </div>
      </div>

      <div class="consumidores-box" id="m_consumidores"></div>
    </div>
    <div class="modal-actions">
      <button class="button" data-close>Cancelar</button>
      <button class="button primary" id="m_salvar"><span class="icon">save</span> Salvar</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

 
<script>
/* ====== <footer class="site-footer">Desenvolvido por <strong>Professor Wanderson</strong></footer> */



Estado e persistência ====== */
const STORAGE_KEY = "divMantimentos_estado_v2";
let state = { professores: [], compras: [], _lastCalc: null };
let editIndex = null; // índice da compra em edição (modal)
let currentTab = 'professores';

window.addEventListener('load', init);

/* ====== Inicialização ====== */
function init(){
  loadState();

  // default grupo
  if(!state.professores || state.professores.length === 0){
    setGrupo('A', false);
    document.getElementById('grupoA').checked = true;
  } else {
    if (arraysEqual(state.professores, ["Wanderson","Gu","Cris"])) document.getElementById('grupoA').checked = true;
    if (arraysEqual(state.professores, ["Gu","Emerson","Galeno"])) document.getElementById('grupoB').checked = true;
  }

  wireUI();
  atualizarUI();
}

/* ====== UI Handlers ====== */
function wireUI(){
  // tabs
  document.querySelectorAll('.tab button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset.target;
      currentTab = target;
      document.querySelectorAll('.tabcontent').forEach(sec=>sec.classList.remove('active'));
      document.getElementById(target).classList.add('active');
    });
  });

  // radio grupos
  document.getElementById('grupoA').addEventListener('change', ()=> onTrocarGrupo('A'));
  document.getElementById('grupoB').addEventListener('change', ()=> onTrocarGrupo('B'));

  // FAB abrir modal
  document.getElementById('fabAdd').addEventListener('click', openModalNova);

  // botões calcular
  document.getElementById('btnCalcular').addEventListener('click', calcular);
  document.getElementById('btnCalcularTop').addEventListener('click', calcular);

  // limpar compras
  document.getElementById('btnLimparCompras').addEventListener('click', limparCompras);

  // PDF
  document.getElementById('btnPDF').addEventListener('click', gerarPDF);

  // Modal: fechar
  document.querySelectorAll('[data-close]').forEach(el=> el.addEventListener('click', closeModal));
  document.getElementById('modalCompra').addEventListener('click', (e)=>{ if(e.target.dataset.close!==undefined) closeModal(); });

  // Modal: salvar
  document.getElementById('m_salvar').addEventListener('click', salvarCompraModal);
}

function onTrocarGrupo(g){
  if(state.compras?.length){
    // modalzinho simples com confirmação elegante
    confirmElegante(
      "Trocar de grupo",
      "Existem compras registradas. Deseja limpar as compras ao mudar de grupo?",
      "Trocar e limpar", "Cancelar"
    ).then(ok=>{
      if(ok){
        state.compras = [];
        setGrupo(g, true);
        showToast("Grupo trocado e compras limpas.");
      } else {
        setGrupo(g, true);
        showToast("Grupo trocado. Compras mantidas.");
      }
      atualizarUI();
      saveState();
    });
  } else {
    setGrupo(g, true);
    atualizarUI();
    saveState();
    showToast(`Grupo ${g} selecionado.`);
  }
}

function setGrupo(grupo, explicito){
  if(grupo === 'A') state.professores = ["Wanderson", "Gu", "Cris"];
  if(grupo === 'B') state.professores = ["Gu", "Emerson", "Galeno"];
  // atualizar selects/checks do modal
  montarFormModal();
}

/* ====== Modal Compra ====== */
function montarFormModal(){
  const buyers = document.getElementById('m_comprador');
  const consumersWrap = document.getElementById('m_consumidores');
  buyers.innerHTML = (state.professores||[]).map(p=>`<option value="${p}">${p}</option>`).join('');
  consumersWrap.innerHTML = (state.professores||[]).map(p=>
    `<label><input type="checkbox" value="${p}"> ${p}</label>`
  ).join('');
}
function openModalNova(){
  editIndex = null;
  document.getElementById('modalTitle').textContent = "Nova compra";
  document.getElementById('m_produto').value = "";
  document.getElementById('m_valor').value = "";
  montarFormModal();
  // marcar todos por padrão
  document.querySelectorAll('#m_consumidores input').forEach(cb=> cb.checked = true);
  openModal();
}
function openModalEditar(index){
  const c = state.compras[index];
  if(!c) return;
  editIndex = index;
  document.getElementById('modalTitle').textContent = "Editar compra";
  document.getElementById('m_produto').value = c.produto;
  document.getElementById('m_valor').value = c.valor;
  montarFormModal();
  // se comprador não estiver no grupo atual (caso troca de grupo), mantém
  if(!state.professores.includes(c.comprador)){
    const opt = document.createElement('option');
    opt.value = c.comprador; opt.textContent = c.comprador;
    document.getElementById('m_comprador').appendChild(opt);
  }
  document.getElementById('m_comprador').value = c.comprador;
  document.querySelectorAll('#m_consumidores input').forEach(cb=> cb.checked = c.consumidores.includes(cb.value));
  openModal();
}
function openModal(){
  document.getElementById('modalCompra').classList.add('open');
  document.getElementById('modalCompra').setAttribute('aria-hidden','false');
}
function closeModal(){
  document.getElementById('modalCompra').classList.remove('open');
  document.getElementById('modalCompra').setAttribute('aria-hidden','true');
}

function salvarCompraModal(){
  const produto = document.getElementById('m_produto').value.trim();
  const valor = parseFloat(document.getElementById('m_valor').value);
  const comprador = document.getElementById('m_comprador').value;
  const consumidores = Array.from(document.querySelectorAll('#m_consumidores input:checked')).map(i=>i.value);

  if(!produto) return showToast("Informe o produto.");
  if(isNaN(valor) || valor<=0) return showToast("Valor inválido.");
  if(!comprador) return showToast("Selecione o comprador.");
  if(consumidores.length===0) return showToast("Marque pelo menos um consumidor.");

  const registro = { produto, valor: Number(valor), comprador, consumidores };
  if(editIndex!==null){
    state.compras[editIndex] = registro;
    showToast("Compra atualizada.");
  } else {
    state.compras.push(registro);
    showToast("Compra registrada.");
  }
  editIndex = null;
  saveState();
  atualizarUI();
  closeModal();
}

/* ====== Compras tabela / ações ====== */
function atualizarTabelaCompras(){
  const tbody = document.querySelector('#tabelaCompras tbody');
  if(!state.compras?.length){
    tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted);">Nenhuma compra ainda. Use o botão “+”.</td></tr>`;
    return;
  }
  tbody.innerHTML = state.compras.map((c,i)=> `
    <tr>
      <td>${escapeHtml(c.produto)}</td>
      <td>${Number(c.valor).toFixed(2)}</td>
      <td>${escapeHtml(c.comprador)}</td>
      <td>${c.consumidores.map(escapeHtml).join(", ")}</td>
      <td style="display:flex; gap:8px;">
        <button class="button" onclick="openModalEditar(${i})"><span class="icon">edit</span>Editar</button>
        <button class="button danger" onclick="excluirCompra(${i})"><span class="icon">delete</span>Apagar</button>
      </td>
    </tr>
  `).join('');
}
function excluirCompra(i){
  confirmElegante("Apagar compra", "Tem certeza que deseja excluir esta compra?", "Apagar", "Cancelar")
  .then(ok=>{
    if(!ok) return;
    state.compras.splice(i,1);
    saveState();
    atualizarUI();
    showToast("Compra removida.");
  });
}
function limparCompras(){
  if(!state.compras?.length){ showToast("Não há compras para limpar."); return; }
  confirmElegante("Limpar todas as compras", "Esta ação não pode ser desfeita.", "Limpar", "Cancelar")
  .then(ok=>{
    if(!ok) return;
    state.compras = [];
    state._lastCalc = null;
    saveState();
    atualizarUI();
    showToast("Compras limpas.");
  });
}

/* ====== Saldos & Cards ====== */
function calcular(){
  if(!state.compras?.length){
    showToast("Adicione ao menos uma compra.");
    return;
  }
  const profs = state.professores.slice();
  const pagou = {}; const deveria = {};
  profs.forEach(p=>{ pagou[p]=0; deveria[p]=0; });

  state.compras.forEach(c=>{
    pagou[c.comprador] = (pagou[c.comprador]||0) + Number(c.valor);
    const parte = Number(c.valor) / c.consumidores.length;
    c.consumidores.forEach(n=> deveria[n] = (deveria[n]||0) + parte);
  });

  const nomes = new Set([...Object.keys(pagou), ...Object.keys(deveria)]);
  const saldos = Array.from(nomes).map(n=>{
    const p = +(pagou[n]||0);
    const d = +(deveria[n]||0);
    return { nome:n, pagou:p, deveria:d, saldo: +(p-d) };
  });

  const totalPago = saldos.reduce((s,x)=>s + x.pagou, 0);
  const totalDevido = saldos.reduce((s,x)=>s + x.deveria, 0);

  // transferências
  const devs = saldos.filter(s=>s.saldo < -0.01).map(s=>({nome:s.nome, saldo:-s.saldo}));
  const creds = saldos.filter(s=>s.saldo > 0.01).map(s=>({nome:s.nome, saldo:s.saldo}));
  devs.sort((a,b)=>b.saldo - a.saldo);
  creds.sort((a,b)=>b.saldo - a.saldo);
  const transf = [];
  let i=0,j=0;
  while(i<devs.length && j<creds.length){
    let val = Math.min(devs[i].saldo, creds[j].saldo);
    val = Math.round(val*100)/100;
    if(val>0.009){
      transf.push({de:devs[i].nome, para:creds[j].nome, valor:val});
      devs[i].saldo = +(devs[i].saldo - val).toFixed(2);
      creds[j].saldo = +(creds[j].saldo - val).toFixed(2);
      if(devs[i].saldo < 0.01) i++;
      if(creds[j].saldo < 0.01) j++;
    } else break;
  }

  state._lastCalc = { saldos, totalPago, totalDevido, transf };
  saveState();
  renderCards();
  renderTransferencias();
  renderResumoTotais();
  showToast("Cálculo concluído.");
}

function renderResumoTotais(){
  const res = document.getElementById('resumoTotais');
  if(!state._lastCalc){ res.textContent = ""; return; }
  const { totalPago, totalDevido } = state._lastCalc;
  res.textContent = `Total pago: R$${totalPago.toFixed(2)} • Total devido: R$${totalDevido.toFixed(2)}`;
}

function renderCards(){
  const wrap = document.getElementById('cardsProfessores');
  const profs = state.professores||[];
  const mapaComprasPorPessoa = {};
  state.compras.forEach((c, idx)=>{
    // compras feitas pelo professor
    (mapaComprasPorPessoa[c.comprador] ||= []).push({ ...c, idx, tipo:'comprou' });
    // e também compras onde ele consumiu (sem duplicar referência)
    c.consumidores.forEach(cons=>{
      (mapaComprasPorPessoa[cons] ||= []).push({ ...c, idx, tipo: cons===c.comprador ? 'comprou/consumiu' : 'consumiu' });
    });
  });

  let saldos = {};
  if(state._lastCalc){
    state._lastCalc.saldos.forEach(s=> saldos[s.nome]=s);
  }

  wrap.innerHTML = profs.map(nome=>{
    const s = saldos[nome] || {pagou:0, deveria:0, saldo:0};
    const badgeClass = s.saldo>=0 ? 'ok' : 'neg';
    const lista = (mapaComprasPorPessoa[nome]||[]).map(item=>{
      const meta = `${item.tipo} • R$${item.valor.toFixed(2)} • ${escapeHtml(item.consumidores.join(", "))}`;
      return `
        <div class="list-item">
          <div class="left">
            <div class="title">${escapeHtml(item.produto)}</div>
            <div class="meta">${meta}</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button class="button" onclick="openModalEditar(${item.idx})" title="Editar"><span class="icon">edit</span></button>
          </div>
        </div>
      `;
    }).join('') || `<div class="list-item"><div class="left"><div class="meta">Sem compras relacionadas.</div></div></div>`;

    const iniciais = nome.slice(0,2).toUpperCase();

    return `
      <div class="prof-card">
        <div class="prof-head">
          <div class="prof-name">
            <div class="avatar">${iniciais}</div>
            <div>${escapeHtml(nome)}</div>
          </div>
          <div class="badge ${badgeClass}">${s.saldo>=0?'+':''}R$${s.saldo.toFixed(2)}</div>
        </div>

        <div class="prof-body">
          <div class="prof-col">
            <div class="prof-label">Pagou</div>
            <div class="prof-amount">R$${s.pagou.toFixed(2)}</div>
          </div>
          <div class="prof-col">
            <div class="prof-label">Deveria</div>
            <div class="prof-amount">R$${s.deveria.toFixed(2)}</div>
          </div>
        </div>

        <div class="prof-col">
          <div class="prof-label">Compras relacionadas</div>
          <div class="card-list">${lista}</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderTransferencias(){
  const el = document.getElementById('transferencias');
  const transf = state._lastCalc?.transf || [];
  el.innerHTML = transf.length
    ? transf.map(t=>`<p><strong>${escapeHtml(t.de)}</strong> paga <strong>R$${t.valor.toFixed(2)}</strong> para <strong>${escapeHtml(t.para)}</strong></p>`).join('')
    : "<p>Ninguém deve nada 🎉</p>";
}

/* ====== Relatório PDF ====== */
function gerarPDF(){
  if(!state.compras?.length){ showToast("Nada para gerar. Adicione compras."); return; }
  if(!state._lastCalc) calcular();

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();

  const hoje = new Date().toLocaleDateString("pt-BR");
  doc.setFontSize(14);
  doc.text("Relatório de Mantimentos", pageWidth/2, 40, {align:'center'});
  doc.setFontSize(10);
  doc.text(`Data: ${hoje}`, 40, 58);
  doc.text(`Grupo: ${state.professores.join(", ")}`, 40, 72);

  const blueHeader = {fillColor:[99,102,241], textColor:255};
  const greenHeader = {fillColor:[16,185,129], textColor:255};
  const orangeHeader = {fillColor:[245,158,11], textColor:255};

  // Compras
  doc.setFontSize(11);
  doc.text("Compras:", 40, 92);
  const comprasHead = [['Produto','Valor (R$)','Comprador','Consumidores']];
  const comprasBody = state.compras.map(c=>[c.produto, c.valor.toFixed(2), c.comprador, c.consumidores.join(", ")]);
  doc.autoTable({ startY: 100, head: comprasHead, body: comprasBody, styles:{fontSize:10}, headStyles: blueHeader, margin:{left:40,right:40} });

  // Saldos
  let y = doc.lastAutoTable ? doc.lastAutoTable.finalY + 18 : 160;
  const saldos = state._lastCalc?.saldos || [];
  doc.text("Saldos:", 40, y);
  const saldosHead = [['Nome','Pagou (R$)','Deveria (R$)','Saldo (R$)']];
  const saldosBody = saldos.map(s=>[s.nome, s.pagou.toFixed(2), s.deveria.toFixed(2), s.saldo.toFixed(2)]);
  doc.autoTable({ startY: y+8, head: saldosHead, body: saldosBody, styles:{fontSize:10}, headStyles: greenHeader, margin:{left:40,right:40} });

  // Totais & transferências
  y = doc.lastAutoTable ? doc.lastAutoTable.finalY + 18 : 400;
  const totalPago = state._lastCalc?.totalPago || 0;
  const totalDevido = state._lastCalc?.totalDevido || 0;
  doc.text(`Total pago: R$${totalPago.toFixed(2)}    Total devido: R$${totalDevido.toFixed(2)}`, 40, y);

  y += 18;
  doc.text("Sugestão de acertos:", 40, y);
  y += 8;
  const transf = state._lastCalc?.transf || [];
  if(transf.length){
    const tBody = transf.map(t=>[t.de + " → " + t.para, "R$" + t.valor.toFixed(2)]);
    doc.autoTable({ startY: y, head: [['Transação','Valor']], body: tBody, styles:{fontSize:10}, headStyles: orangeHeader, margin:{left:40,right:40} });
  } else {
    doc.text("Nenhuma transferência necessária.", 40, y+6);
  }

  // rodapé
  const pageCount = doc.internal.getNumberOfPages();
  doc.setFontSize(9);
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i);
    doc.setTextColor(100);
    doc.text("Desenvolvido por Professor Wanderson", pageWidth - 40, pageHeight - 20, {align:'right'});
  }

  doc.save("relatorio_mantimentos.pdf");
  showToast("PDF gerado.");
}

/* ====== Atualização geral de UI ====== */
function atualizarUI(){
  // lista professores (texto)
  const lista = document.getElementById('listaProfessores');
  const profs = state.professores||[];
  lista.textContent = profs.length ? profs.join(" • ") : "Nenhum selecionado";

  // tabela compras
  atualizarTabelaCompras();

  // se houver cálculo, atualiza cards/transfer
  if(state._lastCalc){
    renderCards();
    renderTransferencias();
    renderResumoTotais();
  } else {
    // monta cards vazios baseados nos professores
    document.getElementById('cardsProfessores').innerHTML = (profs||[]).map(nome=>`
      <div class="prof-card">
        <div class="prof-head">
          <div class="prof-name">
            <div class="avatar">${nome.slice(0,2).toUpperCase()}</div>
            <div>${escapeHtml(nome)}</div>
          </div>
          <div class="badge">R$0,00</div>
        </div>
        <div class="prof-body">
          <div class="prof-col">
            <div class="prof-label">Pagou</div>
            <div class="prof-amount">R$0,00</div>
          </div>
          <div class="prof-col">
            <div class="prof-label">Deveria</div>
            <div class="prof-amount">R$0,00</div>
          </div>
        </div>
        <div class="prof-col">
          <div class="prof-label">Compras relacionadas</div>
          <div class="card-list"><div class="list-item"><div class="left"><div class="meta">Sem compras relacionadas.</div></div></div></div>
        </div>
      </div>
    `).join('');
    document.getElementById('transferencias').innerHTML = "<p>Calcule para ver as sugestões de acerto.</p>";
    document.getElementById('resumoTotais').textContent = "";
  }
}

/* ====== Utilitários ====== */
function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){} }
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      state = JSON.parse(raw);
      state.professores ||= [];
      state.compras ||= [];
    }
  }catch(e){}
}
function showToast(msg, time=2000){
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(el._t); el._t = setTimeout(()=> el.classList.remove('show'), time);
}
function escapeHtml(text){
  if(text===undefined||text===null) return "";
  return String(text).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
function arraysEqual(a,b){
  if(!a||!b||a.length!==b.length) return false;
  for(let i=0;i<a.length;i++) if(a[i]!==b[i]) return false;
  return true;
}

/* Pequeno modal de confirmação elegante (resolve boolean) */
function confirmElegante(titulo, mensagem, okText="OK", cancelText="Cancelar"){
  return new Promise(resolve=>{
    const root = document.createElement('div');
    root.innerHTML = `
      <div class="modal open" style="z-index:1100;">
        <div class="modal-backdrop" data-x></div>
        <div class="modal-card" role="dialog" aria-modal="true" style="max-width:480px;">
          <div class="modal-head">
            <div class="modal-title">${escapeHtml(titulo)}</div>
            <button class="button" data-x><span class="icon">close</span></button>
          </div>
          <div class="modal-body">
            <p style="margin:0; color:var(--muted);">${escapeHtml(mensagem)}</p>
          </div>
          <div class="modal-actions">
            <button class="button" data-x>${escapeHtml(cancelText)}</button>
            <button class="button primary" data-ok><span class="icon">check</span> ${escapeHtml(okText)}</button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(root);
    const close = (val)=>{ root.remove(); resolve(val); };
    root.querySelectorAll('[data-x]').forEach(n=> n.addEventListener('click', ()=> close(false)));
    root.querySelector('[data-ok]').addEventListener('click', ()=> close(true));
  });
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Divisão de Mantimentos — Relatório PNG</title>

<!-- Tipografia + ícones -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,500,0,0"/>

<!-- html2canvas (PNG) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{
  --bg:#f6f8fb; --card:#fff; --text:#273143; --muted:#6b7280;
  --accent:#4f46e5; --ok:#16a34a; --warn:#ef4444; --radius:14px;
  --shadow:0 8px 24px rgba(17,24,39,.08); --t:220ms cubic-bezier(.2,.8,.2,1);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:
   radial-gradient(1200px 600px at 10% -10%, rgba(167,243,208,.25), transparent 60%),
   radial-gradient(1000px 500px at 110% 0%, rgba(125,211,252,.30), transparent 60%),
   var(--bg);
  color:var(--text);
  font:400 15px/1.5 'Poppins','Roboto',system-ui,-apple-system,Segoe UI,Arial,sans-serif;
}
header{
  position:sticky; top:0; z-index:10; color:#fff;
  padding:16px clamp(12px,3vw,24px);
  background:linear-gradient(135deg, rgba(79,70,229,.95), rgba(14,165,233,.95));
  box-shadow:var(--shadow)
}
.header-wrap{max-width:1100px; margin:auto; display:flex; align-items:center; gap:12px}
.header-icon{width:40px; height:40px; display:grid; place-items:center; border-radius:12px; background:linear-gradient(135deg, rgba(255,255,255,.3), rgba(255,255,255,.1))}
header h1{margin:0; font-weight:600; font-size:clamp(18px,2.6vw,22px)}

main{max-width:1100px; margin:18px auto 90px; padding:0 clamp(10px,3vw,18px)}

.tab{display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px}
.tab button{
  appearance:none; border:none; cursor:pointer; padding:10px 14px; border-radius:999px;
  background:linear-gradient(135deg,#eef2ff,#ecfeff); font-weight:600; color:#334155;
  transition:transform var(--t), box-shadow var(--t), background var(--t)
}
.tab button:hover{transform:translateY(-1px)}
.tab button.active{background:linear-gradient(135deg,#c7d2fe,#a7f3d0); box-shadow:var(--shadow); color:#111827}
.tabcontent{display:none}
.tabcontent.active{display:block}
.section{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
h2{font-size:1rem; margin:0 0 8px; font-weight:600}
h3{font-size:.95rem; margin:12px 0 8px; font-weight:600}
p.instrucao{margin:8px 0 12px; padding:10px 12px; border-radius:10px; background:linear-gradient(135deg,#f8fafc,#f1f5f9); color:var(--muted); border:1px solid #e5e7eb}

/* grupo */
.group-grid{display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
.group-card{display:flex; gap:12px; align-items:center; background:linear-gradient(135deg,#fff,#fbfdff); border:1px solid #eef2f7; padding:12px; border-radius:var(--radius); transition:transform var(--t), box-shadow var(--t), border-color var(--t)}
.group-card:hover{transform:translateY(-2px); box-shadow:var(--shadow); border-color:#e5e7eb}
.group-card input{accent-color:var(--accent); width:18px; height:18px}

/* tabela compras */
.table-wrap{background:var(--card); border:1px solid #eef2f7; border-radius:var(--radius); box-shadow:var(--shadow); overflow:auto}
table{width:100%; border-collapse:collapse; font-size:.9rem}
th,td{padding:10px 12px; border-bottom:1px solid #eef2f7; text-align:left}
th{background:linear-gradient(180deg,#fafcff,#f6f8fb); position:sticky; top:0}

.button{
  appearance:none; border:none; cursor:pointer; padding:10px 12px; border-radius:10px;
  font-weight:600; display:inline-flex; align-items:center; gap:8px;
  background:linear-gradient(135deg,#eef2ff,#ecfeff);
  transition:transform var(--t), box-shadow var(--t)
}
.button:hover{transform:translateY(-1px); box-shadow:var(--shadow)}
.button.primary{background:linear-gradient(135deg,#c7d2fe,#a7f3d0)}
.button.danger{background:linear-gradient(135deg,#fee2e2,#fff1f2); color:#b91c1c}
.icon{font-family:'Material Symbols Rounded'; font-size:20px; line-height:0}

/* FAB */
.fab{position:fixed; right:18px; bottom:76px; width:56px; height:56px; border-radius:50%; display:grid; place-items:center; border:none; cursor:pointer; color:#fff; background:linear-gradient(135deg,#4f46e5,#06b6d4); box-shadow:0 10px 28px rgba(79,70,229,.35); transition:transform var(--t), box-shadow var(--t); z-index:50}
.fab:hover{transform:translateY(-2px) scale(1.02); box-shadow:0 12px 32px rgba(79,70,229,.45)}

/* modal */
.modal{position:fixed; inset:0; display:none; place-items:center; z-index:1000}
.modal.open{display:grid}
.modal-backdrop{position:absolute; inset:0; background:rgba(15,23,42,.45); backdrop-filter:blur(3px); animation:fade .22s ease-out}
@keyframes fade{from{opacity:0} to{opacity:1}}
.modal-card{position:relative; width:min(640px,94vw); background:#fff; border-radius:16px; box-shadow:var(--shadow); overflow:hidden; transform:translateY(6px); animation:rise var(--t) forwards}
@keyframes rise{to{transform:translateY(0)}}
.modal-head{padding:14px 16px; background:linear-gradient(135deg,#eef2ff,#ecfeff); border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between}
.modal-body{padding:14px 16px; display:grid; gap:12px}
.modal-actions{padding:12px 16px; display:flex; justify-content:flex-end; gap:10px; border-top:1px solid #e5e7eb; background:#fbfdff}
.form-grid{display:grid; gap:10px; grid-template-columns:1fr 1fr}
.form-grid label{font-size:.85rem; color:var(--muted)}
.form-grid input, .form-grid select{
  width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; outline:none;
}
.consumidores-box{max-height:160px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px; padding:8px; background:#fff}
.consumidores-box label{display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px}
.consumidores-box label:hover{background:#f8fafc}
.consumidores-box input{accent-color:var(--accent)}

/* toast */
.toast{position:fixed; right:18px; bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:var(--shadow); opacity:0; transform:translateY(8px); pointer-events:none; transition:opacity var(--t), transform var(--t); z-index:60}
.toast.show{opacity:1; transform:translateY(0)}

/* footer */
.site-footer{position:fixed; left:0; right:0; bottom:0; height:50px; background:#0b1220; color:#e5e7eb; display:flex; align-items:center; justify-content:center; font-size:.9rem; z-index:30; box-shadow:0 -6px 20px rgba(2,6,23,.25)}

/* minimal scrollbars */
*{scrollbar-width:thin; scrollbar-color:#d1d5db transparent}
*::-webkit-scrollbar{width:10px; height:10px}
*::-webkit-scrollbar-thumb{background:#d1d5db; border-radius:999px; border:3px solid transparent; background-clip:padding-box}

/* ============================ */
/* ESTILO DO RELATÓRIO (preview/export) */
/* ============================ */
.report-root{
  font-family:'Roboto',system-ui,-apple-system,Segoe UI,Arial,sans-serif;
  background:#fff; color:#111827;
  max-width:980px; margin:12px auto; padding:20px;
  border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.08)
}
.report-title{font-size:20px; font-weight:600; margin:0 0 6px}
.report-generated{font-size:13px; color:#525252; margin:0 0 12px}
.report-h2{font-size:18px; font-weight:700; margin:16px 0 10px}
.report-badges{display:flex; gap:10px; flex-wrap:wrap}
.report-badge{
  min-width:150px; background:#f6f7f9; padding:12px; border-radius:10px;
  font-weight:700; display:flex; flex-direction:column; gap:6px
}
.report-badge .val{font-weight:700}
.val.pos{color:#16a34a}
.val.neg{color:#ef4444}
.val.zero{color:#111827}

.report-table{width:100%; border-collapse:collapse; margin-top:6px}
.report-table th, .report-table td{padding:10px 12px; border-bottom:1px solid #e5e7eb; text-align:left; font-size:14px}
.report-table th{background:#f3f4f6; font-weight:600}

@media (max-width:560px){ .form-grid{grid-template-columns:1fr} }
</style>
</head>
<body>

<header>
  <div class="header-wrap">
    <div class="header-icon"><span class="icon">shelves</span></div>
    <h1>Divisão de Mantimentos</h1>
  </div>
</header>

<main>
  <!-- Abas -->
  <div class="tab">
    <button class="tablinks active" data-target="professores">Professores</button>
    <button class="tablinks" data-target="compras">Compras</button>
    <button class="tablinks" data-target="saldos">Saldos</button>
    <button class="tablinks" data-target="relatorio">Relatório</button>
  </div>

  <!-- Professores -->
  <section id="professores" class="tabcontent active section">
    <h2>Escolher Grupo</h2>
    <p class="instrucao">Selecione um grupo. Os professores serão usados no cálculo.</p>
    <div class="group-grid">
      <label class="group-card">
        <input id="grupoA" type="radio" name="grupo" value="A">
        <div><strong>Grupo A</strong><div>Wanderson, Gu, Cris</div></div>
      </label>
      <label class="group-card">
        <input id="grupoB" type="radio" name="grupo" value="B">
        <div><strong>Grupo B</strong><div>Gu, Emerson, Galeno</div></div>
      </label>
    </div>
    <h3 style="margin-top:12px">Professores selecionados</h3>
    <p id="listaProfessores" style="margin:6px 0 0;"></p>
  </section>

  <!-- Compras -->
  <section id="compras" class="tabcontent section">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px">
      <div>
        <h2>Compras</h2>
        <p class="instrucao">Use o botão <strong>+</strong> para adicionar compras. Clique em editar para alterar.</p>
      </div>
      <div style="display:flex; gap:8px">
        <button class="button" id="btnCalcularTop"><span class="icon">equal</span> Calcular</button>
        <button class="button danger" id="btnLimparCompras"><span class="icon">delete</span> Limpar compras</button>
      </div>
    </div>

    <div class="table-wrap" style="margin-top:10px">
      <table id="tabelaCompras">
        <thead>
          <tr>
            <th>Data</th>
            <th>Produto</th>
            <th>Valor (R$)</th>
            <th>Comprador</th>
            <th>Consumidores</th>
            <th style="min-width:120px">Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Saldos (resumo) -->
  <section id="saldos" class="tabcontent section">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px">
      <div>
        <h2>Saldos</h2>
        <p class="instrucao">Calcule para atualizar os saldos e sugestões de acerto.</p>
      </div>
      <button class="button primary" id="btnCalcular"><span class="icon">equal</span> Calcular</button>
    </div>

    <div id="resumoTotais" style="margin:8px 0 10px; font-weight:600;"></div>

    <h3>Sugestão de acerto</h3>
    <div id="transferencias" class="section" style="padding:10px; background:linear-gradient(180deg,#fafcff,#ffffff); border:1px dashed #e5e7eb;"></div>
  </section>

  <!-- Relatório -->
  <section id="relatorio" class="tabcontent section">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px">
      <div>
        <h2>Relatório (PNG)</h2>
        <p class="instrucao">Gera a visualização igual à imagem enviada e exporta em PNG.</p>
      </div>
      <button class="button primary" id="btnExportPNG"><span class="icon">image</span> Exportar PNG</button>
    </div>

    <!-- Preview/área a capturar -->
    <div id="reportRoot" class="report-root" aria-label="Relatório para exportação"></div>
  </section>
</main>

<!-- FAB -->
<button class="fab" id="fabAdd" title="Adicionar compra"><span class="icon">add</span></button>

<!-- Modal Compra -->
<div class="modal" id="modalCompra" aria-hidden="true">
  <div class="modal-backdrop" data-close></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-head">
      <div class="modal-title" id="modalTitle">Nova compra</div>
      <button class="button" data-close><span class="icon">close</span></button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div>
          <label>Produto</label>
          <input id="m_produto" type="text" placeholder="Ex: Arroz"/>
        </div>
        <div>
          <label>Valor (R$)</label>
          <input id="m_valor" type="number" inputmode="decimal" step="0.01" min="0.01" placeholder="25.50"/>
        </div>
      </div>
      <div class="form-grid">
        <div>
          <label>Data</label>
          <input id="m_data" type="date"/>
        </div>
        <div>
          <label>Quem comprou</label>
          <select id="m_comprador"></select>
        </div>
      </div>
      <div>
        <label>Consumidores (marque pelo menos 1)</label>
        <div class="consumidores-box" id="m_consumidores"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="button" data-close>Cancelar</button>
      <button class="button primary" id="m_salvar"><span class="icon">save</span> Salvar</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>
<footer class="site-footer">Desenvolvido por <strong>Professor Wanderson</strong></footer>

<script>
/* ===== Estado ===== */
const STORAGE_KEY = "divMantimentos_png_relatorio_v2";
let state = { professores: [], compras: [], _lastCalc: null };
let editIndex = null;

window.addEventListener('load', init);

function init(){
  loadState();

  // grupo padrão
  if(!state.professores.length){
    setGrupo('A');
    document.getElementById('grupoA').checked = true;
  }else{
    if(arraysEqual(state.professores, ["Wanderson","Gu","Cris"])) document.getElementById('grupoA').checked = true;
    if(arraysEqual(state.professores, ["Gu","Emerson","Galeno"])) document.getElementById('grupoB').checked = true;
  }

  wireUI();
  atualizarUI();
}

/* ===== UI ===== */
function wireUI(){
  // abas
  document.querySelectorAll('.tab button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const t = btn.dataset.target;
      document.querySelectorAll('.tabcontent').forEach(s=>s.classList.remove('active'));
      document.getElementById(t).classList.add('active');
      if(t==='relatorio') renderReport(); // atualiza preview
    });
  });

  // grupo
  document.getElementById('grupoA').addEventListener('change', ()=> trocarGrupo('A'));
  document.getElementById('grupoB').addEventListener('change', ()=> trocarGrupo('B'));

  // FAB
  document.getElementById('fabAdd').addEventListener('click', openModalNova);

  // calcular
  document.getElementById('btnCalcular').addEventListener('click', calcular);
  document.getElementById('btnCalcularTop').addEventListener('click', calcular);

  // limpar compras
  document.getElementById('btnLimparCompras').addEventListener('click', limparCompras);

  // modal
  document.querySelectorAll('[data-close]').forEach(el=> el.addEventListener('click', closeModal));
  document.getElementById('modalCompra').addEventListener('click', e=>{ if(e.target.dataset.close!==undefined) closeModal(); });
  document.getElementById('m_salvar').addEventListener('click', salvarCompraModal);

  // export PNG
  document.getElementById('btnExportPNG').addEventListener('click', exportPNG);
}

function trocarGrupo(g){
  if(state.compras.length){
    confirmElegante("Trocar de grupo","Existem compras registradas. Deseja limpar as compras ao mudar de grupo?","Trocar e limpar","Cancelar")
    .then(ok=>{
      if(ok){ state.compras=[]; state._lastCalc=null; showToast("Compras limpas.") }
      setGrupo(g); saveState(); atualizarUI();
    });
  }else{
    setGrupo(g); saveState(); atualizarUI();
  }
}

function setGrupo(g){
  state.professores = (g==='A') ? ["Wanderson","Gu","Cris"] : ["Gu","Emerson","Galeno"];
  montarFormModal();
}

/* ===== Modal Compra ===== */
function montarFormModal(){
  const buyers = document.getElementById('m_comprador');
  const consumersWrap = document.getElementById('m_consumidores');
  buyers.innerHTML = state.professores.map(p=>`<option value="${p}">${p}</option>`).join('');
  consumersWrap.innerHTML = state.professores.map(p=>`<label><input type="checkbox" value="${p}"> ${p}</label>`).join('');
}
function today(){ const d=new Date(); return d.toISOString().slice(0,10); }
function openModalNova(){
  editIndex = null;
  document.getElementById('modalTitle').textContent = "Nova compra";
  document.getElementById('m_produto').value = "";
  document.getElementById('m_valor').value = "";
  document.getElementById('m_data').value = today();
  montarFormModal();
  document.querySelectorAll('#m_consumidores input').forEach(cb=> cb.checked = true);
  openModal();
}
function openModalEditar(index){
  const c = state.compras[index]; if(!c) return;
  editIndex = index;
  document.getElementById('modalTitle').textContent = "Editar compra";
  document.getElementById('m_produto').value = c.produto;
  document.getElementById('m_valor').value = c.valor;
  document.getElementById('m_data').value = c.data || today();
  montarFormModal();
  if(!state.professores.includes(c.comprador)){
    const opt = document.createElement('option'); opt.value=c.comprador; opt.textContent=c.comprador;
    document.getElementById('m_comprador').appendChild(opt);
  }
  document.getElementById('m_comprador').value = c.comprador;
  document.querySelectorAll('#m_consumidores input').forEach(cb=> cb.checked = (c.consumidores||[]).includes(cb.value));
  openModal();
}
function openModal(){
  document.getElementById('modalCompra').classList.add('open');
  document.getElementById('modalCompra').setAttribute('aria-hidden','false');
}
function closeModal(){
  document.getElementById('modalCompra').classList.remove('open');
  document.getElementById('modalCompra').setAttribute('aria-hidden','true');
}
function salvarCompraModal(){
  const produto = document.getElementById('m_produto').value.trim();
  const valor = parseFloat(document.getElementById('m_valor').value);
  const data = document.getElementById('m_data').value || today();
  const comprador = document.getElementById('m_comprador').value;
  const consumidores = Array.from(document.querySelectorAll('#m_consumidores input:checked')).map(i=>i.value);

  if(!produto) return showToast("Informe o produto.");
  if(isNaN(valor) || valor<=0) return showToast("Valor inválido.");
  if(!comprador) return showToast("Selecione o comprador.");
  if(consumidores.length===0) return showToast("Selecione consumidores.");

  const registro = { produto, valor:Number(valor), comprador, consumidores, data };
  if(editIndex!==null){ state.compras[editIndex]=registro; showToast("Compra atualizada."); }
  else { state.compras.push(registro); showToast("Compra registrada."); }

  editIndex=null; saveState(); atualizarUI(); closeModal();
}

/* ===== Tabela Compras ===== */
function atualizarTabelaCompras(){
  const tbody = document.querySelector('#tabelaCompras tbody');
  if(!state.compras.length){
    tbody.innerHTML = `<tr><td colspan="6" style="color:var(--muted)">Nenhuma compra ainda. Use o botão “+”.</td></tr>`;
    return;
  }
  tbody.innerHTML = state.compras.map((c,i)=>`
    <tr>
      <td>${escapeHtml(c.data||'')}</td>
      <td>${escapeHtml(c.produto)}</td>
      <td>${Number(c.valor).toFixed(2)}</td>
      <td>${escapeHtml(c.comprador)}</td>
      <td>${c.consumidores.map(escapeHtml).join(', ')}</td>
      <td style="display:flex; gap:8px">
        <button class="button" onclick="openModalEditar(${i})"><span class="icon">edit</span>Editar</button>
        <button class="button danger" onclick="excluirCompra(${i})"><span class="icon">delete</span>Apagar</button>
      </td>
    </tr>`).join('');
}
function excluirCompra(i){
  confirmElegante("Apagar compra","Tem certeza que deseja excluir esta compra?","Apagar","Cancelar")
  .then(ok=>{
    if(!ok) return;
    state.compras.splice(i,1); saveState(); atualizarUI(); showToast("Compra removida.");
  });
}
function limparCompras(){
  if(!state.compras.length) return showToast("Não há compras para limpar.");
  confirmElegante("Limpar compras","Esta ação não pode ser desfeita.","Limpar","Cancelar")
  .then(ok=>{
    if(!ok) return;
    state.compras=[]; state._lastCalc=null; saveState(); atualizarUI(); showToast("Compras limpas.");
  });
}

/* ===== Cálculo, saldos e acertos ===== */
function calcular(){
  if(!state.compras.length){ showToast("Adicione ao menos uma compra."); return; }

  const profs = state.professores.slice();
  const pagou = {}; const deveria = {};
  profs.forEach(p=>{ pagou[p]=0; deveria[p]=0; });

  state.compras.forEach(c=>{
    pagou[c.comprador] = (pagou[c.comprador]||0) + Number(c.valor);
    const parte = Number(c.valor) / c.consumidores.length;
    c.consumidores.forEach(n=> deveria[n] = (deveria[n]||0) + parte);
  });

  const nomes = new Set([...Object.keys(pagou), ...Object.keys(deveria)]);
  const saldosArr = Array.from(nomes).map(n=>{
    const p=+(pagou[n]||0), d=+(deveria[n]||0);
    return { nome:n, pagou:p, deveria:d, saldo: +(p-d) };
  });

  const totalPago = saldosArr.reduce((s,x)=>s+x.pagou,0);
  const totalDevido = saldosArr.reduce((s,x)=>s+x.deveria,0);

  state._lastCalc = { saldos: saldosArr, totalPago, totalDevido, transf: calcularAcertosInterno(saldosArr) };
  saveState();

  // Resumos
  document.getElementById('resumoTotais').textContent = `Total pago: R$${totalPago.toFixed(2)} • Total devido: R$${totalDevido.toFixed(2)}`;
  renderTransferencias();
  renderReport(); // atualiza preview
  showToast("Cálculo concluído.");
}

function calcularAcertosInterno(saldosArr){
  const devedores = saldosArr.filter(s=>s.saldo<-0.01).map(s=>({nome:s.nome, valor:-s.saldo}));
  const credores  = saldosArr.filter(s=>s.saldo>0.01).map(s=>({nome:s.nome, valor:s.saldo}));
  devedores.sort((a,b)=>b.valor-a.valor); credores.sort((a,b)=>b.valor-a.valor);

  const res=[]; let i=0,j=0;
  while(i<devedores.length && j<credores.length){
    let val=Math.min(devedores[i].valor, credores[j].valor);
    val=Math.round(val*100)/100;
    if(val>0.009){
      res.push({de:devedores[i].nome, para:credores[j].nome, valor:val});
      devedores[i].valor=+(devedores[i].valor-val).toFixed(2);
      credores[j].valor=+(credores[j].valor-val).toFixed(2);
      if(devedores[i].valor<0.01) i++;
      if(credores[j].valor<0.01) j++;
    }else break;
  }
  return res;
}

function renderTransferencias(){
  const el = document.getElementById('transferencias');
  const transf = state._lastCalc?.transf || [];
  el.innerHTML = transf.length
    ? transf.map(t=>`<p><strong>${escapeHtml(t.de)}</strong> → <strong>${escapeHtml(t.para)}</strong> <b>R$ ${t.valor.toFixed(2)}</b></p>`).join('')
    : "<p>Ninguém deve nada 🎉</p>";
}

/* ===== Relatório (preview + export) ===== */
function renderReport(){
  const root = document.getElementById('reportRoot');
  const now = new Date().toLocaleString('pt-BR');
  const profs = state.professores || [];
  const saldosArr = state._lastCalc?.saldos || profs.map(n=>({nome:n, pagou:0, deveria:0, saldo:0}));
  const transf = state._lastCalc?.transf || [];
  const compras = state.compras || [];

  // HEADER
  let html = `
    <div class="report-title">Divisão de Despesas — Casa dos Professores</div>
    <p class="report-generated">Gerado em: ${escapeHtml(now)}</p>
    <div class="report-h2">Saldos</div>
    <div class="report-badges">
  `;

  // BADGES (seguir ordem dos professores)
  const mapS = Object.fromEntries(saldosArr.map(s=>[s.nome,s]));
  profs.forEach(nome=>{
    const s = mapS[nome] || {saldo:0};
    const cls = s.saldo>0?'pos':(s.saldo<0?'neg':'zero');
    const val = (s.saldo<0?'-':'') + 'R$ ' + Math.abs(s.saldo).toFixed(2);
    html += `<div class="report-badge"><div>${escapeHtml(nome)}</div><div class="val ${cls}">${val}</div></div>`;
  });
  html += `</div>`;

  // TABELA DE DESPESAS
  html += `
    <div class="report-h2">Histórico de despesas</div>
    <table class="report-table">
      <thead><tr>
        <th>Data</th><th>Descrição</th><th>Pago por</th><th>Valor</th><th>Participantes</th><th>Valor/pessoa</th>
      </tr></thead>
      <tbody>
  `;
  compras.forEach(c=>{
    const valorPessoa = Number(c.valor) / c.consumidores.length;
    html += `
      <tr>
        <td>${escapeHtml(c.data||'')}</td>
        <td>${escapeHtml(c.produto)}</td>
        <td>${escapeHtml(c.comprador)}</td>
        <td>R$ ${Number(c.valor).toFixed(2)}</td>
        <td>${c.consumidores.map(escapeHtml).join(', ')}</td>
        <td>R$ ${valorPessoa.toFixed(2)}</td>
      </tr>`;
  });
  html += `</tbody></table>`;

  // SUGESTÃO DE ACERTO
  html += `<div class="report-h2">Sugestão de acerto</div>`;
  if(transf.length){
    transf.forEach(t=>{
      html += `<p>${escapeHtml(t.de)} → ${escapeHtml(t.para)} <b>R$ ${t.valor.toFixed(2)}</b></p>`;
    });
  }else{
    html += `<p>Ninguém deve nada 🎉</p>`;
  }

  root.innerHTML = html;
}

async function exportPNG(){
  if(!state.compras.length){ showToast("Nada para exportar. Adicione compras e calcule."); return; }
  if(!state._lastCalc) calcular();
  renderReport();

  const area = document.getElementById('reportRoot');
  const canvas = await html2canvas(area, {backgroundColor:'#ffffff', scale:2, useCORS:true});
  const link=document.createElement('a');
  link.download='relatorio_mantimentos.png';
  link.href=canvas.toDataURL('image/png');
  link.click();
  showToast("PNG exportado.");
}

/* ===== Atualização geral ===== */
function atualizarUI(){
  // lista de professores
  document.getElementById('listaProfessores').textContent = state.professores.length ? state.professores.join(' • ') : 'Nenhum';
  atualizarTabelaCompras();
  if(state._lastCalc){
    document.getElementById('resumoTotais').textContent = `Total pago: R$${state._lastCalc.totalPago.toFixed(2)} • Total devido: R$${state._lastCalc.totalDevido.toFixed(2)}`;
    renderTransferencias();
  }else{
    document.getElementById('resumoTotais').textContent = '';
    document.getElementById('transferencias').innerHTML = '<p>Calcule para ver as sugestões de acerto.</p>';
  }
  // preview do relatório
  if(document.getElementById('relatorio').classList.contains('active')) renderReport();
}

/* ===== Utils ===== */
function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){} }
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){ state = JSON.parse(raw); state.professores ||= []; state.compras ||= []; }
  }catch(e){}
}
function arraysEqual(a,b){ if(!a||!b||a.length!==b.length) return false; for(let i=0;i<a.length;i++) if(a[i]!==b[i]) return false; return true; }
function escapeHtml(t){ if(t===undefined||t===null) return ""; return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
function showToast(msg,time=2000){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); clearTimeout(el._t); el._t=setTimeout(()=>el.classList.remove('show'), time); }

/* Modal de confirmação */
function confirmElegante(titulo, mensagem, okText="OK", cancelText="Cancelar"){
  return new Promise(resolve=>{
    const root=document.createElement('div');
    root.innerHTML=`
      <div class="modal open" style="z-index:1100;">
        <div class="modal-backdrop" data-x></div>
        <div class="modal-card" role="dialog" aria-modal="true" style="max-width:480px;">
          <div class="modal-head">
            <div class="modal-title">${escapeHtml(titulo)}</div>
            <button class="button" data-x><span class="icon">close</span></button>
          </div>
          <div class="modal-body"><p style="margin:0; color:var(--muted)">${escapeHtml(mensagem)}</p></div>
          <div class="modal-actions">
            <button class="button" data-x>${escapeHtml(cancelText)}</button>
            <button class="button primary" data-ok><span class="icon">check</span> ${escapeHtml(okText)}</button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(root);
    const close=v=>{ root.remove(); resolve(v); };
    root.querySelectorAll('[data-x]').forEach(n=> n.addEventListener('click', ()=>close(false)));
    root.querySelector('[data-ok]').addEventListener('click', ()=>close(true));
  });
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Divis√£o de Mantimentos</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: 'Roboto', sans-serif; background: #f0f2f5; margin:0; padding:0; font-size:14px; }
header { text-align:center; padding:15px; background:#4CAF50; color:white; font-size:1.4em; }
main { max-width: 500px; margin: 10px auto; background:#fff; border-radius:8px; box-shadow:0 3px 8px rgba(0,0,0,0.1); padding:10px; }
.tab { display:flex; flex-wrap: wrap; margin-bottom:5px; }
.tab button { flex:1; padding:10px; font-size:1em; cursor:pointer; background:#eee; border:none; font-weight:600; transition:.3s; border-radius:5px 5px 0 0; margin-right:2px; }
.tab button.active { background:#4CAF50; color:white; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
.tabcontent { display:none; padding:10px; }
label { display:block; margin:5px 0 3px; font-weight:500; }
input, select, button { padding:6px 8px; margin-top:3px; font-size:0.9em; border-radius:5px; border:1px solid #ccc; }
button:hover { opacity:.9; }
.btn { font-size:0.7em; padding:3px 6px; margin-right:2px; border:none; border-radius:4px; }
.btn-editar { background:#ffb74d; color:#fff; }
.btn-excluir { background:#e57373; color:#fff; }
.btn-gerar { background:#2196F3; color:white; margin-top:5px; padding:6px 10px; font-size:0.9em; }
ul { list-style:none; padding-left:0; margin:0; }
li { margin-bottom:5px; }
.saldo-positivo { color:green; font-weight:bold; }
.saldo-negativo { color:red; font-weight:bold; }
table { width:100%; border-collapse: collapse; font-size:0.8em; }
table th, table td { border:1px solid #ccc; padding:4px; text-align:left; }
table th { background:#eee; }
h2,h3 { font-size:1em; margin:5px 0; }
#consumidores { max-height:120px; overflow-y:auto; border:1px solid #ccc; padding:5px; border-radius:5px; }
.instrucao { font-size:0.85em; color:#555; margin:5px 0; padding:6px; background:#f9f9f9; border-left:3px solid #4CAF50; border-radius:4px; }
</style>
</head>
<body>
<header>Divis√£o de Mantimentos</header>
<main>

  <div class="tab">
    <button class="tablinks active" onclick="openTab(event,'professores')">Professores</button>
    <button class="tablinks" onclick="openTab(event,'compras')">Compras</button>
    <button class="tablinks" onclick="openTab(event,'saldos')">Saldos</button>
    <button class="tablinks" onclick="openTab(event,'relatorio')">Relat√≥rio</button>
  </div>

  <!-- Aba Professores -->
  <div id="professores" class="tabcontent" style="display:block;">
    <h2>Escolher Grupo</h2>
    <p class="instrucao">Escolha um grupo para come√ßar. Os professores do grupo ser√£o usados em todas as divis√µes.</p>
    <label>
      <input type="radio" name="grupo" value="A" onclick="selecionarGrupo('A')"> Grupo A (Wanderson, Gu, Cris)
    </label><br>
    <label>
      <input type="radio" name="grupo" value="B" onclick="selecionarGrupo('B')"> Grupo B (Gu, Emerson, Galeno)
    </label>
    
    <h3>Professores selecionados:</h3>
    <ul id="listaProfessores"></ul>
  </div>

  <!-- Aba Compras -->
  <div id="compras" class="tabcontent">
    <h2>Registrar Compra</h2>
    <p class="instrucao">Preencha todos os campos antes de salvar. O valor deve ser num√©rico e selecione pelo menos um consumidor.</p>
    <label>Produto: <input id="produto" required placeholder="Ex: Arroz"/></label>
    <label>Valor: <input id="valor" type="number" step="0.01" required placeholder="Ex: 25.50"/></label>
    <label>Quem comprou:
      <select id="comprador" required></select>
    </label>
    <label>Quem consumiu:</label>
    <div id="consumidores"></div>
    <button onclick="addCompra()">Salvar Compra</button>

    <h3>Compras Registradas</h3>
    <div class="list">
      <table id="tabelaCompras">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Valor (R$)</th>
            <th>Comprador</th>
            <th>Consumidores</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Aba Saldos -->
  <div id="saldos" class="tabcontent">
    <h2>Saldos</h2>
    <p class="instrucao">Clique em "Calcular" para ver quanto cada professor pagou, deveria pagar e qual o saldo final.</p>
    <button onclick="calcular()">Calcular</button>
    <div id="saldosLista"></div>
    <h3>Sugest√£o de Acertos</h3>
    <div id="transferencias"></div>
  </div>

  <!-- Aba Relat√≥rio -->
  <div id="relatorio" class="tabcontent">
    <h2>Relat√≥rio PDF</h2>
    <p class="instrucao">Clique no bot√£o abaixo para gerar um relat√≥rio em PDF com todas as compras, saldos e sugest√µes de acertos.</p>
    <button class="btn btn-gerar" onclick="gerarPDF()">Gerar Relat√≥rio PDF</button>
  </div>

</main>

<script>
let professores = [];
let compras = [];
let editIndex = null;

// Fun√ß√£o de abas
function openTab(evt, tabName){
  document.querySelectorAll(".tabcontent").forEach(tc=>tc.style.display="none");
  document.querySelectorAll(".tab button").forEach(tb=>tb.classList.remove("active"));
  document.getElementById(tabName).style.display="block";
  evt.currentTarget.classList.add("active");
}

// Sele√ß√£o de grupo
function selecionarGrupo(grupo){
  if(grupo === "A"){
    professores = ["Wanderson", "Gu", "Cris"];
  } else if(grupo === "B"){
    professores = ["Gu", "Emerson", "Galeno"];
  }
  atualizarUI();
}

// Atualiza interface
function atualizarUI(){
  const lista=document.getElementById("listaProfessores");
  lista.innerHTML=professores.map(p=>`<li>${p}</li>`).join("");

  document.getElementById("comprador").innerHTML=professores.map(p=>`<option value="${p}">${p}</option>`).join("");

  document.getElementById("consumidores").innerHTML=professores.map(p=>`<label><input type="checkbox" value="${p}">${p}</label>`).join("<br>");

  // Compras tabela
  const tbody=document.querySelector("#tabelaCompras tbody");
  tbody.innerHTML=compras.map((c,i)=>`
    <tr>
      <td>${c.produto}</td>
      <td>${c.valor.toFixed(2)}</td>
      <td>${c.comprador}</td>
      <td>${c.consumidores.join(", ")}</td>
      <td>
        <button class="btn btn-editar" onclick="editarCompra(${i})">Editar</button>
        <button class="btn btn-excluir" onclick="excluirCompra(${i})">Apagar</button>
      </td>
    </tr>
  `).join("");
}

// Compras
function addCompra(){
  const produto=document.getElementById("produto").value.trim();
  const valor=parseFloat(document.getElementById("valor").value);
  const comprador=document.getElementById("comprador").value;
  const consumidores=Array.from(document.querySelectorAll("#consumidores input:checked")).map(c=>c.value);

  if(!produto){
    alert("Erro: informe o nome do produto.");
    return;
  }
  if(isNaN(valor) || valor <= 0){
    alert("Erro: o valor deve ser num√©rico e maior que zero.");
    return;
  }
  if(!comprador){
    alert("Erro: selecione quem comprou.");
    return;
  }
  if(consumidores.length === 0){
    alert("Erro: selecione pelo menos um consumidor.");
    return;
  }

  if(editIndex!==null){ 
    compras[editIndex]={produto,valor,comprador,consumidores}; 
    editIndex=null; 
  } else {
    compras.push({produto,valor,comprador,consumidores});
  }
  document.getElementById("produto").value="";
  document.getElementById("valor").value="";
  document.querySelectorAll("#consumidores input").forEach(cb=>cb.checked=false);
  atualizarUI();
}

function editarCompra(i){
  const c=compras[i];
  document.getElementById("produto").value=c.produto;
  document.getElementById("valor").value=c.valor;
  document.getElementById("comprador").value=c.comprador;
  document.querySelectorAll("#consumidores input").forEach(cb=>cb.checked=c.consumidores.includes(cb.value));
  editIndex=i;
}

function excluirCompra(i){ compras.splice(i,1); atualizarUI(); }

// Saldos
function calcular(){
  if(compras.length === 0){
    alert("N√£o h√° compras registradas. Adicione pelo menos uma compra.");
    return;
  }

  let pagou={}, deveria={};
  professores.forEach(p=>{pagou[p]=0;deveria[p]=0;});
  compras.forEach(c=>{
    pagou[c.comprador]+=c.valor;
    let p=c.valor/c.consumidores.length;
    c.consumidores.forEach(cons=>{deveria[cons]+=p;});
  });
  const saldos=professores.map(p=>({nome:p,pagou:pagou[p],deveria:deveria[p],saldo:pagou[p]-deveria[p]}));
  document.getElementById("saldosLista").innerHTML=saldos.map(s=>
    `<p>${s.nome}: pagou R$${s.pagou.toFixed(2)}, deveria R$${s.deveria.toFixed(2)} ‚Üí 
     <span class="${s.saldo>=0?'saldo-positivo':'saldo-negativo'}">Saldo: R$${s.saldo.toFixed(2)}</span></p>`).join("");

  // Transferencias
  let devedores=saldos.filter(s=>s.saldo<-0.01).map(s=>({...s,saldo:-s.saldo}));
  let credores=saldos.filter(s=>s.saldo>0.01).map(s=>({...s}));
  let transf=[],i=0,j=0;
  while(i<devedores.length && j<credores.length){
    let val=Math.min(devedores[i].saldo, credores[j].saldo);
    transf.push(`${devedores[i].nome} paga R$${val.toFixed(2)} para ${credores[j].nome}`);
    devedores[i].saldo-=val; credores[j].saldo-=val;
    if(devedores[i].saldo<0.01)i++; if(credores[j].saldo<0.01) j++;
  }
  document.getElementById("transferencias").innerHTML=transf.length?transf.map(t=>`<p>${t}</p>`).join(""):"<p>Ningu√©m deve nada üéâ</p>";
}

// PDF
function gerarPDF(){
  if(compras.length === 0){
    alert("N√£o h√° dados para gerar o relat√≥rio. Registre pelo menos uma compra.");
    return;
  }

  calcular();
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();
  doc.setFontSize(14); doc.text("Relat√≥rio de Mantimentos",105,15,null,null,"center");
  let y=25; doc.setFontSize(10);
  doc.text("Compras:",10,y); y+=8;
  compras.forEach(c=>{doc.text(`${c.produto} - R$${c.valor.toFixed(2)} (Comprado por ${c.comprador}, Consumido por ${c.consumidores.join(", ")})`,10,y); y+=6; if(y>280){doc.addPage();y=20;}});
  y+=10; doc.text("Saldos:",10,y); y+=8;
  professores.forEach(p=>{const s=comprasSaldo(p); doc.text(`${p}: R$${s}`,10,y); y+=6;if(y>280){doc.addPage();y=20;}});
  y+=10; doc.text("Sugest√£o de Acertos:",10,y); y+=8;
  const t=document.getElementById("transferencias").innerText.split("\n");
  t.forEach(ti=>{doc.text(ti,10,y); y+=6; if(y>280){doc.addPage();y=20;}});
  doc.save("relatorio_mantimentos.pdf");

  function comprasSaldo(nome){
    let pagou=0,deveria=0;
    compras.forEach(c=>{if(c.comprador===nome)pagou+=c.valor; if(c.consumidores.includes(nome))deveria+=c.valor/c.consumidores.length;});
    return (pagou-deveria).toFixed(2);
  }
}
</script>
</body>
</html>
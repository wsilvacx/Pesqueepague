<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Despesas — Casa dos Professores</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#eef4fb;
    --card:#ffffff;
    --muted:#6b7280;
    --primary-600: #3b82f6;
    --primary-500: #60a5fa;
    --success: #2e7d32;
    --danger: #c62828;
    font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1200px 600px at 10% 10%, rgba(96,165,250,0.06), transparent 6%),
                linear-gradient(180deg, #fbfdff 0%, var(--bg) 100%);
    color:#111;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:24px;
  }

  .wrap{max-width:1100px;margin:0 auto;display:flex;flex-direction:column;gap:18px}

  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .title{display:flex;flex-direction:column}
  h1{margin:0;font-size:20px}
  .subtitle{color:var(--muted);font-size:13px;margin-top:6px}

  .controls{display:flex;gap:8px;align-items:center}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:0;cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.75));box-shadow:0 6px 18px rgba(15,23,42,0.06);color:#0b1220;font-weight:600;transition:transform .18s ease,box-shadow .18s ease}
  .btn:hover{transform:translateY(-3px);box-shadow:0 12px 28px rgba(15,23,42,0.08)}
  .btn.primary{background:linear-gradient(180deg,var(--primary-500),var(--primary-600));color:#fff}
  .btn.ghost{background:transparent;box-shadow:none;color:var(--muted);border:1px solid rgba(15,23,42,0.04);font-weight:600}
  .btn.danger{background:linear-gradient(180deg,#ff7b7b,#ff6b6b);color:#fff}

  .icon{width:16px;height:16px;display:inline-block;vertical-align:middle;opacity:0.95}

  /* layout vertical: saldos -> histórico -> sugestão */
  .col{display:flex;flex-direction:column;gap:14px}
  .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(20,30,60,0.06);border:1px solid rgba(15,23,42,0.03)}

  .balances{display:flex;gap:10px;flex-wrap:wrap}
  .balance-card{flex:1;min-width:160px;padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);box-shadow:0 6px 20px rgba(20,30,60,0.04);display:flex;flex-direction:column;gap:6px}
  .balance-amt{font-size:16px;font-weight:700}

  .ledger{max-height:380px;overflow:auto;border-radius:10px;padding:6px}
  table{width:100%;border-collapse:collapse}
  thead th{font-weight:700;color:var(--muted);text-align:left;padding:10px}
  td{padding:10px;border-bottom:1px solid rgba(15,23,42,0.04);font-size:14px}
  tr:hover td{background:linear-gradient(90deg, rgba(96,165,250,0.02), transparent)}

  .settlement-list{display:flex;flex-direction:column;gap:8px}
  .sett-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;background:#fff;border:1px solid rgba(15,23,42,0.03);box-shadow:0 6px 16px rgba(10,15,30,0.02)}

  /* floating action button (+) */
  .fab{position:fixed;right:22px;bottom:22px;width:60px;height:60px;border-radius:999px;display:flex;align-items:center;justify-content:center;box-shadow:0 16px 34px rgba(59,130,246,0.18);background:linear-gradient(135deg,#60a5fa,#3b82f6);color:#fff;border:0;cursor:pointer;z-index:1200;transition:transform .12s ease,box-shadow .12s ease}
  .fab:hover{transform:translateY(-6px);box-shadow:0 26px 58px rgba(59,130,246,0.22)}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(8,12,20,0.45);display:flex;align-items:center;justify-content:center;z-index:1300;opacity:0;pointer-events:none;transition:opacity .16s ease}
  .modal-backdrop.open{opacity:1;pointer-events:auto}
  .modal{background:var(--card);border-radius:12px;min-width:320px;max-width:760px;padding:18px;box-shadow:0 24px 60px rgba(10,20,50,0.32);transform:translateY(12px);transition:transform .18s ease,opacity .18s ease}
  .modal-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px}
  .modal-body{max-height:60vh;overflow:auto;padding-right:6px}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

  /* minimal scrollbar */
  .ledger::-webkit-scrollbar,.modal-body::-webkit-scrollbar{height:8px;width:8px}
  .ledger::-webkit-scrollbar-thumb,.modal-body::-webkit-scrollbar-thumb{background:rgba(15,23,42,0.06);border-radius:999px}
  .ledger::-webkit-scrollbar-track,.modal-body::-webkit-scrollbar-track{background:transparent}

  /* responsive */
  @media (max-width:780px){ .balances{flex-direction:column} .balance-card{min-width:unset} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>Divisão de Despesas — Casa dos Professores</h1>
      <div class="subtitle">Grupos: A (Wanderson, Gu, Cris) • B (Gu, Galeno, Emerson) — dados locais no navegador</div>
    </div>

    <div class="controls">
      <button id="exportPngBtn" class="btn primary" title="Exportar PNG">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M4 7h16v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7z" stroke="white" stroke-width="1.2"/><path d="M9 3h6v4H9z" stroke="white" stroke-width="1.2"/></svg>
        Exportar PNG
      </button>

      <button id="resetBtn" class="btn danger" title="Resetar dados">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 6h18" stroke="white" stroke-width="1.4"/><path d="M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" stroke="white" stroke-width="1.4"/></svg>
        Resetar
      </button>
    </div>
  </header>

  <main class="col">
    <!-- SALDOS -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Saldos</h3>
        <div class="subtitle" style="font-size:13px">Valores positivos: <strong style="color:var(--success)">a receber</strong> • negativos: <strong style="color:var(--danger)">a pagar</strong></div>
      </div>
      <div id="balancesContainer" class="balances" style="margin-top:12px"></div>
    </section>

    <!-- HISTÓRICO -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Histórico de despesas</h3>
        <div class="subtitle" style="font-size:13px">Clique no + para adicionar ou em Editar/Remover</div>
      </div>

      <div class="ledger" style="margin-top:12px;padding:8px">
        <table id="ledgerTable">
          <thead>
            <tr><th>Data</th><th>Descrição</th><th>Pago por</th><th>Valor</th><th>Participantes</th><th>Valor/pessoa</th><th></th></tr>
          </thead>
          <tbody id="ledgerBody"></tbody>
        </table>
      </div>
    </section>

    <!-- SUGESTÃO DE ACERTO (parte inferior) -->
    <section class="card">
      <h3 style="margin:0 0 8px 0">Sugestão de acerto</h3>
      <div id="settlementList" class="settlement-list">
        <div class="small-muted" id="noSettlements">Ainda sem despesas.</div>
      </div>
    </section>
  </main>
</div>

<!-- Floating action button -->
<button id="fab" class="fab" title="Adicionar despesa (modal)">
  <svg width="26" height="26" viewBox="0 0 24 24" fill="none"><path d="M12 5v14" stroke="white" stroke-width="1.8" stroke-linecap="round"/><path d="M5 12h14" stroke="white" stroke-width="1.8" stroke-linecap="round"/></svg>
</button>

<!-- MODAL BACKDROP -->
<div id="modalBackdrop" class="modal-backdrop" aria-hidden="true" style="display:none">
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle"></div>
</div>

<!-- html2canvas CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
(() => {
  // ===== configuração nomes/grupos =====
  const groupA = ['Wanderson','Gu','Cris'];
  const groupB = ['Gu','Galeno','Emerson'];
  const uniquePeople = Array.from(new Set([...groupA, ...groupB]));

  // DOM refs
  const ledgerBody = document.getElementById('ledgerBody');
  const balancesContainer = document.getElementById('balancesContainer');
  const settlementList = document.getElementById('settlementList');
  const noSettlements = document.getElementById('noSettlements');
  const exportPngBtn = document.getElementById('exportPngBtn');
  const resetBtn = document.getElementById('resetBtn');
  const fab = document.getElementById('fab');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modal = document.getElementById('modal');

  const STORAGE_KEY = 'despesas_casa_professores_v2';

  // dados
  let expenses = loadExpenses();

  // modal utilities (promise based)
  function openModal(contentHtml) {
    modal.innerHTML = '';
    if (typeof contentHtml === 'string') modal.innerHTML = contentHtml;
    else modal.appendChild(contentHtml);
    modalBackdrop.style.display = 'flex';
    requestAnimationFrame(() => modalBackdrop.classList.add('open'));
    const fi = modal.querySelector('input,select,button,textarea');
    if (fi) setTimeout(()=>fi.focus(), 80);
    return {
      close: (cleanup) => {
        modalBackdrop.classList.remove('open');
        setTimeout(()=> { modalBackdrop.style.display = 'none'; if (cleanup) cleanup(); }, 180);
      }
    };
  }

  function showConfirm(message, title = 'Confirmação') {
    return new Promise(resolve => {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div class="modal-head"><div><strong id="modalTitle">${escapeHtml(title)}</strong></div></div>
        <div class="modal-body">${escapeHtml(message)}</div>
        <div class="modal-actions">
          <button id="noBtn" class="btn ghost">Cancelar</button>
          <button id="yesBtn" class="btn primary">Confirmar</button>
        </div>`;
      const m = openModal(wrapper);
      wrapper.querySelector('#yesBtn').addEventListener('click', () => { m.close(); resolve(true); });
      wrapper.querySelector('#noBtn').addEventListener('click', () => { m.close(); resolve(false); });
      modalBackdrop.onclick = (e) => { if(e.target === modalBackdrop){ m.close(); resolve(false); } };
    });
  }

  function showAlert(message, title = 'Info') {
    return new Promise(resolve => {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div class="modal-head"><div><strong id="modalTitle">${escapeHtml(title)}</strong></div></div>
        <div class="modal-body">${escapeHtml(message)}</div>
        <div class="modal-actions"><button id="okBtn" class="btn primary">OK</button></div>`;
      const m = openModal(wrapper);
      wrapper.querySelector('#okBtn').addEventListener('click', () => { m.close(); resolve(); });
      modalBackdrop.onclick = (e) => { if(e.target === modalBackdrop){ m.close(); resolve(); } };
    });
  }

  // abrir modal de adicionar/editar despesa
  function openExpenseModal(expense) {
    return new Promise(resolve => {
      const isEdit = !!expense;
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div class="modal-head">
          <div><strong id="modalTitle">${isEdit ? 'Editar despesa' : 'Nova despesa'}</strong></div>
        </div>
        <div class="modal-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="field"><label>Data</label><input id="m-date" type="date"></div>
            <div class="field"><label>Valor (R$)</label><input id="m-amount" type="number" step="0.01" min="0"></div>
            <div class="field" style="grid-column:1 / -1"><label>Descrição</label><input id="m-desc" type="text" placeholder="Ex: Arroz, gás..."></div>
            <div class="field"><label>Grupo base</label>
              <select id="m-group">
                <option value="A">Grupo A (Wanderson, Gu, Cris)</option>
                <option value="B">Grupo B (Gu, Galeno, Emerson)</option>
                <option value="manual">Manual (todos)</option>
              </select>
            </div>
            <div class="field"><label>Quem pagou</label><select id="m-payer"></select></div>
          </div>

          <div style="margin-top:12px">
            <label style="display:block;margin-bottom:8px">Participantes (marque quem consumiu)</label>
            <div id="m-participants" style="display:flex;gap:8px;flex-wrap:wrap"></div>
            <div style="margin-top:8px"><button id="m-toggleAll" class="btn ghost">Selecionar todos</button></div>
          </div>
        </div>

        <div class="modal-actions">
          <button id="m-cancel" class="btn ghost">Cancelar</button>
          <button id="m-save" class="btn primary">${isEdit ? 'Salvar' : 'Adicionar'}</button>
        </div>
      `;

      const m = openModal(wrapper);
      const elDate = wrapper.querySelector('#m-date');
      const elAmount = wrapper.querySelector('#m-amount');
      const elDesc = wrapper.querySelector('#m-desc');
      const elGroup = wrapper.querySelector('#m-group');
      const elPayer = wrapper.querySelector('#m-payer');
      const elParticipants = wrapper.querySelector('#m-participants');
      const elToggleAll = wrapper.querySelector('#m-toggleAll');

      // preencher pagadores
      uniquePeople.forEach(n => { const opt = document.createElement('option'); opt.value = n; opt.textContent = n; elPayer.appendChild(opt); });

      if (isEdit) {
        elDate.value = expense.date;
        elAmount.value = (expense.amount_cents/100).toFixed(2);
        elDesc.value = expense.desc;
        // inferir grupo base para facilitar: se todos participantes estão em A e tamanho igual, escolher A; idem B; caso contrário manual
        const inA = expense.participants.length > 0 && expense.participants.every(p => groupA.includes(p));
        const inB = expense.participants.length > 0 && expense.participants.every(p => groupB.includes(p));
        if (expense.participants.length === 0) elGroup.value = 'manual';
        else if (inA && expense.participants.length === groupA.length) elGroup.value = 'A';
        else if (inB && expense.participants.length === groupB.length) elGroup.value = 'B';
        else elGroup.value = 'manual';
        elPayer.value = expense.payer;
      } else {
        elDate.valueAsDate = new Date();
        elAmount.value = '';
        elDesc.value = '';
        elGroup.value = 'A';
        elPayer.value = uniquePeople[0];
      }

      function renderParticipantsForGroup() {
        elParticipants.innerHTML = '';
        let people = [];
        if (elGroup.value === 'A') people = groupA;
        else if (elGroup.value === 'B') people = groupB;
        else people = uniquePeople;
        people.forEach(name => {
          const lab = document.createElement('label');
          lab.style.display = 'inline-flex';
          lab.style.alignItems = 'center';
          lab.style.gap = '8px';
          lab.style.padding = '8px';
          lab.style.borderRadius = '999px';
          lab.style.background = 'linear-gradient(180deg,#f8fbff,#f1f6ff)';
          lab.innerHTML = `<input type="checkbox" value="${escapeHtml(name)}"> ${escapeHtml(name)}`;
          elParticipants.appendChild(lab);
        });
        // marcar se editando
        if (isEdit && expense.participants && expense.participants.length) {
          elParticipants.querySelectorAll('input[type=checkbox]').forEach(cb => {
            if (expense.participants.includes(cb.value)) cb.checked = true;
          });
        }
      }

      elGroup.addEventListener('change', renderParticipantsForGroup);
      elToggleAll.addEventListener('click', () => {
        const cbs = elParticipants.querySelectorAll('input[type=checkbox]');
        const anyUnchecked = Array.from(cbs).some(cb => !cb.checked);
        cbs.forEach(cb => cb.checked = anyUnchecked);
      });

      renderParticipantsForGroup();

      wrapper.querySelector('#m-cancel').addEventListener('click', () => { m.close(); resolve(null); });
      wrapper.querySelector('#m-save').addEventListener('click', async () => {
        const date = elDate.value || new Date().toISOString().slice(0,10);
        const desc = elDesc.value.trim() || '(sem descrição)';
        const payer = elPayer.value;
        const amount = parseFloat(elAmount.value);
        if (isNaN(amount) || amount <= 0) { await showAlert('Digite um valor válido maior que 0.', 'Valor inválido'); return; }
        const participants = Array.from(elParticipants.querySelectorAll('input[type=checkbox]')).filter(cb => cb.checked).map(cb => cb.value);
        if (participants.length === 0) {
          const cont = await showConfirm('Nenhum participante selecionado. Deseja registrar a despesa sem dividir (somente o pagador)?', 'Sem participantes');
          if (!cont) return;
        }
        const cents = Math.round(amount*100);
        if (isEdit) {
          expense.date = date; expense.desc = desc; expense.payer = payer; expense.amount_cents = cents; expense.participants = participants;
          saveExpenses(); renderLedger(); renderBalancesAndSettlements(); m.close(); resolve(expense);
        } else {
          const newExp = { id: 'e-' + Date.now(), date, desc, payer, amount_cents: cents, participants };
          expenses.push(newExp); saveExpenses(); renderLedger(); renderBalancesAndSettlements(); m.close(); resolve(newExp);
        }
      });

      modalBackdrop.onclick = (e) => { if(e.target === modalBackdrop){ m.close(); resolve(null); } };
    });
  }

  function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s]); }

  function loadExpenses(){ try { const raw = localStorage.getItem(STORAGE_KEY); if (!raw) return []; return JSON.parse(raw); } catch(e){ console.error(e); return []; } }
  function saveExpenses(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses)); }

  function calculateNetBalances(){
    const net = {}; uniquePeople.forEach(p => net[p]=0);
    expenses.forEach(e => {
      net[e.payer] += e.amount_cents;
      const n = e.participants.length;
      if (n > 0){
        const baseShare = Math.floor(e.amount_cents / n);
        const remainder = e.amount_cents - baseShare * n;
        e.participants.forEach((p, idx) => {
          net[p] -= (baseShare + (idx < remainder ? 1 : 0));
        });
      }
    });
    return net;
  }

  function renderLedger(){
    ledgerBody.innerHTML = '';
    if (expenses.length === 0){
      const tr = document.createElement('tr');
      const td = document.createElement('td'); td.colSpan = 7; td.className = 'small-muted'; td.textContent = 'Nenhuma despesa registrada.';
      tr.appendChild(td); ledgerBody.appendChild(tr); return;
    }
    const sorted = expenses.slice().sort((a,b) => new Date(b.date) - new Date(a.date) || b.id.localeCompare(a.id));
    const fmt = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
    sorted.forEach(exp => {
      const tr = document.createElement('tr');
      const amount = fmt.format(exp.amount_cents/100);
      const participantsText = exp.participants.length ? exp.participants.join(', ') : '(nenhum)';
      const perPerson = exp.participants.length ? fmt.format((exp.amount_cents/100) / exp.participants.length) : '-';
      tr.innerHTML = `
        <td>${exp.date}</td>
        <td>${escapeHtml(exp.desc)}</td>
        <td>${escapeHtml(exp.payer)}</td>
        <td>${amount}</td>
        <td>${escapeHtml(participantsText)}</td>
        <td>${perPerson}</td>
        <td style="white-space:nowrap">
          <button data-id="${exp.id}" class="btn ghost btn-edit" style="margin-right:6px">Editar</button>
          <button data-id="${exp.id}" class="btn btn-remove" style="background:linear-gradient(180deg,#ff7b7b,#ff6b6b);color:#fff;">Remover</button>
        </td>`;
      ledgerBody.appendChild(tr);
    });

    ledgerBody.querySelectorAll('.btn-remove').forEach(btn => btn.addEventListener('click', async (ev) => {
      const id = ev.currentTarget.getAttribute('data-id');
      const ok = await showConfirm('Remover esta despesa?', 'Remover');
      if (!ok) return;
      expenses = expenses.filter(e => e.id !== id); saveExpenses(); renderLedger(); renderBalancesAndSettlements();
    }));

    ledgerBody.querySelectorAll('.btn-edit').forEach(btn => btn.addEventListener('click', async (ev) => {
      const id = ev.currentTarget.getAttribute('data-id');
      const exp = expenses.find(e => e.id === id);
      if (!exp) return;
      await openExpenseModal(exp);
    }));
  }

  function renderBalancesAndSettlements(){
    const fmt = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
    const net = calculateNetBalances();
    balancesContainer.innerHTML = '';
    uniquePeople.forEach(name => {
      const balance = net[name] || 0;
      const card = document.createElement('div'); card.className = 'balance-card';
      const nm = document.createElement('div'); nm.style.fontWeight='700'; nm.textContent = name;
      const amt = document.createElement('div'); amt.className='balance-amt'; amt.textContent = fmt.format(balance/100);
      amt.style.color = balance > 0 ? getComputedStyle(document.documentElement).getPropertyValue('--success') || '#2e7d32'
                      : (balance < 0 ? getComputedStyle(document.documentElement).getPropertyValue('--danger') || '#c62828' : '#333');
      const small = document.createElement('div'); small.className='small-muted'; small.textContent = balance>=0 ? 'A receber':'A pagar';
      card.appendChild(nm); card.appendChild(amt); card.appendChild(small);
      balancesContainer.appendChild(card);
    });

    // settlements
    settlementList.innerHTML = '';
    const creditors = [], debtors = [];
    for(const [name,cents] of Object.entries(net)){
      if (Math.abs(cents) < 1) continue;
      if (cents > 0) creditors.push({name,cents});
      else debtors.push({name,cents: -cents});
    }
    if (creditors.length === 0 && debtors.length === 0){
      noSettlements.style.display = 'block'; return;
    } else noSettlements.style.display = 'none';
    creditors.sort((a,b)=>b.cents-a.cents); debtors.sort((a,b)=>b.cents-a.cents);
    const settlements = []; let i=0,j=0;
    while(i<debtors.length && j<creditors.length){
      const debtor = debtors[i], creditor = creditors[j];
      const pay = Math.min(debtor.cents, creditor.cents);
      settlements.push({from:debtor.name,to:creditor.name,amount_cents:pay});
      debtor.cents -= pay; creditor.cents -= pay;
      if (debtor.cents === 0) i++; if (creditor.cents === 0) j++;
    }
    settlements.forEach(s => {
      const row = document.createElement('div'); row.className='sett-row';
      row.innerHTML = `<div>${escapeHtml(s.from)} → ${escapeHtml(s.to)}</div><div style="font-weight:700">${new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(s.amount_cents/100)}</div>`;
      settlementList.appendChild(row);
    });
  }

  // export PNG (saldos coloridos + histórico + acerto)
  exportPngBtn.addEventListener('click', async () => {
    try {
      const fmt = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
      const wrapper = document.createElement('div');
      wrapper.style.width = '900px'; wrapper.style.background = '#fff'; wrapper.style.color = '#111'; wrapper.style.padding = '18px'; wrapper.style.borderRadius = '10px'; wrapper.style.fontFamily = getComputedStyle(document.body).fontFamily;

      const title = document.createElement('div'); title.style.fontSize='18px'; title.style.fontWeight='700'; title.textContent='Divisão de Despesas — Casa dos Professores';
      const sub = document.createElement('div'); sub.style.color='#6b7280'; sub.style.marginBottom='10px'; sub.textContent = 'Gerado em: ' + new Date().toLocaleString('pt-BR');
      wrapper.appendChild(title); wrapper.appendChild(sub);

      // balances
      const net = calculateNetBalances();
      const balTitle = document.createElement('div'); balTitle.style.fontWeight='700'; balTitle.style.margin='8px 0'; balTitle.textContent='Saldos';
      wrapper.appendChild(balTitle);
      const balGrid = document.createElement('div'); balGrid.style.display='flex'; balGrid.style.gap='8px'; balGrid.style.flexWrap='wrap'; balGrid.style.marginBottom='10px';
      uniquePeople.forEach(name => {
        const card = document.createElement('div'); card.style.minWidth='140px'; card.style.padding='8px'; card.style.borderRadius='8px'; card.style.background='#f7fafc';
        const nm = document.createElement('div'); nm.style.fontWeight='700'; nm.textContent = name;
        const amt = document.createElement('div'); amt.style.fontSize='16px'; amt.style.fontWeight='700'; amt.style.marginTop='6px';
        const balance = net[name] || 0; amt.textContent = fmt.format(balance/100);
        if (balance > 0) amt.style.color = '#2e7d32'; else if (balance < 0) amt.style.color = '#c62828';
        card.appendChild(nm); card.appendChild(amt); balGrid.appendChild(card);
      });
      wrapper.appendChild(balGrid);

      // ledger
      const tblTitle = document.createElement('div'); tblTitle.style.fontWeight='700'; tblTitle.style.margin='8px 0'; tblTitle.textContent='Histórico de despesas';
      wrapper.appendChild(tblTitle);
      const table = document.createElement('table'); table.style.width='100%'; table.style.borderCollapse='collapse';
      const thead = document.createElement('thead'); thead.innerHTML = '<tr><th style="text-align:left;padding:8px">Data</th><th style="text-align:left;padding:8px">Descrição</th><th style="text-align:left;padding:8px">Pago por</th><th style="text-align:left;padding:8px">Valor</th><th style="text-align:left;padding:8px">Participantes</th></tr>';
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      const sorted = expenses.slice().sort((a,b)=> new Date(b.date) - new Date(a.date) || b.id.localeCompare(a.id));
      sorted.forEach(e => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="padding:6px">${e.date}</td><td style="padding:6px">${escapeHtml(e.desc)}</td><td style="padding:6px">${escapeHtml(e.payer)}</td><td style="padding:6px">${fmt.format(e.amount_cents/100)}</td><td style="padding:6px">${escapeHtml(e.participants.join(', '))}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      wrapper.appendChild(table);

      // settlements
      const settleTitle = document.createElement('div'); settleTitle.style.fontWeight='700'; settleTitle.style.margin='8px 0'; settleTitle.textContent='Sugestão de acerto';
      wrapper.appendChild(settleTitle);
      const creditors = [], debtors = [];
      for(const [name,cents] of Object.entries(net)){
        if (Math.abs(cents) < 1) continue;
        if (cents > 0) creditors.push({name,cents});
        else debtors.push({name,cents:-cents});
      }
      creditors.sort((a,b)=>b.cents-a.cents); debtors.sort((a,b)=>b.cents-a.cents);
      const settlements = []; let i=0,j=0;
      while(i<debtors.length && j<creditors.length){
        const debtor = debtors[i], creditor = creditors[j];
        const pay = Math.min(debtor.cents, creditor.cents);
        settlements.push({from:debtor.name,to:creditor.name,amount_cents:pay});
        debtor.cents -= pay; creditor.cents -= pay;
        if (debtor.cents === 0) i++; if (creditor.cents === 0) j++;
      }
      if (settlements.length === 0){
        const p = document.createElement('div'); p.style.color='#6b7280'; p.textContent = 'Nenhuma transação necessária.'; wrapper.appendChild(p);
      } else {
        settlements.forEach(s => {
          const r = document.createElement('div'); r.style.display='flex'; r.style.justifyContent='space-between'; r.style.padding='6px'; r.style.background='#fff'; r.style.borderRadius='6px'; r.style.marginBottom='6px';
          r.innerHTML = `<div>${escapeHtml(s.from)} → ${escapeHtml(s.to)}</div><div style="font-weight:700">${fmt.format(s.amount_cents/100)}</div>`;
          wrapper.appendChild(r);
        });
      }

      wrapper.style.position='fixed'; wrapper.style.left='-10000px'; wrapper.style.top='0';
      document.body.appendChild(wrapper);
      await new Promise(r=>setTimeout(r,60));
      const canvas = await html2canvas(wrapper, {backgroundColor:'#ffffff',scale:2,useCORS:true,logging:false});
      canvas.toBlob(blob => {
        if (!blob) { showAlert('Falha ao gerar imagem.','Erro'); document.body.removeChild(wrapper); return; }
        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url;
        a.download = `despesas_acerto_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`; a.click(); URL.revokeObjectURL(url);
        document.body.removeChild(wrapper);
      }, 'image/png');

    } catch(err){ console.error(err); showAlert('Erro ao exportar PNG: ' + (err.message || err), 'Erro'); }
  });

  // reset
  resetBtn.addEventListener('click', async () => {
    const ok = await showConfirm('Apagar todos os dados salvos no navegador? Esta ação não pode ser desfeita.','Resetar');
    if (!ok) return;
    expenses = []; saveExpenses(); renderLedger(); renderBalancesAndSettlements(); await showAlert('Dados apagados.','Resetado');
  });

  // FAB handler
  fab.addEventListener('click', async () => { await openExpenseModal(null); });

  // initial render
  renderLedger(); renderBalancesAndSettlements();

  // expose minimal helpers (opcional)
  window._expenses_app = { expenses, saveExpenses, loadExpenses, openExpenseModal };

})();
</script>
</body>
</html>
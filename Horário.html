<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Sistema de Horários — Disponibilidade por Dia</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:16px;color:#222;max-width:1100px}
  h1{margin:0 0 12px}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  button{padding:6px 10px;border-radius:6px;border:1px solid #bbb;background:#fff;cursor:pointer}
  button.primary{background:#2f80ed;color:#fff;border-color:transparent}
  fieldset{border:1px solid #ddd;padding:10px;border-radius:8px;margin-bottom:12px;background:#fafafa}
  label{margin-right:6px}
  input[type=text], input[type=time], input[type=number], select {padding:6px;border:1px solid #ccc;border-radius:6px}
  .list-inline{list-style:none;padding:0;margin:8px 0}
  .list-inline li{background:#fff;padding:6px;border-radius:6px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
  .small{font-size:0.9rem;color:#555}
  .grid-wrap{display:flex;gap:12px}
  .left-col{flex:1;min-width:320px}
  .right-col{flex:2;min-width:560px}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid #ddd;padding:8px}
  .muted{color:#666;font-size:0.9rem}
  .badge{background:#eee;padding:4px 8px;border-radius:999px;font-size:0.85rem;margin-left:6px}
  .lesson-block{padding:6px;border-radius:6px;background:#fff;margin-bottom:6px;border-left:4px solid #2f80ed}
</style>
</head>
<body>
<h1>Sistema de Horários — Disponibilidade por Dia</h1>

<div class="tabs">
  <button id="btnCad" onclick="showTab('cadastro')">Cadastro</button>
  <button class="primary" onclick="showTab('montar')">Montar Horário</button>
</div>

<!-- ============ Cadastro ============ -->
<div id="cadastro" class="tab active">
  <div class="grid-wrap">
    <div class="left-col">
      <fieldset>
        <legend><strong>Turma</strong></legend>
        <input type="text" id="nomeTurma" placeholder="Ex: 6ºA">
        <button onclick="cadastrarTurma()">Cadastrar Turma</button>
        <ul id="listaTurmas" class="list-inline"></ul>
      </fieldset>

      <fieldset>
        <legend><strong>Disciplina</strong></legend>
        <input type="text" id="nomeDisciplina" placeholder="Ex: Matemática">
        <button onclick="cadastrarDisciplina()">Cadastrar Disciplina</button>
        <ul id="listaDisciplinas" class="list-inline"></ul>
      </fieldset>
    </div>

    <div class="right-col">
      <fieldset>
        <legend><strong>Professor — disciplinas + meta + disponibilidade por dia</strong></legend>
        <label>Nome</label><br>
        <input type="text" id="nomeProfessor" placeholder="Nome do professor">

        <div style="margin-top:8px">
          <div class="small">Adicionar disciplina com meta:</div>
          <select id="discSelect"></select>
          <input type="number" id="metaInput" placeholder="Meta (nº aulas)" min="1" style="width:120px">
          <button onclick="adicionarDisciplinaMeta()">Adicionar</button>
          <ul id="listaDiscMeta" class="list-inline"></ul>
        </div>

        <hr>

        <div class="small">Disponibilidade por dia (marque os dias e informe horário):</div>
        <div id="diasCheckboxes" style="margin:6px 0;">
          <!-- dinamicamente preenchido -->
        </div>
        Início: <input type="time" id="inicioDisp" value="07:00">
        Fim: <input type="time" id="fimDisp" value="12:00">
        <button onclick="adicionarDisponibilidade()">Adicionar disponibilidade</button>

        <ul id="listaDisponibilidades" class="list-inline"></ul>

        <div style="margin-top:8px">
          <button onclick="cadastrarProfessor()">Cadastrar Professor</button>
        </div>

        <hr>
        <div class="small">Professores cadastrados:</div>
        <ul id="listaProfessores" class="list-inline"></ul>
      </fieldset>
    </div>
  </div>
</div>

<!-- ============ Montar Horário ============ -->
<div id="montar" class="tab" style="display:none">
  <div class="grid-wrap">
    <div class="left-col">
      <fieldset>
        <legend><strong>Adicionar / Editar Aula</strong></legend>

        <label>Turma</label>
        <select id="turmaHorario"></select>

        <label>Dia</label>
        <select id="diaHorario"></select>

        <div style="margin-top:8px">
          Início: <input type="time" id="horaInicioHorario">
          Fim: <input type="time" id="horaFimHorario">
        </div>

        <div style="margin-top:8px">
          <label>Disciplina</label>
          <select id="disciplinaHorario"></select>

          <label>Professor</label>
          <select id="professorHorario"></select>
        </div>

        <div style="margin-top:8px">
          <button onclick="adicionarHorario()">Adicionar</button>
          <button onclick="limparFormHorario()">Limpar</button>
        </div>
      </fieldset>

      <fieldset>
        <legend><strong>Horários cadastrados</strong></legend>
        <table>
          <thead><tr><th>Turma</th><th>Dia</th><th>Início</th><th>Fim</th><th>Disciplina</th><th>Professor</th><th>Ações</th></tr></thead>
          <tbody id="tabelaHorario"></tbody>
        </table>
      </fieldset>
    </div>

    <div class="right-col">
      <fieldset>
        <legend><strong>Grade semanal (visual)</strong></legend>
        <div id="grade" style="border:1px solid #ddd;padding:8px;border-radius:8px;min-height:300px"></div>
      </fieldset>

      <fieldset>
        <legend><strong>Controle de metas</strong></legend>
        <div id="controleMetas" class="muted"></div>
      </fieldset>
    </div>
  </div>
</div>

<script>
/* ================= dados em memória ================= */
const DAYS = ['Segunda','Terça','Quarta','Quinta','Sexta','Sábado'];

let turmas = [];
let disciplinas = [];
let professores = []; // {nome, disciplinasMeta:[{disciplina,meta}], disponibilidades:[{dia,inicio,fim}]}
let horarios = [];   // {id, turma, dia, inicio, fim, disciplina, professor}

let editHorarioId = null;
let tempDiscMeta = [];
let tempDisponibilidades = [];

/* ================ utilitários de tempo ================ */
function timeToMinutes(t){ if(!t) return null; const [hh,mm]=t.split(':').map(Number); return hh*60+mm; }
function intervalsOverlap(aStart,aEnd,bStart,bEnd){ return Math.max(aStart,bStart) < Math.min(aEnd,bEnd); }
function uid(){ return 'id'+Math.random().toString(36).slice(2,9); }

/* ================ inicializar checkboxes dias ================ */
function renderDiasCheckboxes(){
  const cont = document.getElementById('diasCheckboxes');
  cont.innerHTML = DAYS.map((d,i)=>`<label style="margin-right:8px"><input type="checkbox" value="${d}" id="chkDia${i}"> ${d}</label>`).join('');
}
renderDiasCheckboxes();

/* ================ abas ================ */
function showTab(id){
  document.querySelectorAll('.tab, #cadastro, #montar').forEach(el=>{
    // handle elements created with style display
    if(el.id===id) el.style.display = (id==='cadastro' || id==='montar') ? 'block' : '';
    else if(el.classList && el.classList.contains('tab')) el.style.display = 'none';
  });
  // ensure correct tab displayed
  if(id==='cadastro'){ document.getElementById('cadastro').style.display='block'; document.getElementById('montar').style.display='none'; }
  if(id==='montar'){ document.getElementById('cadastro').style.display='none'; document.getElementById('montar').style.display='block'; }
  atualizarSelecoes(); renderGrade(); atualizarControleMetas();
}

/* ================ cadastro turma/disciplinas ================ */
function cadastrarTurma(){
  const nome = document.getElementById('nomeTurma').value.trim(); if(!nome){ alert('Informe turma'); return; }
  if(turmas.includes(nome)){ alert('Turma já existe'); return; }
  turmas.push(nome); document.getElementById('nomeTurma').value=''; renderTurmas(); atualizarSelecoes();
}
function renderTurmas(){ document.getElementById('listaTurmas').innerHTML = turmas.map(t=>`<li>${t} <button onclick="removerTurma('${t}')">Remover</button></li>`).join(''); }
function removerTurma(t){ if(confirm('Remover turma e seus horários?')){ turmas=turmas.filter(x=>x!==t); horarios=horarios.filter(h=>h.turma!==t); renderTurmas(); atualizarTabela(); renderGrade(); atualizarControleMetas(); } }

function cadastrarDisciplina(){
  const nome = document.getElementById('nomeDisciplina').value.trim(); if(!nome){ alert('Informe disciplina'); return; }
  if(disciplinas.includes(nome)){ alert('Disciplina já existe'); return; }
  disciplinas.push(nome); document.getElementById('nomeDisciplina').value=''; renderDisciplinas(); atualizarSelecoes();
}
function renderDisciplinas(){ document.getElementById('listaDisciplinas').innerHTML = disciplinas.map(d=>`<li>${d} <button onclick="removerDisciplina('${d}')">Remover</button></li>`).join(''); }
function removerDisciplina(d){ if(confirm('Remover disciplina (limpa associações)?')){ disciplinas=disciplinas.filter(x=>x!==d); professores.forEach(p=>p.disciplinasMeta=p.disciplinasMeta.filter(dm=>dm.disciplina!==d)); horarios=horarios.filter(h=>h.disciplina!==d); renderDisciplinas(); renderProfessores(); atualizarSelecoes(); atualizarTabela(); renderGrade(); atualizarControleMetas(); } }

/* ================ professor: disciplinas + disponibilidade por dia ================ */
function adicionarDisciplinaMeta(){
  const sel = document.getElementById('discSelect').value;
  const meta = parseInt(document.getElementById('metaInput').value,10);
  if(!sel){ alert('Selecione disciplina'); return; }
  if(!meta || meta<=0){ alert('Meta inválida'); return; }
  if(tempDiscMeta.some(x=>x.disciplina===sel)){ alert('Disciplina já adicionada (temporário)'); return; }
  tempDiscMeta.push({disciplina:sel, meta}); renderTempDiscMeta();
}
function renderTempDiscMeta(){ document.getElementById('listaDiscMeta').innerHTML = tempDiscMeta.map(d=>`<li>${d.disciplina} (meta:${d.meta}) <button onclick="remTempDisc('${d.disciplina}')">Rem</button></li>`).join(''); }
function remTempDisc(d){ tempDiscMeta = tempDiscMeta.filter(x=>x.disciplina!==d); renderTempDiscMeta(); }

function adicionarDisponibilidade(){
  // ler checkboxes de dias
  const diasCheck = DAYS.map((d,i)=>document.getElementById('chkDia'+i).checked ? d : null).filter(Boolean);
  const inicio = document.getElementById('inicioDisp').value;
  const fim = document.getElementById('fimDisp').value;
  if(diasCheck.length===0){ alert('Marque ao menos um dia'); return; }
  if(!inicio || !fim){ alert('Informe início/fim'); return; }
  if(timeToMinutes(inicio) >= timeToMinutes(fim)){ alert('Início deve ser antes do fim'); return; }
  // adicionar para cada dia marcado
  for(const dia of diasCheck){
    tempDisponibilidades.push({dia, inicio, fim});
  }
  renderTempDisponibilidades();
  // desmarcar checkboxes para evitar adição acidental duplicada
  DAYS.forEach((_,i)=>document.getElementById('chkDia'+i).checked = false);
}
function renderTempDisponibilidades(){
  // mostrar agrupado por dia para clareza
  const grouped = {};
  tempDisponibilidades.forEach(d=>{
    grouped[d.dia] = grouped[d.dia] || [];
    grouped[d.dia].push(`${d.inicio}-${d.fim}`);
  });
  const html = Object.keys(grouped).map(d=>`<li>${d}: ${grouped[d].join(', ')} <button onclick="remTempDisponibilidade('${d}')">Rem</button></li>`).join('');
  document.getElementById('listaDisponibilidades').innerHTML = html;
}
function remTempDisponibilidade(dia){
  tempDisponibilidades = tempDisponibilidades.filter(x=>x.dia!==dia);
  renderTempDisponibilidades();
}

function cadastrarProfessor(){
  const nome = document.getElementById('nomeProfessor').value.trim();
  if(!nome){ alert('Informe nome'); return; }
  if(tempDiscMeta.length===0){ alert('Adicione ao menos 1 disciplina com meta'); return; }
  if(tempDisponibilidades.length===0){ alert('Adicione ao menos 1 disponibilidade'); return; }
  if(professores.some(p=>p.nome===nome)){ alert('Professor já cadastrado'); return; }
  professores.push({nome, disciplinasMeta: JSON.parse(JSON.stringify(tempDiscMeta)), disponibilidades: JSON.parse(JSON.stringify(tempDisponibilidades))});
  tempDiscMeta=[]; tempDisponibilidades=[];
  renderTempDiscMeta(); renderTempDisponibilidades();
  document.getElementById('nomeProfessor').value='';
  renderProfessores(); atualizarSelecoes(); atualizarControleMetas();
}

function renderProfessores(){
  document.getElementById('listaProfessores').innerHTML = professores.map((p,idx)=>{
    const discs = p.disciplinasMeta.map(d=>`${d.disciplina}(m:${d.meta})`).join('; ');
    const disps = p.disponibilidades.map(d=>`${d.dia} ${d.inicio}-${d.fim}`).join('; ');
    return `<li><div><strong>${p.nome}</strong><div class="muted">${discs}</div><div class="muted">${disps}</div></div>
      <div><button onclick="editarProfessor(${idx})">Editar</button><button onclick="removerProfessor('${p.nome}')">Remover</button></div></li>`;
  }).join('');
}

function editarProfessor(idx){
  const p = professores[idx];
  if(!p) return;
  document.getElementById('nomeProfessor').value = p.nome;
  tempDiscMeta = JSON.parse(JSON.stringify(p.disciplinasMeta));
  tempDisponibilidades = JSON.parse(JSON.stringify(p.disponibilidades));
  renderTempDiscMeta(); renderTempDisponibilidades();
  // remover o professor original para permitir recadastro ao salvar
  if(confirm('Ao editar, o registro atual será removido. Deseja continuar?')) {
    professores.splice(idx,1);
    renderProfessores(); atualizarSelecoes(); atualizarControleMetas();
  }
}

function removerProfessor(nome){
  if(confirm('Remover professor e seus horários?')){
    professores = professores.filter(p=>p.nome!==nome);
    horarios = horarios.filter(h=>h.professor!==nome);
    renderProfessores(); atualizarSelecoes(); atualizarTabela(); renderGrade(); atualizarControleMetas();
  }
}

/* ================ seleções ================ */
function atualizarSelecoes(){
  document.getElementById('turmaHorario').innerHTML = turmas.map(t=>`<option value="${t}">${t}</option>`).join('');
  document.getElementById('disciplinaHorario').innerHTML = `<option value="">--</option>` + disciplinas.map(d=>`<option value="${d}">${d}</option>`).join('');
  document.getElementById('discSelect').innerHTML = `<option value="">--</option>` + disciplinas.map(d=>`<option value="${d}">${d}</option>`).join('');
  document.getElementById('diaHorario').innerHTML = DAYS.map(d=>`<option value="${d}">${d}</option>`).join('');
  atualizarProfessoresHorario();
}

/* quando disciplina muda, filtra professores que ministram ela */
function atualizarProfessoresHorario(){
  const disc = document.getElementById('disciplinaHorario').value;
  const poss = professores.filter(p => !disc || p.disciplinasMeta.some(dm=>dm.disciplina===disc));
  document.getElementById('professorHorario').innerHTML = poss.map(p=>`<option value="${p.nome}">${p.nome}</option>`).join('');
}

/* ================ adicionar / editar horário ================ */
function adicionarHorario(){
  const turma = document.getElementById('turmaHorario').value;
  const dia = document.getElementById('diaHorario').value;
  const inicio = document.getElementById('horaInicioHorario').value;
  const fim = document.getElementById('horaFimHorario').value;
  const disciplina = document.getElementById('disciplinaHorario').value;
  const professorNome = document.getElementById('professorHorario').value;

  if(!turma || !dia || !inicio || !fim || !disciplina || !professorNome){ alert('Preencha todos os campos'); return; }
  if(timeToMinutes(inicio) >= timeToMinutes(fim)){ alert('Início deve ser antes do fim'); return; }

  const prof = professores.find(p=>p.nome===professorNome);
  if(!prof){ alert('Professor não encontrado'); return; }
  if(!prof.disciplinasMeta.some(dm=>dm.disciplina===disciplina)){ alert(`Professor ${prof.nome} não ministra ${disciplina}`); return; }

  // disponibilidade: intervalo deve caber em alguma disponibilidade do professor PARA O MESMO DIA
  const disponivel = prof.disponibilidades.some(d=> d.dia===dia && timeToMinutes(inicio) >= timeToMinutes(d.inicio) && timeToMinutes(fim) <= timeToMinutes(d.fim) );
  if(!disponivel){ alert(`Professor ${prof.nome} não disponível em ${dia} no horário ${inicio}-${fim}`); return; }

  // checar conflito de sobreposição com outros horários do professor no MESMO DIA (ignorar o próprio registro se estiver editando)
  const conflito = horarios.find(h=>{
    if(h.professor !== professorNome) return false;
    if(h.dia !== dia) return false;
    if(editHorarioId && h.id === editHorarioId) return false;
    return intervalsOverlap(timeToMinutes(h.inicio), timeToMinutes(h.fim), timeToMinutes(inicio), timeToMinutes(fim));
  });
  if(conflito){ alert(`Conflito: ${professorNome} já está em ${conflito.turma} (${conflito.inicio}-${conflito.fim}) nesse dia.`); return; }

  if(editHorarioId){
    const idx = horarios.findIndex(h=>h.id===editHorarioId);
    if(idx>=0) horarios[idx] = { id: editHorarioId, turma, dia, inicio, fim, disciplina, professor: professorNome };
    editHorarioId = null;
  } else {
    horarios.push({ id: uid(), turma, dia, inicio, fim, disciplina, professor: professorNome });
  }
  limparFormHorario();
  atualizarTabela(); renderGrade(); atualizarControleMetas();
}

function limparFormHorario(){
  editHorarioId = null;
  document.getElementById('horaInicioHorario').value='';
  document.getElementById('horaFimHorario').value='';
  document.getElementById('disciplinaHorario').value='';
  atualizarProfessoresHorario();
}

/* editar/remover horários */
function editarHorario(id){
  const h = horarios.find(x=>x.id===id);
  if(!h) return;
  editHorarioId = id;
  document.getElementById('turmaHorario').value = h.turma;
  document.getElementById('diaHorario').value = h.dia;
  document.getElementById('horaInicioHorario').value = h.inicio;
  document.getElementById('horaFimHorario').value = h.fim;
  document.getElementById('disciplinaHorario').value = h.disciplina;
  atualizarProfessoresHorario();
  document.getElementById('professorHorario').value = h.professor;
  showTab('montar');
}
function removerHorario(id){ if(confirm('Remover horário?')){ horarios = horarios.filter(h=>h.id!==id); atualizarTabela(); renderGrade(); atualizarControleMetas(); } }

/* atualizar tabela listagem */
function atualizarTabela(){
  const tbody = document.getElementById('tabelaHorario');
  if(horarios.length===0){ tbody.innerHTML = '<tr><td colspan="7" class="muted">Nenhum horário cadastrado</td></tr>'; return; }
  tbody.innerHTML = horarios.map(h=>`<tr>
    <td>${h.turma}</td><td>${h.dia}</td><td>${h.inicio}</td><td>${h.fim}</td><td>${h.disciplina}</td><td>${h.professor}</td>
    <td><button onclick="editarHorario('${h.id}')">Editar</button> <button onclick="removerHorario('${h.id}')">Remover</button></td>
  </tr>`).join('');
}

/* ================ render grade semanal (simples) ================ */
function renderGrade(){
  const cont = document.getElementById('grade');
  if(horarios.length===0){ cont.innerHTML = '<div class="muted">Nenhuma aula agendada</div>'; return; }
  // agrupar por dia e ordenar por início
  const grouped = {};
  for(const d of DAYS) grouped[d]=[];
  for(const h of horarios) grouped[h.dia] = grouped[h.dia]||[], grouped[h.dia].push(h);
  for(const d in grouped) grouped[d].sort((a,b)=>timeToMinutes(a.inicio)-timeToMinutes(b.inicio));
  let html = '<div style="display:flex;gap:12px">';
  for(const d of DAYS){
    html += `<div style="flex:1;border:1px solid #eee;padding:8px;border-radius:6px;min-height:120px">
      <strong>${d}</strong><div style="margin-top:6px">`;
    if(grouped[d].length===0) html += '<div class="muted">—</div>';
    else grouped[d].forEach(h=>{
      html += `<div class="lesson-block"><div><strong>${h.disciplina}</strong> <span class="muted">(${h.turma})</span></div><div class="muted">${h.inicio}–${h.fim} • ${h.professor}</div></div>`;
    });
    html += `</div></div>`;
  }
  html += '</div>';
  cont.innerHTML = html;
}

/* ================ controle metas ================ */
function atualizarControleMetas(){
  const cont = document.getElementById('controleMetas');
  if(professores.length===0){ cont.innerHTML = '<div class="muted">Nenhum professor cadastrado</div>'; return; }
  let html = '';
  for(const p of professores){
    html += `<div style="margin-bottom:10px"><strong>${p.nome}</strong> <span class="badge">${p.disciplinasMeta.length} disciplinas</span>`;
    for(const dm of p.disciplinasMeta){
      const atrib = horarios.filter(h=>h.professor===p.nome && h.disciplina===dm.disciplina).length;
      const excedeu = atrib > dm.meta;
      html += `<div style="display:flex;justify-content:space-between;padding:6px;border-radius:6px;background:${excedeu ? '#fff0f0' : '#fff'};margin-top:6px">
        <div><strong>${dm.disciplina}</strong> <span class="muted">(${atrib}/${dm.meta})</span></div>
        <div>${excedeu ? '<strong style="color:#c0392b">META ULTRAPASSADA</strong>' : ''} <button onclick="ajustarMetaPrompt('${p.nome}','${dm.disciplina}')">Ajustar</button></div>
      </div>`;
    }
    html += `</div>`;
  }
  cont.innerHTML = html;
}
function ajustarMetaPrompt(profNome, disciplina){
  const p = professores.find(x=>x.nome===profNome);
  if(!p) return;
  const dm = p.disciplinasMeta.find(x=>x.disciplina===disciplina);
  if(!dm) return;
  const novo = parseInt(prompt(`Meta atual para ${profNome} - ${disciplina} = ${dm.meta}\nInforme nova meta:` , dm.meta),10);
  if(!novo || novo<=0) return;
  dm.meta = novo;
  atualizarControleMetas();
}

/* ================ inicial ================ */
function inicializar(){
  atualizarSelecoes();
  renderTurmas();
  renderDisciplinas();
  renderProfessores();
  atualizarTabela();
  renderGrade();
  atualizarControleMetas();
}
inicializar();

/* vincular evento mudança disciplina para filtrar professores */
document.getElementById('disciplinaHorario').addEventListener('change', atualizarProfessoresHorario);

</script>
</body>
</html>
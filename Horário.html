<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sistema de Horários Responsivo com PDF</title>
<style>
  :root{--primary:#2463ff;--bg:#f6f8fc;--card:#fff;--ok:#138a36;--warn:#ad6400;--danger:#c0392b}
  body{font-family:Inter,Segoe UI,Roboto,Arial;color:#0f172a;background:var(--bg);margin:0;padding:12px}
  h1{margin:0 0 12px;font-size:1.6rem}
  .layout{display:grid;grid-template-columns:1fr 2fr;gap:12px}
  @media(max-width:900px){.layout{grid-template-columns:1fr;}}
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(15,30,60,.08);overflow:auto}
  .muted{color:#63748a;font-size:0.8rem}
  .controls{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  button{background:var(--primary);color:#fff;border:none;border-radius:9px;padding:6px 10px;cursor:pointer;font-size:0.85rem}
  button.ghost{background:#fff;color:var(--primary);border:1px solid #dfe8ff}
  button.bad{background:#ffe8e6;color:var(--danger)}
  input,select{width:100%;padding:6px;border:1px solid #e6edf7;border-radius:9px;background:#fbfdff;font-size:0.85rem}
  .list{margin-top:8px;max-height:180px;overflow:auto;border-top:1px dashed #e8eefc;padding-top:8px}
  .item{display:flex;justify-content:space-between;align-items:flex-start;padding:6px 0;border-bottom:1px solid #f1f4fb;gap:6px;font-size:0.85rem}
  .pill{display:inline-flex;align-items:center;gap:4px;padding:2px 6px;border-radius:999px;border:1px solid #e9f1ff;background:#f7faff;font-size:0.75rem}
  .ok{color:var(--ok);font-weight:700}
  table.schedule{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed;font-size:0.75rem}
  table.schedule th,table.schedule td{border:1px solid #e6edf5;padding:4px;text-align:center;word-wrap:break-word}
  table.schedule th{background:#f9fbff;font-size:0.75rem}
  td.cell{height:60px;vertical-align:middle;position:relative;cursor:pointer}
  .assign{display:flex;flex-direction:column;gap:2px;padding:4px;border-radius:6px;border:1px solid #e8eefc;background:#f9fbff;font-size:0.75rem}
  .assign .disc{font-weight:700}
  .assign .prof{font-size:0.7rem;color:#556577}
  .droptarget{outline:2px dashed #9ab3ff;outline-offset:-4px}
  .modal{display:none;position:fixed;inset:0;background:rgba(6,12,30,.45);z-index:1000;justify-content:center;align-items:center}
  .modal.show{display:flex}
  .modal-card{width:720px;max-width:96%;background:#fff;border-radius:12px;padding:14px;box-shadow:0 14px 60px rgba(10,20,40,.18)}
  .modal-sm{width:460px;max-width:94%}
  .close{float:right;cursor:pointer;color:#c0392b;font-weight:800;font-size:1.2rem}
  .wizard-steps{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap;font-size:0.75rem}
  .step{padding:4px 6px;border-radius:6px;background:#eff5ff;font-weight:700}
  .disc-item{display:flex;align-items:center;gap:6px;padding:6px;border:1px solid #eef2fb;border-radius:6px;font-size:0.75rem}
  .disc-item.disabled{opacity:.55}
  .togglecopy{display:inline-flex;align-items:center;gap:4px;padding:2px 6px;border-radius:999px;border:1px dashed #c9d6ff;background:#f4f7ff;font-size:0.75rem}
</style>
</head>
<body>
<h1>Sistema de Horários Responsivo + PDF</h1>
<div class="layout">
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
    <h2 style="margin:0;font-size:1rem">Cadastros</h2>
    <div class="controls">
      <button id="btnAddDisc">+ Disciplina</button>
      <button id="btnAddTurma">+ Turma</button>
      <button id="btnAddProf">+ Professor</button>
    </div>
  </div>
  <h3 style="margin-top:10px;font-size:0.85rem">Disciplinas</h3>
  <div id="listaDisciplinas" class="list muted">Nenhuma disciplina.</div>
  <h3 style="margin-top:6px;font-size:0.85rem">Turmas</h3>
  <div id="listaTurmas" class="list muted">Nenhuma turma.</div>
  <h3 style="margin-top:6px;font-size:0.85rem">Professores</h3>
  <div id="listaProfessores" class="list muted">Nenhum professor.</div>
  <div class="controls">
    <button id="btnExport">Exportar JSON</button>
    <label class="pill" style="cursor:pointer">Importar JSON
      <input id="importFile" type="file" accept="application/json" style="display:none"/>
    </label>
    <button id="btnClearAll" class="ghost">Apagar tudo</button>
    <button id="btnRelTurma" class="ghost">PDF por Turma</button>
    <button id="btnRelProf" class="ghost">PDF por Professor</button>
  </div>
</div>

<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
    <h2 style="margin:0;font-size:1rem">Montar horário</h2>
    <div class="controls">
      <label class="muted" style="display:flex;gap:4px;align-items:center">Períodos
        <select id="periodosCount">
          <option value="4">4</option><option value="5" selected>5</option><option value="6">6</option>
        </select>
      </label>
      <label class="togglecopy"><input type="checkbox" id="toggleCopy"> Copiar ao arrastar</label>
      <button id="btnRenderGrid">Gerar grade</button>
    </div>
  </div>
  <div style="display:flex;gap:6px;align-items:center;margin-top:6px">
    <label>Turma</label>
    <select id="selectTurma"></select>
  </div>
  <p class="muted" style="margin-top:4px;font-size:0.75rem">
    Clique numa célula para atribuir. Drag & drop: <b>Mover</b> normalmente, <b>Copiar</b> com CTRL/⌘ ou toggle.
  </p>
  <div id="gridArea" style="margin-top:6px;overflow-x:auto"></div>
</div>
</div>

<!-- MODAIS: DISC/TURMA/PROF/ASSIGN seguem iguais ao código anterior -->

<!-- jsPDF + autoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
/* ====== STATE ====== */
const LS_KEY='horarios_meta_drag_v3';
const DAYS=['Segunda','Terça','Quarta','Quinta','Sexta','Sábado'];
let state={disciplinas:[], turmas:[], professores:[], horarios:{}};
function uid(p='id'){return p+'_'+Math.random().toString(36).slice(2,9)}
function save(){localStorage.setItem(LS_KEY, JSON.stringify(state))}
function load(){try{const raw=localStorage.getItem(LS_KEY); if(raw) state=JSON.parse(raw);}catch(e){}}
load();
/* ====== HELPERS ====== */
const $=s=>document.querySelector(s);
function findDisc(id){return state.disciplinas.find(d=>d.id===id)}
function findTurma(id){return state.turmas.find(t=>t.id===id)}
function findProf(id){return state.professores.find(p=>p.id===id)}
function contarAulas(profId, discId, turmaId){let c=0;for(const tid in state.horarios){const h=state.horarios[tid];if(!h) continue;for(const d of DAYS){const arr=h.grid?.[d]||[];arr.forEach(cell=>{if(cell && cell.professorId===profId && cell.disciplinaId===discId && tid===turmaId) c++;});}}return c}
function isProfBusy(profId, dia, periodo, ignore){for(const tid in state.horarios){const h=state.horarios[tid]; if(!h) continue; const cell=h.grid?.[dia]?.[periodo]||null;if(!cell) continue;if(ignore && tid===ignore.turmaId && dia===ignore.dia && periodo===ignore.periodo) continue;if(cell.professorId===profId) return true;}return false}

/* ====== FUNÇÕES DE RELATÓRIO PDF ====== */
async function relPDFTurma(){
  const turmaId=prompt('Informe o ID da turma ou nome exato:');
  if(!turmaId) return;
  const t=state.turmas.find(x=>x.id===turmaId || x.nome===turmaId);
  if(!t){alert('Turma não encontrada');return;}
  const h=state.horarios[t.id]; if(!h){alert('Nenhum horário para esta turma'); return;}
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF(); doc.setFontSize(10);
  doc.text(`Horário - Turma: ${t.nome}`,10,10);
  const table={head:[['Dia/Período',...Array(h.periodos).fill(0).map((_,i)=>i+1)]], body:[]};
  DAYS.forEach(d=>{
    const row=[d];
    for(let p=0;p<h.periodos;p++){
      const cell=h.grid[d][p];
      if(cell){const prof=findProf(cell.professorId); const disc=findDisc(cell.disciplinaId); row.push(`${disc?.nome||''}\n${prof?.nome||''}`);}
      else row.push('');
    }
    table.body.push(row);
  });
  doc.autoTable(table); doc.save(`Horario_Turma_${t.nome}.pdf`);
}

async function relPDFProf(){
  const profId=prompt('Informe o ID do professor ou nome exato:');
  if(!profId) return;
  const p=state.professores.find(x=>x.id===profId || x.nome===profId);
  if(!p){alert('Professor não encontrado');return;}
  const {jsPDF}=window.jspdf; const doc=new jsPDF(); doc.setFontSize(10);
  doc.text(`Horário - Professor: ${p.nome}`,10,10);
  const table={head:[['Dia','Turma','Período','Disciplina']], body:[]};
  for(const tid in state.horarios){
    const h=state.horarios[tid]; if(!h) continue;
    for(const d of DAYS){
      h.grid[d].forEach((cell,idx)=>{
        if(cell && cell.professorId===p.id){
          const disc=findDisc(cell.disciplinaId);
          table.body.push([d, findTurma(tid)?.nome||'', idx+1, disc?.nome||'']);
        }
      });
    }
  }
  doc.autoTable(table); doc.save(`Horario_Professor_${p.nome}.pdf`);
}

/* ====== EVENTOS BOTÕES PDF ====== */
$('#btnRelTurma').addEventListener('click',relPDFTurma);
$('#btnRelProf').addEventListener('click',relPDFProf);

/* ====== IMPORT/EXPORT ====== */
$('#btnExport').addEventListener('click',()=>{const data=JSON.stringify(state,null,2); const a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(data); a.download='horarios.json'; a.click();})
$('#importFile').addEventListener('change',e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{try{state=JSON.parse(ev.target.result); save(); location.reload();}catch(err){alert('JSON inválido')}}; reader.readAsText(file);
})
$('#btnClearAll').addEventListener('click',()=>{if(confirm('Apagar todos os dados?')){state={disciplinas:[],turmas:[],professores:[],horarios:{}};save(); location.reload();}})

/* ====== RENDER GRADE ====== */
function renderGrid(){
  const turmaId=$('#selectTurma').value; if(!turmaId) return alert('Selecione uma turma');
  const periodoCount=Number($('#periodosCount').value);
  if(!state.horarios[turmaId]) state.horarios[turmaId]={periodos:periodoCount, grid:{}};
  const gridData=state.horarios[turmaId];
  gridData.periodos=periodoCount;
  DAYS.forEach(d=>{if(!gridData.grid[d]) gridData.grid[d]=Array(periodoCount).fill(null);})
  const table=document.createElement('table'); table.className='schedule';
  const thead=document.createElement('thead'); const tr=document.createElement('tr'); tr.innerHTML='<th>Dia/Período</th>'+Array(periodoCount).fill(0).map((_,i)=>`<th>${i+1}</th>`).join(''); thead.appendChild(tr); table.appendChild(thead);
  const tbody=document.createElement('tbody');
  DAYS.forEach(d=>{
    const tr=document.createElement('tr'); const tdDia=document.createElement('th'); tdDia.textContent=d; tr.appendChild(tdDia);
    for(let p=0;p<periodoCount;p++){
      const td=document.createElement('td'); td.className='cell'; td.dataset.dia=d; td.dataset.periodo=p; td.dataset.turma=turmaId;
      const cell=gridData.grid[d][p];
      if(cell){const prof=findProf(cell.professorId); const disc=findDisc(cell.disciplinaId); const div=document.createElement('div'); div.className='assign'; div.innerHTML=`<div class="disc">${disc?.nome}</div><div class="prof">${prof?.nome}</div>`; if(contarAulas(prof.id,disc.id,turmaId)>=prof.meta?.[disc.id]?.[turmaId]) div.classList.add('ok'); td.appendChild(div);}
      td.addEventListener('click',()=>assignCell(td));
      td.setAttribute('draggable','true');
      td.addEventListener('dragstart',dragStart);
      td.addEventListener('dragover',dragOver);
      td.addEventListener('drop',dropCell);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); $('#gridArea').innerHTML=''; $('#gridArea').appendChild(table);
  save();
}
$('#btnRenderGrid').addEventListener('click',renderGrid);

/* ====== DRAG & DROP ====== */
let dragData=null;
function dragStart(e){dragData={td:e.target, clone:$('#toggleCopy').checked || e.ctrlKey|| e.metaKey};}
function dragOver(e){e.preventDefault(); e.currentTarget.classList.add('droptarget');}
function dropCell(e){e.preventDefault(); e.currentTarget.classList.remove('droptarget'); if(!dragData) return; const src=dragData.td; const dst=e.currentTarget; if(dragData.clone){dst.innerHTML=src.innerHTML;} else{dst.innerHTML=src.innerHTML; src.innerHTML='';} updateStateFromGrid(); dragData=null; save();}
function updateStateFromGrid(){
  for(const tid in state.horarios){
    const h=state.horarios[tid];
    DAYS.forEach(d=>{const arr=[]; const tds=[...$('#gridArea table').querySelectorAll(`td.cell[data-dia="${d}"]`)];
      tds.forEach(td=>{const div=td.querySelector('.assign'); if(div){const disc=state.disciplinas.find(x=>x.nome===div.querySelector('.disc')?.textContent); const prof=state.professores.find(x=>x.nome===div.querySelector('.prof')?.textContent); arr.push({disciplinaId:disc?.id,professorId:prof?.id});} else arr.push(null);}); h.grid[d]=arr;});
  }
}

/* ====== ASSIGN CELLS ====== */
function assignCell(td){
  const turmaId=td.dataset.turma; const dia=td.dataset.dia; const periodo=td.dataset.periodo;
  const profList=state.professores.map(p=>p.nome).join('\n'); const input=prompt(`Escolha professor:\n${profList}`); if(!input) return;
  const prof=state.professores.find(p=>p.nome===input); if(!prof){alert('Professor inválido'); return;}
  if(!prof.disciplinas || prof.disciplinas.length===0){alert('Professor não possui disciplinas'); return;}
  const discList=prof.disciplinas.map(d=>findDisc(d.discId)?.nome).join('\n'); const discName=prompt(`Escolha disciplina do professor:\n${discList}`); if(!discName) return;
  const disc=state.disciplinas.find(d=>d.nome===discName); if(!disc) return alert('Disciplina inválida');
  if(!prof.disciplinas.find(d=>d.discId===disc.id && d.turmaId===turmaId)) return alert('Professor não leciona esta disciplina nesta turma');
  if(contarAulas(prof.id,disc.id,turmaId)>=prof.meta?.[disc.id]?.[turmaId]) alert('Meta atingida!');
  if(isProfBusy(prof.id,dia,periodo,{turmaId,dia,periodo})) return alert('Professor ocupado neste horário');
  td.innerHTML=`<div class="assign"><div class="disc">${disc.nome}</div><div class="prof">${prof.nome}</div></div>`;
  renderGrid();
}

/* ====== RENDER LISTAS ====== */
function renderListas(){
  const ld=$('#listaDisciplinas'); ld.innerHTML=''; state.disciplinas.forEach(d=>{const div=document.createElement('div'); div.className='item'; div.textContent=d.nome; ld.appendChild(div);});
  const lt=$('#listaTurmas'); lt.innerHTML=''; state.turmas.forEach(t=>{const div=document.createElement('div'); div.className='item'; div.textContent=t.nome; lt.appendChild(div);});
  const lp=$('#listaProfessores'); lp.innerHTML=''; state.professores.forEach(p=>{const div=document.createElement('div'); div.className='item'; div.textContent=p.nome; lp.appendChild(div);});
  const selT=$('#selectTurma'); selT.innerHTML=''; state.turmas.forEach(t=>{const opt=document.createElement('option'); opt.value=t.id; opt.textContent=t.nome; selT.appendChild(opt);});
}
renderListas();

/* ====== CADASTROS SIMPLES (Modal simplificado) ====== */
$('#btnAddDisc').addEventListener('click',()=>{
  const nome=prompt('Nome da disciplina:'); if(!nome) return; state.disciplinas.push({id:uid('disc'),nome}); save(); renderListas();
});
$('#btnAddTurma').addEventListener('click',()=>{
  const nome=prompt('Nome da turma:'); if(!nome) return; state.turmas.push({id:uid('turma'),nome}); save(); renderListas();
});
$('#btnAddProf').addEventListener('click',()=>{
  const nome=prompt('Nome do professor:'); if(!nome) return;
  const prof={id:uid('prof'),nome,disciplinas:[],meta:{}};
  // associar disciplinas/turmas/carga
  state.disciplinas.forEach(d=>{state.turmas.forEach(t=>{const h=parseInt(prompt(`Quantas aulas de ${d.nome} o professor ${nome} dará na turma ${t.nome}? (0 se não der)`)); if(h>0){prof.disciplinas.push({discId:d.id,turmaId:t.id}); prof.meta[d.id]={[t.id]:h};}})});
  state.professores.push(prof); save(); renderListas();
});
</script>
</body>
</html>
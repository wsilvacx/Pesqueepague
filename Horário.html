<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Horários Escolares — Persistência Automática</title>
<style>
:root{
  --primary:#1768c6;
  --bg:#f5f7fb;
  --card:#ffffff;
  --muted:#6b7280;
  --success:#16a34a;
  --danger:#ef4444;
  --shadow: 0 8px 22px rgba(23,104,198,0.06);
}
*{box-sizing:border-box}
body{font-family:Inter, "Segoe UI", Roboto, Arial; margin:0;background:var(--bg);color:#0f172a}
header{background:linear-gradient(90deg,var(--primary),#0f5fa8); color:#fff; padding:18px 20px; font-weight:700; box-shadow:0 2px 8px rgba(0,0,0,0.08)}
.container{max-width:1200px;margin:18px auto;padding:0 16px}
.tabs{display:flex;gap:8px;margin:12px 0}
.tab-btn{padding:10px 14px;border-radius:10px;border:1px solid transparent;background:transparent;color:var(--primary);cursor:pointer;font-weight:700}
.tab-btn.active{background:var(--card);box-shadow:var(--shadow);border-color:#e6eef8}
.grid-layout{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:980px){ .grid-layout{grid-template-columns:380px 1fr} }

.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow);border:1px solid #eef2f6}
.row{display:flex;gap:8px;align-items:center}
.row .col{flex:1}
.small-muted{color:var(--muted);font-size:0.95rem}

/* lists */
ul.simple{list-style:none;padding:0;margin:8px 0}
ul.simple li{background:#fbfdff;padding:8px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;border:1px solid #eef6ff}

/* buttons */
.btn{background:var(--primary);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid #e6eef8;color:var(--primary)}
.icon-btn{background:#fff;border:1px solid #e6eef8;padding:6px;border-radius:8px;cursor:pointer}

/* shelf */
.shelf{display:flex;flex-wrap:wrap;gap:10px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px dashed #e6eef8;min-height:110px}
.shelf-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;background:#f7fbff;border-left:4px solid var(--primary);cursor:grab;box-shadow:0 2px 6px rgba(11,65,130,0.04)}
.shelf-item.done{background:#ecfaf0;border-left-color:var(--success);color:#05400a}
.shelf-item .meta{font-size:0.85rem;color:var(--muted)}
.count-bubble{background:#fff;padding:4px 8px;border-radius:999px;border:1px solid #e6eef8;font-weight:700}

/* schedule */
.grid-wrap{overflow:auto}
table.schedule{width:100%;border-collapse:collapse;border-radius:8px;overflow:hidden;background:var(--card);box-shadow:var(--shadow)}
table.schedule thead th{background:var(--primary);color:#fff;padding:10px;font-weight:700;position:sticky;top:0;z-index:2}
table.schedule th, table.schedule td{border:1px solid #eef2f6;padding:8px;text-align:center;min-width:110px;vertical-align:top}
td.slot{background:#fbfdff;min-height:72px;position:relative}
td.slot.drag-over{outline:4px dashed rgba(23,104,198,0.16)}
.lesson{display:block;background:#e8f4ff;border-left:4px solid var(--primary);padding:8px;border-radius:8px;cursor:grab;font-size:13px;word-break:break-word}
.lesson .small{display:block;font-size:12px;color:var(--muted);margin-top:6px}

/* modals */
.modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;padding:20px;z-index:999}
.modal.open{display:flex}
.modal-card{background:var(--card);border-radius:12px;padding:16px;max-width:680px;width:100%;box-shadow:0 10px 30px rgba(2,6,23,0.2)}
.wizard-steps{display:flex;gap:8px;margin:8px 0}
.pill{background:#f1f5f9;padding:6px 10px;border-radius:999px;font-size:13px}

/* helpers */
.flex{display:flex;gap:8px;align-items:center}
.space-between{display:flex;justify-content:space-between;align-items:center}

@media(max-width:720px){
  table.schedule thead th, table.schedule td { min-width:80px; padding:6px; font-size:12px }
  .shelf-item{font-size:12px;padding:6px}
}
.notice-save{font-size:0.9rem;color:var(--muted);margin-left:12px}
</style>
</head>
<body>
<header>Horários Escolares — Persistência Automática</header>

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" id="tabBtnCad">Cadastro</button>
    <button class="tab-btn" id="tabBtnMont">Montar Horário</button>
    <div class="notice-save" id="saveNotice">Dados salvos localmente automaticamente.</div>
  </div>

  <div class="grid-layout">
    <!-- LEFT: Cadastro -->
    <div class="card" id="cardCadastro">
      <div class="space-between">
        <h3 style="margin:0;color:var(--primary)">Cadastro</h3>
        <div class="small-muted">CRUD de Turmas, Disciplinas e Professores</div>
      </div>

      <div style="margin-top:12px" class="row">
        <div class="col"><button class="btn ghost" onclick="openModal('modalTurma')">+ Turma</button></div>
        <div class="col"><button class="btn ghost" onclick="openModal('modalDisciplina')">+ Disciplina</button></div>
        <div class="col"><button class="btn" style="background:linear-gradient(90deg,var(--primary),#0f5fa8)" onclick="openProfessorWizard()">+ Professor</button></div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f6">

      <h4 style="margin:8px 0">Turmas</h4>
      <ul id="listaTurmas" class="simple"></ul>

      <h4 style="margin:8px 0">Disciplinas</h4>
      <ul id="listaDisciplinas" class="simple"></ul>

      <h4 style="margin:8px 0">Professores</h4>
      <ul id="listaProfessores" class="simple small-muted"></ul>
    </div>

    <!-- RIGHT: Montar Horário -->
    <div>
      <div class="card" id="cardMontar" style="display:none">
        <div class="space-between" style="margin-bottom:8px">
          <div>
            <h3 style="margin:0;color:var(--primary)">Montar Horário</h3>
            <div class="small-muted">Selecione a turma e arraste itens da prateleira para a grade.</div>
          </div>
          <div class="small-muted">Duplo-clique na aula para apagar • Arraste para mover</div>
        </div>

        <div class="row" style="margin-bottom:12px">
          <label style="font-weight:700">Turma:</label>
          <select id="selectTurma" style="padding:8px;border-radius:8px;border:1px solid #e6eef8" onchange="resetarGrade()"></select>
          <div style="flex:1"></div>
          <button class="btn ghost" onclick="exportJSON()">Exportar JSON</button>
          <button class="btn ghost" onclick="importExample()">Importar Exemplo</button>
        </div>

        <div style="margin-bottom:12px" class="card" style="padding:12px">
          <div class="shelf" id="shelf"></div>
        </div>

        <div class="grid-wrap card" style="padding:10px">
          <table class="schedule" aria-label="Grade semanal">
            <thead>
              <tr>
                <th>Horário</th>
                <th>Segunda</th>
                <th>Terça</th>
                <th>Quarta</th>
                <th>Quinta</th>
                <th>Sexta</th>
              </tr>
            </thead>
            <tbody id="grade"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modais: Turma, Disciplina, Professor Wizard -->
<!-- Turma -->
<div class="modal" id="modalTurma">
  <div class="modal-card">
    <div class="space-between"><h3 style="margin:0">Turma</h3><button class="btn ghost" onclick="closeModal('modalTurma')">Fechar</button></div>
    <div style="margin-top:10px">
      <label>Nome da turma</label>
      <input type="text" id="inputTurmaName" placeholder="Ex: 6ºA">
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn ghost" onclick="closeModal('modalTurma')">Cancelar</button>
        <button class="btn" onclick="saveTurma()">Salvar</button>
      </div>
    </div>
  </div>
</div>

<!-- Disciplina -->
<div class="modal" id="modalDisciplina">
  <div class="modal-card">
    <div class="space-between"><h3 style="margin:0">Disciplina</h3><button class="btn ghost" onclick="closeModal('modalDisciplina')">Fechar</button></div>
    <div style="margin-top:10px">
      <label>Nome da disciplina</label>
      <input type="text" id="inputDiscName" placeholder="Ex: Matemática">
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn ghost" onclick="closeModal('modalDisciplina')">Cancelar</button>
        <button class="btn" onclick="saveDisciplina()">Salvar</button>
      </div>
    </div>
  </div>
</div>

<!-- Professor Wizard -->
<div class="modal" id="modalProfessor">
  <div class="modal-card">
    <div class="space-between">
      <h3 style="margin:0">Professor</h3>
      <button class="btn ghost" onclick="closeProfessorModal()">Fechar</button>
    </div>

    <div style="margin-top:10px">
      <div class="wizard-steps">
        <div class="pill" id="pill1">1. Dados</div>
        <div class="pill" id="pill2">2. Disciplinas / Meta</div>
        <div class="pill" id="pill3">3. Disponibilidade</div>
      </div>

      <div id="wiz1">
        <label>Nome</label>
        <input type="text" id="inputProfName" placeholder="Ex: João da Silva">
        <div style="margin-top:10px" class="space-between">
          <button class="btn ghost" onclick="closeProfessorModal()">Cancelar</button>
          <button class="btn" onclick="wizardNext()">Próximo</button>
        </div>
      </div>

      <div id="wiz2" style="display:none">
        <label>Disciplinas que leciona</label>
        <div id="profDiscList"></div>
        <div style="margin-top:10px" class="space-between">
          <button class="btn ghost" onclick="wizardPrev()">Voltar</button>
          <button class="btn" onclick="wizardNext()">Próximo</button>
        </div>
      </div>

      <div id="wiz3" style="display:none">
        <label>Disponibilidade (Dias)</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <label><input type="checkbox" class="chkDia" value="Segunda">Seg</label>
          <label><input type="checkbox" class="chkDia" value="Terça">Ter</label>
          <label><input type="checkbox" class="chkDia" value="Quarta">Qua</label>
          <label><input type="checkbox" class="chkDia" value="Quinta">Qui</label>
          <label><input type="checkbox" class="chkDia" value="Sexta">Sex</label>
        </div>
        <div style="margin-top:10px" class="space-between">
          <button class="btn ghost" onclick="wizardPrev()">Voltar</button>
          <button class="btn" onclick="saveProfessorWizard()">Salvar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* --- DADOS --- */
let turmas=[], disciplinas=[], professores=[], horarios=[];
let currentWizardStep = 1;

/* --- UTIL --- */
function uid(){return Date.now()+Math.random().toString(16).slice(2)}
function openModal(id){document.getElementById(id).classList.add('open')}
function closeModal(id){document.getElementById(id).classList.remove('open')}

/* --- CRUD Turma --- */
function saveTurma(){
  const name = document.getElementById('inputTurmaName').value.trim();
  if(!name) return alert('Informe o nome da turma');
  turmas.push({id:uid(), name});
  renderTurmas(); closeModal('modalTurma'); document.getElementById('inputTurmaName').value='';
}
function renderTurmas(){
  const ul = document.getElementById('listaTurmas'); ul.innerHTML='';
  const select = document.getElementById('selectTurma'); select.innerHTML='<option value="">-- Selecione --</option>'
  turmas.forEach(t=>{
    const li = document.createElement('li'); li.textContent=t.name;
    const del = document.createElement('button'); del.textContent='✖'; del.className='icon-btn'; del.onclick=()=>{turmas=turmas.filter(x=>x.id!==t.id);renderTurmas();resetarGrade();}
    li.appendChild(del); ul.appendChild(li)
    const opt = document.createElement('option'); opt.value=t.id; opt.text=t.name; select.appendChild(opt)
  })
}

/* --- CRUD Disciplina --- */
function saveDisciplina(){
  const name = document.getElementById('inputDiscName').value.trim();
  if(!name) return alert('Informe o nome da disciplina');
  disciplinas.push({id:uid(), name}); renderDisciplinas(); closeModal('modalDisciplina'); document.getElementById('inputDiscName').value='';
}
function renderDisciplinas(){
  const ul = document.getElementById('listaDisciplinas'); ul.innerHTML='';
  disciplinas.forEach(d=>{
    const li = document.createElement('li'); li.textContent=d.name;
    const del = document.createElement('button'); del.textContent='✖'; del.className='icon-btn'; del.onclick=()=>{disciplinas=disciplinas.filter(x=>x.id!==d.id);renderDisciplinas();}
    li.appendChild(del); ul.appendChild(li)
  })
}

/* --- CRUD Professores Wizard --- */
function openProfessorWizard(){
  currentWizardStep=1; document.getElementById('wiz1').style.display='block'; document.getElementById('wiz2').style.display='none'; document.getElementById('wiz3').style.display='none';
  document.getElementById('pill1').style.background='#dbeafe'; document.getElementById('pill2').style.background='#f1f5f9'; document.getElementById('pill3').style.background='#f1f5f9';
  document.getElementById('inputProfName').value=''; document.getElementById('profDiscList').innerHTML='';
  document.querySelectorAll('.chkDia').forEach(c=>c.checked=false);
  openModal('modalProfessor');
}
function wizardNext(){
  if(currentWizardStep===1){
    const name = document.getElementById('inputProfName').value.trim();
    if(!name) return alert('Informe o nome do professor');
    // Carrega lista disciplinas com check
    const container = document.getElementById('profDiscList'); container.innerHTML='';
    disciplinas.forEach(d=>{
      const lbl=document.createElement('label'); lbl.style.marginRight='8px';
      const chk = document.createElement('input'); chk.type='checkbox'; chk.value=d.id;
      lbl.appendChild(chk); lbl.appendChild(document.createTextNode(d.name));
      container.appendChild(lbl)
    })
    document.getElementById('wiz1').style.display='none'; document.getElementById('wiz2').style.display='block';
    document.getElementById('pill1').style.background='#f1f5f9'; document.getElementById('pill2').style.background='#dbeafe';
    currentWizardStep=2;
  } else if(currentWizardStep===2){
    document.getElementById('wiz2').style.display='none'; document.getElementById('wiz3').style.display='block';
    document.getElementById('pill2').style.background='#f1f5f9'; document.getElementById('pill3').style.background='#dbeafe';
    currentWizardStep=3;
  }
}
function wizardPrev(){
  if(currentWizardStep===2){
    document.getElementById('wiz2').style.display='none'; document.getElementById('wiz1').style.display='block';
    document.getElementById('pill2').style.background='#dbeafe'; document.getElementById('pill1').style.background='#dbeafe';
    currentWizardStep=1;
  } else if(currentWizardStep===3){
    document.getElementById('wiz3').style.display='none'; document.getElementById('wiz2').style.display='block';
    document.getElementById('pill3').style.background='#f1f5f9'; document.getElementById('pill2').style.background='#dbeafe';
    currentWizardStep=2;
  }
}
function saveProfessorWizard(){
  const name=document.getElementById('inputProfName').value.trim();
  const discIds = Array.from(document.querySelectorAll('#profDiscList input:checked')).map(c=>c.value);
  const dias = Array.from(document.querySelectorAll('.chkDia:checked')).map(c=>c.value);
  if(!name) return alert('Nome obrigatório'); if(discIds.length===0) return alert('Selecione pelo menos uma disciplina'); if(dias.length===0) return alert('Selecione pelo menos um dia');
  const prof={id:uid(), name, disponibilidades:dias, disciplinasMeta: discIds.map(id=>({discId:id,discName:disciplinas.find(d=>d.id===id).name}))}
  professores.push(prof); renderProfessores(); closeProfessorModal();
}
function renderProfessores(){
  const ul=document.getElementById('listaProfessores'); ul.innerHTML='';
  professores.forEach(p=>{
    const li=document.createElement('li'); li.textContent=p.name;
    const del=document.createElement('button'); del.textContent='✖'; del.className='icon-btn';
    del.onclick=()=>{professores=professores.filter(x=>x.id!==p.id);renderProfessores();}
    li.appendChild(del); ul.appendChild(li)
  })
}
function closeProfessorModal(){closeModal('modalProfessor')}

/* --- Grade --- */
const times=['08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00']
function resetarGrade(){
  const tbody=document.getElementById('grade'); tbody.innerHTML='';
  const turmaId = document.getElementById('selectTurma').value;
  times.forEach(t=>{
    const tr=document.createElement('tr'); 
    const tdTime=document.createElement('td'); tdTime.textContent=t; tr.appendChild(tdTime)
    ['Segunda','Terça','Quarta','Quinta','Sexta'].forEach(d=>{
      const td=document.createElement('td'); td.className='slot'; td.dataset.day=d; td.dataset.time=t;
      td.ondragover=e=>e.preventDefault();
      td.ondrop=slotDrop; tr.appendChild(td)
    })
    tbody.appendChild(tr)
  })
  renderGrade()
}
function renderGrade(){
  const turmaId=document.getElementById('selectTurma').value;
  horarios.filter(h=>h.turmaId===turmaId).forEach(h=>{
    const cells=document.querySelectorAll(`td.slot[data-day="${h.dia}"][data-time="${h.inicio}"]`)
    if(cells.length){
      const td=cells[0]; const span=document.createElement('span'); span.className='lesson'; span.draggable=true;
      span.textContent=h.disciplinaName; 
      const small=document.createElement('span'); small.className='small'; small.textContent=h.professorName; span.appendChild(small);
      span.dataset.id=h.id; span.ondragstart=lessonDragStart; span.ondblclick=()=>{horarios=horarios.filter(x=>x.id!==h.id);resetarGrade(); renderShelf(); saveToStorage();}
      td.appendChild(span)
    }
  })
}

/* --- Shelf --- */
function renderShelf(){
  const shelf=document.getElementById('shelf'); shelf.innerHTML='';
  professores.forEach(p=>{
    p.disciplinasMeta.forEach(d=>{
      const count = horarios.filter(h=>h.professorId===p.id && h.disciplinaId===d.discId).length;
      const div=document.createElement('div'); div.className='shelf-item'; div.draggable=true;
      div.dataset.profId=p.id; div.dataset.discId=d.discId; div.dataset.origin='shelf';
      div.innerHTML=`${d.discName} - ${p.name} <span class="count-bubble">${count}</span>`;
      div.ondragstart=lessonDragStart;
      if(count>0) div.classList.add('done');
      shelf.appendChild(div)
    })
  })
}

/* --- Drag & Drop --- */
function lessonDragStart(e){e.dataTransfer.setData('application/json',JSON.stringify(e.currentTarget.dataset))}
function slotDrop(e){
  e.preventDefault(); e.currentTarget.classList.remove('drag-over');
  const payload=JSON.parse(e.dataTransfer.getData('application/json')||'null'); if(!payload) return;
  const day=e.currentTarget.dataset.day; const time=e.currentTarget.dataset.time;
  const turmaId=document.getElementById('selectTurma').value; if(!turmaId){ alert('Selecione a turma'); return; }
  const inicio=time; const fim=minutesToTime(timeToMinutes(time)+60);

  if(payload.origin==='shelf'){
    const prof=professores.find(p=>p.id===payload.profId); if(!prof) return;
    if(!prof.disponibilidades.includes(day)){ alert(`${prof.name} não disponível neste dia`); return; }
    if(professorOcupado(prof.id,day,inicio)){ alert(`${prof.name} já ocupado neste horário`); return; }
    if(horarios.find(h=>h.turmaId===turmaId && h.dia===day && h.inicio===inicio)){ alert('Célula ocupada para esta turma'); return; }
    const discMeta=prof.disciplinasMeta.find(d=>d.discId===payload.discId);
    horarios.push({id:uid(), turmaId, turmaName:turmas.find(t=>t.id===turmaId).name, dia, inicio, fim, disciplinaId:discMeta.discId, disciplinaName:discMeta.discName, professorId:prof.id, professorName:prof.name});
    resetarGrade(); renderShelf(); saveToStorage(); return;
  }

  if(payload.origin==='grade'){
    const lesson=horarios.find(h=>h.id===payload.id); if(!lesson) return;
    const prof=professores.find(p=>p.id===lesson.professorId); if(!prof) return;
    if(!prof.disponibilidades.includes(day)){ alert(`${prof.name} não disponível neste dia`); return; }
    if(professorOcupado(prof.id,day,inicio,lesson.id)){ alert(`${prof.name} já ocupado neste horário`); return; }
    const targetOcc=horarios.find(h=>h.turmaId===turmaId && h.dia===day && h.inicio===inicio && h.id!==lesson.id);
    if(targetOcc){ alert('Célula ocupada'); return; }
    lesson.turmaId=turmaId; lesson.turmaName=turmas.find(t=>t.id===turmaId).name; lesson.dia=day; lesson.inicio=inicio; lesson.fim=fim;
    resetarGrade(); renderShelf(); saveToStorage();
  }
}

/* --- Helpers --- */
function timeToMinutes(t){const [h,m]=t.split(':').map(Number); return h*60+m}
function minutesToTime(m){const h=Math.floor(m/60); const min=m%60; return (h<10?'0':'')+h+':'+(min<10?'0':'')+min}
function professorOcupado(profId,dia,inicio,ignoreId=null){return horarios.some(h=>h.professorId===profId && h.dia===dia && h.inicio===inicio && h.id!==ignoreId)}
function saveToStorage(){localStorage.setItem('horarios',JSON.stringify({turmas,disciplinas,professores,horarios}))}
function loadFromStorage(){const d=JSON.parse(localStorage.getItem('horarios')||'{}'); turmas=d.turmas||[];disciplinas=d.disciplinas||[];professores=d.professores||[];horarios=d.horarios||[];renderTurmas();renderDisciplinas();renderProfessores();renderShelf();resetarGrade()}
loadFromStorage()

/* --- Tabs --- */
document.getElementById('tabBtnCad').onclick=function(){document.getElementById('cardCadastro').style.display='block'; document.getElementById('cardMontar').style.display='none'; this.classList.add('active'); document.getElementById('tabBtnMont').classList.remove('active')}
document.getElementById('tabBtnMont').onclick=function(){document.getElementById('cardCadastro').style.display='none'; document.getElementById('cardMontar').style.display='block'; this.classList.add('active'); document.getElementById('tabBtnCad').classList.remove('active')}

/* --- Export / Import --- */
function exportJSON(){const data={turmas,disciplinas,professores,horarios}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='horarios.json'; a.click();}
function importExample(){const example={turmas:[{id:'1',name:'6ºA'}],disciplinas:[{id:'1',name:'Matemática'}],professores:[{id:'1',name:'João',disponibilidades:['Segunda','Terça'],disciplinasMeta:[{discId:'1',discName:'Matemática'}]}],horarios:[]}; localStorage.setItem('horarios',JSON.stringify(example)); loadFromStorage(); alert('Exemplo importado!')}
</script>
</body>
</html>
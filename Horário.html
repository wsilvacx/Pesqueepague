<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Grade de Horários — Prateleira de Disciplinas</title>
<style>
  :root{--primary:#2463ff;--bg:#f6f8fc;--card:#fff;--ok:#138a36;--warn:#ad6400;--danger:#c0392b}
  body{font-family:Inter,Segoe UI,Roboto,Arial;color:#0f172a;background:var(--bg);margin:0;padding:18px}
  h1,h2{margin:0 0 12px}
  .layout{display:grid;grid-template-columns:320px 1fr;gap:18px}
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(15,30,60,.08)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  button{background:var(--primary);color:#fff;border:none;border-radius:9px;padding:6px 10px;cursor:pointer}
  select,input{padding:6px;border-radius:8px;border:1px solid #e6edf7;background:#fbfdff}
  .list{margin-top:8px;max-height:600px;overflow:auto;padding-top:4px}
  .assign{display:flex;flex-direction:column;gap:2px;padding:6px;border-radius:8px;border:1px solid #e8eefc;background:#f9fbff;cursor:grab}
  .assign .disc{font-weight:700}
  .assign .prof{font-size:12px;color:#556577}
  table.schedule{width:100%;border-collapse:collapse;table-layout:fixed;margin-top:10px}
  table.schedule th,table.schedule td{border:1px solid #e6edf5;padding:6px;text-align:center;vertical-align:middle}
  table.schedule th{background:#f9fbff}
  td.cell{height:68px;position:relative}
  .droptarget{outline:2px dashed #9ab3ff; outline-offset:-4px}
  .muted{color:#63748a;font-size:13px}
  strong{display:block}
</style>
</head>
<body>
<h1>Grade de Horários</h1>
<div class="layout">
  <!-- Prateleira -->
  <div class="card">
    <h2>Disciplinas & Professores</h2>
    <div id="prateleira" class="list">
      <!-- itens serão renderizados aqui -->
    </div>
  </div>

  <!-- Grade de Horários -->
  <div class="card">
    <div class="controls">
      <label>Turma
        <select id="selectTurma"></select>
      </label>
      <label>Períodos
        <select id="periodosCount">
          <option value="4">4</option>
          <option value="5" selected>5</option>
          <option value="6">6</option>
        </select>
      </label>
      <button id="btnRenderGrid">Gerar grade</button>
    </div>
    <div id="gridArea"></div>
  </div>
</div>

<script>
const LS_KEY='horarios_meta_drag_v2';
const DAYS=['Segunda','Terça','Quarta','Quinta','Sexta','Sábado'];
let state={disciplinas:[], turmas:[], professores:[], horarios:{}};

function uid(p='id'){return p+'_'+Math.random().toString(36).slice(2,9)}
function save(){localStorage.setItem(LS_KEY, JSON.stringify(state))}
function load(){try{const raw=localStorage.getItem(LS_KEY); if(raw) state=JSON.parse(raw);}catch(e){}}
load();

const $=s=>document.querySelector(s);
function findDisc(id){return state.disciplinas.find(d=>d.id===id)}
function findTurma(id){return state.turmas.find(t=>t.id===id)}
function findProf(id){return state.professores.find(p=>p.id===id)}

function contarAulas(profId, discId, turmaId){
  let c=0;
  for(const tid in state.horarios){
    const h=state.horarios[tid]; if(!h) continue;
    for(const d of DAYS){
      const arr=h.grid?.[d]||[];
      arr.forEach(cell=>{
        if(cell && cell.professorId===profId && cell.disciplinaId===discId && tid===turmaId) c++;
      });
    }
  }
  return c;
}

function isProfBusy(profId, dia, periodo, ignore){
  for(const tid in state.horarios){
    const h=state.horarios[tid]; if(!h) continue;
    const cell=h.grid?.[dia]?.[periodo]||null;
    if(!cell) continue;
    if(ignore && tid===ignore.turmaId && dia===ignore.dia && periodo===ignore.periodo) continue;
    if(cell.professorId===profId) return true;
  }
  return false;
}

/* ====== Prateleira ====== */
function renderPrateleira(){
  const prateleira = $('#prateleira');
  prateleira.innerHTML = '';
  
  state.disciplinas.forEach(d => {
    const container = document.createElement('div');
    container.style.marginBottom = '10px';
    
    const title = document.createElement('strong');
    title.textContent = d.nome;
    container.appendChild(title);
    
    const profs = state.professores.filter(p => 
      (p.assignments||[]).some(a => a.discId === d.id)
    );
    
    profs.forEach(p => {
      const item = document.createElement('div');
      item.className = 'assign';
      item.draggable = true;
      item.style.marginTop = '4px';
      item.innerHTML = `<div class="disc">${d.nome}</div><div class="prof">${p.nome}</div>`;
      
      item.addEventListener('dragstart', ev => {
        ev.dataTransfer.setData('text/plain', JSON.stringify({profId: p.id, discId: d.id}));
        ev.dataTransfer.effectAllowed = 'copy';
      });
      
      container.appendChild(item);
    });
    
    prateleira.appendChild(container);
  });
}

/* ====== Grade ====== */
function refreshSelectTurma(){
  const sel=$('#selectTurma'); sel.innerHTML='';
  if(state.turmas.length===0){ sel.innerHTML='<option value="">(Cadastre turmas)</option>'; return; }
  state.turmas.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.nome; sel.appendChild(o); });
}

function ensureHorario(turmaId,periodos){
  if(!state.horarios[turmaId]){
    const grid={}; DAYS.forEach(d=>grid[d]=Array(periodos).fill(null));
    state.horarios[turmaId]={periodos,grid}; save();
  }else if(state.horarios[turmaId].periodos!==periodos){
    const old=state.horarios[turmaId]; const grid={};
    DAYS.forEach(d=>{
      const arr=old.grid[d]||[];
      grid[d]=Array.from({length:periodos},(_,i)=>arr[i]||null);
    });
    state.horarios[turmaId]={periodos,grid}; save();
  }
}

function renderGrid(turmaId){
  const area=$('#gridArea'); area.innerHTML='';
  const h=state.horarios[turmaId]; if(!h){area.innerHTML='<div class="muted">Gerar a grade.</div>'; return;}
  const table=document.createElement('table'); table.className='schedule';
  const thead=document.createElement('thead'); const trh=document.createElement('tr');
  trh.innerHTML='<th>Período \\ Dia</th>'+DAYS.map(d=>`<th>${d}</th>`).join(''); thead.appendChild(trh); table.appendChild(thead);
  const tbody=document.createElement('tbody');
  for(let p=0;p<h.periodos;p++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<th>Período ${p+1}</th>`;
    DAYS.forEach(d=>{
      const td=document.createElement('td'); td.className='cell'; td.dataset.turma=turmaId; td.dataset.dia=d; td.dataset.periodo=String(p);
      const cell=h.grid[d][p];
      if(cell){
        const prof=findProf(cell.professorId)?.nome||'—';
        const disc=findDisc(cell.disciplinaId)?.nome||'—';
        const box=document.createElement('div'); box.className='assign'; box.draggable=true;
        box.innerHTML=`<div class="disc">${disc}</div><div class="prof">${prof}</div>`;
        box.addEventListener('dragstart',(ev)=>{
          ev.dataTransfer.setData('text/plain', JSON.stringify({from:{turmaId, dia:d, periodo:p}, cell}));
          ev.dataTransfer.effectAllowed='copyMove';
        });
        td.appendChild(box);
      }else td.innerHTML='<div class="muted">—</div>';
      
      td.addEventListener('dragover',(ev)=>{ev.preventDefault(); td.classList.add('droptarget');});
      td.addEventListener('dragleave',()=>td.classList.remove('droptarget'));
      td.addEventListener('drop',(ev)=>{td.classList.remove('droptarget'); handleDrop(td, ev);});
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
  table.appendChild(tbody); area.appendChild(table);
}

/* ====== Drop Handler ====== */
function handleDrop(targetTd, ev){
  ev.preventDefault();
  targetTd.classList.remove('droptarget');
  const payload = JSON.parse(ev.dataTransfer.getData('text/plain')||'{}');
  const dst = {turmaId: targetTd.dataset.turma, dia: targetTd.dataset.dia, periodo: parseInt(targetTd.dataset.periodo,10)};
  const dstExisting = state.horarios[dst.turmaId]?.grid[dst.dia]?.[dst.periodo] || null;

  // prateleira
  if(payload.profId && payload.discId){
    if(dstExisting){ alert('Célula já ocupada!'); return; }
    if(!canPlace(payload.profId, payload.discId, dst.turmaId, dst.dia, dst.periodo, null)) return;
    state.horarios[dst.turmaId].grid[dst.dia][dst.periodo] = {professorId: payload.profId, disciplinaId: payload.discId};
    save(); renderGrid($('#selectTurma').value); return;
  }

  // mover/copy antigo
  if(!payload.from || !payload.cell) return;
  const src = payload.from; const srcCell = payload.cell;
  const copyMode = ev.ctrlKey || ev.metaKey;
  if(src.turmaId===dst.turmaId && src.dia===dst.dia && src.periodo===dst.periodo) return;

  if(copyMode){
    if(dstExisting){ alert('Para copiar, escolha célula vazia.'); return; }
    if(!canPlace(srcCell.professorId, srcCell.disciplinaId, dst.turmaId, dst.dia, dst.periodo, null)) return;
    state.horarios[dst.turmaId].grid[dst.dia][dst.periodo] = {...srcCell};
  }else{
    if(dstExisting){
      const Aok = canPlace(srcCell.professorId, srcCell.disciplinaId, dst.turmaId, dst.dia, dst.periodo, {turmaId:src.turmaId,dia:src.dia,periodo:src.periodo});
      const Bok = canPlace(dstExisting.professorId, dstExisting.disciplinaId, src.turmaId, src.dia, src.periodo, {turmaId:dst.turmaId,dia:dst.dia,periodo:dst.periodo});
      if(!Aok || !Bok) return;
      state.horarios[dst.turmaId].grid[dst.dia][dst.periodo]=srcCell;
      state.horarios[src.turmaId].grid[src.dia][src.periodo]=dstExisting;
    }else{
      if(!canPlace(srcCell.professorId, srcCell.disciplinaId, dst.turmaId, dst.dia, dst.periodo, {turmaId:src.turmaId,dia:src.dia,periodo:src.periodo})) return;
      state.horarios[dst.turmaId].grid[dst.dia][dst.periodo]=srcCell;
      state.horarios[src.turmaId].grid[src.dia][src.periodo]=null;
    }
  }
  save(); renderGrid($('#selectTurma').value);
}

/* ====== Validação ====== */
function canPlace(profId,discId,turmaId,dia,periodo,ignore){
  const maxAulas=contarAulas(profId,discId,turmaId);
  if(isProfBusy(profId,dia,periodo,ignore)){ alert('Professor já ocupado nesse horário!'); return false;}
  if(maxAulas>=99){alert('Atingida carga máxima'); return false;} // ajuste carga real se desejar
  return true;
}

/* ====== Inicialização ====== */
function init(){
  refreshSelectTurma();
  renderPrateleira();
  const tid = $('#selectTurma').value;
  if(tid){ensureHorario(tid, parseInt($('#periodosCount').value,10)); renderGrid(tid);}
}
$('#btnRenderGrid').addEventListener('click',()=>{const tid=$('#selectTurma').value; ensureHorario(tid, parseInt($('#periodosCount').value,10)); renderGrid(tid);});
$('#selectTurma').addEventListener('change',()=>{const tid=$('#selectTurma').value; renderGrid(tid);});
init();
</script>
</body>
</html>
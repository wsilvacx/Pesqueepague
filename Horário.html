<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Horários Escolares</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .tab { display: none; }
  .tab.active { display: block; }
  button { margin: 5px; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #000; padding: 5px; text-align: center; min-width: 120px; height: 70px; vertical-align: top; }
  .modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
  }
  .modal-content {
    background: #fff; padding: 20px; border-radius: 5px; width: 400px;
  }
  .wizard-step { display: none; }
  .wizard-step.active { display: block; }
  .prateleira { margin: 15px 0; padding: 10px; border: 1px solid #aaa; min-height: 100px; display: flex; flex-wrap: wrap; gap: 10px; }
  .item { padding: 6px; border: 1px solid #000; cursor: grab; background: #f0f0f0; border-radius: 4px; font-size: 13px; }
  .item.verde { background: #4caf50; color: white; }
  td.dropzone { background: #fafafa; }
  .aula { background: #d9edf7; border: 1px solid #31708f; border-radius: 4px; padding: 4px; font-size: 12px; cursor: grab; }
</style>
</head>
<body>

<h1>Sistema de Horários Escolares</h1>

<!-- Abas -->
<button onclick="showTab('cadastro')">Cadastro</button>
<button onclick="showTab('montar')">Montar Horário</button>

<!-- Aba Cadastro -->
<div id="cadastro" class="tab active">
  <h2>Cadastro</h2>
  <button onclick="openModal('modalTurma')">Cadastrar Turma</button>
  <button onclick="openModal('modalDisciplina')">Cadastrar Disciplina</button>
  <button onclick="openModal('modalProfessor')">Cadastrar Professor</button>

  <h3>Turmas</h3>
  <ul id="listaTurmas"></ul>
  <h3>Disciplinas</h3>
  <ul id="listaDisciplinas"></ul>
  <h3>Professores</h3>
  <ul id="listaProfessores"></ul>
</div>

<!-- Aba Montar Horário -->
<div id="montar" class="tab">
  <h2>Montar Horário</h2>

  <label>Selecionar Turma:</label>
  <select id="turmaSelecionada" onchange="resetarGrade()"></select>

  <h3>Prateleira de Aulas</h3>
  <div id="prateleira" class="prateleira"></div>

  <h3>Grade Semanal</h3>
  <table>
    <thead>
      <tr>
        <th>Horário</th>
        <th>Segunda</th>
        <th>Terça</th>
        <th>Quarta</th>
        <th>Quinta</th>
        <th>Sexta</th>
      </tr>
    </thead>
    <tbody id="grade"></tbody>
  </table>
</div>

<!-- MODAL TURMA -->
<div id="modalTurma" class="modal">
  <div class="modal-content">
    <h3>Cadastrar Turma</h3>
    <input type="text" id="nomeTurma" placeholder="Nome da Turma">
    <br><br>
    <button onclick="cadastrarTurma()">Salvar</button>
    <button onclick="closeModal('modalTurma')">Cancelar</button>
  </div>
</div>

<!-- MODAL DISCIPLINA -->
<div id="modalDisciplina" class="modal">
  <div class="modal-content">
    <h3>Cadastrar Disciplina</h3>
    <input type="text" id="nomeDisciplina" placeholder="Nome da Disciplina">
    <br><br>
    <button onclick="cadastrarDisciplina()">Salvar</button>
    <button onclick="closeModal('modalDisciplina')">Cancelar</button>
  </div>
</div>

<!-- MODAL PROFESSOR (WIZARD) -->
<div id="modalProfessor" class="modal">
  <div class="modal-content">
    <h3>Cadastrar Professor</h3>

    <div id="step1" class="wizard-step active">
      <label>Nome:</label><br>
      <input type="text" id="nomeProfessor"><br><br>
      <button onclick="nextStep(2)">Próximo</button>
    </div>

    <div id="step2" class="wizard-step">
      <label>Disciplinas:</label><br>
      <select id="disciplinasProfessor" multiple></select><br><br>
      <label>Meta de aulas:</label><br>
      <input type="number" id="metaAulas"><br><br>
      <button onclick="prevStep(1)">Voltar</button>
      <button onclick="nextStep(3)">Próximo</button>
    </div>

    <div id="step3" class="wizard-step">
      <label>Disponibilidade (dias):</label><br>
      <label><input type="checkbox" value="Segunda">Segunda</label>
      <label><input type="checkbox" value="Terça">Terça</label>
      <label><input type="checkbox" value="Quarta">Quarta</label>
      <label><input type="checkbox" value="Quinta">Quinta</label>
      <label><input type="checkbox" value="Sexta">Sexta</label><br><br>
      <button onclick="prevStep(2)">Voltar</button>
      <button onclick="finalizarProfessor()">Finalizar</button>
    </div>
  </div>
</div>

<script>
  let turmas = [];
  let disciplinas = [];
  let professores = [];
  let horarios = []; // {professor, disciplina, dia, hora, turma}

  function showTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    if(tab === 'montar') {
      atualizarPrateleira();
      atualizarTurmasSelect();
    }
  }

  function openModal(id) { document.getElementById(id).style.display = 'flex'; }
  function closeModal(id) { document.getElementById(id).style.display = 'none'; }

  function cadastrarTurma() {
    const nome = document.getElementById('nomeTurma').value.trim();
    if(nome && !turmas.includes(nome)) {
      turmas.push(nome);
      document.getElementById('listaTurmas').innerHTML += `<li>${nome}</li>`;
      document.getElementById('nomeTurma').value = '';
      closeModal('modalTurma');
      atualizarTurmasSelect();
    }
  }

  function cadastrarDisciplina() {
    const nome = document.getElementById('nomeDisciplina').value.trim();
    if(nome && !disciplinas.includes(nome)) {
      disciplinas.push(nome);
      document.getElementById('listaDisciplinas').innerHTML += `<li>${nome}</li>`;
      document.getElementById('nomeDisciplina').value = '';
      closeModal('modalDisciplina');
      atualizarSelecoes();
    }
  }

  function nextStep(n) {
    document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
    document.getElementById('step'+n).classList.add('active');
  }
  function prevStep(n) { nextStep(n); }

  function finalizarProfessor() {
    const nome = document.getElementById('nomeProfessor').value.trim();
    const selDisciplinas = Array.from(document.getElementById('disciplinasProfessor').selectedOptions).map(o => o.value);
    const meta = parseInt(document.getElementById('metaAulas').value);
    const disponibilidade = Array.from(document.querySelectorAll('#step3 input[type=checkbox]:checked')).map(c => c.value);

    if(nome && selDisciplinas.length && meta > 0 && disponibilidade.length) {
      professores.push({ nome, disciplinas: selDisciplinas, metaAulas: meta, disponibilidade, aulasDadas: 0 });
      document.getElementById('listaProfessores').innerHTML += `<li>${nome} - ${selDisciplinas.join(', ')} (Meta: ${meta})</li>`;
      closeModal('modalProfessor');
      atualizarSelecoes();
    } else {
      alert('Preencha todos os campos!');
    }
  }

  function atualizarSelecoes() {
    const disciplinasProfessor = document.getElementById('disciplinasProfessor');
    disciplinasProfessor.innerHTML = disciplinas.map(d => `<option value="${d}">${d}</option>`).join('');
  }

  function atualizarTurmasSelect() {
    const select = document.getElementById('turmaSelecionada');
    select.innerHTML = turmas.map(t => `<option value="${t}">${t}</option>`).join('');
    resetarGrade();
  }

  const horariosBase = ["07:00","08:00","09:00","10:00","11:00","12:00"];
  const dias = ["Segunda","Terça","Quarta","Quinta","Sexta"];

  function resetarGrade() {
    const grade = document.getElementById('grade');
    grade.innerHTML = "";
    horariosBase.forEach(hora => {
      let row = `<tr><td>${hora}</td>`;
      dias.forEach(d => row += `<td class="dropzone" data-dia="${d}" data-hora="${hora}" ondrop="drop(event)" ondragover="allowDrop(event)"></td>`);
      row += "</tr>";
      grade.innerHTML += row;
    });

    const turma = document.getElementById('turmaSelecionada').value;
    horarios.filter(h => h.turma === turma).forEach(h => {
      const cell = [...document.querySelectorAll('.dropzone')]
        .find(c => c.dataset.dia === h.dia && c.dataset.hora === h.hora);
      if(cell) addAulaToCell(cell, h);
    });
  }

  function atualizarPrateleira() {
    const prateleira = document.getElementById('prateleira');
    prateleira.innerHTML = "";
    professores.forEach(p => {
      p.disciplinas.forEach(d => {
        const item = document.createElement('div');
        item.className = "item" + (p.aulasDadas >= p.metaAulas ? " verde" : "");
        item.innerText = `${d} (${p.nome})`;
        item.draggable = true;
        item.dataset.professor = p.nome;
        item.dataset.disciplina = d;
        item.addEventListener('dragstart', drag);
        prateleira.appendChild(item);
      });
    });
  }

  function allowDrop(ev) { ev.preventDefault(); }
  function drag(ev) {
    ev.dataTransfer.setData("text", JSON.stringify({
      professor: ev.target.dataset.professor,
      disciplina: ev.target.dataset.disciplina,
      origem: ev.target.dataset.origem || "prateleira",
      dia: ev.target.dataset.dia,
      hora: ev.target.dataset.hora
    }));
  }

  function drop(ev) {
    ev.preventDefault();
    const data = JSON.parse(ev.dataTransfer.getData("text"));
    const dia = ev.target.dataset.dia;
    const hora = ev.target.dataset.hora;
    const turma = document.getElementById('turmaSelecionada').value;

    const prof = professores.find(p => p.nome === data.professor);

    if(!prof.disponibilidade.includes(dia)) {
      alert("Professor não disponível neste dia!");
      return;
    }

    const conflito = horarios.find(h => h.professor === data.professor && h.dia === dia && h.hora === hora);
    if(conflito && (data.origem !== "grade" || conflito.turma !== turma)) {
      alert(`Conflito: ${data.professor} já está em outra turma neste horário.`);
      return;
    }

    // Se a origem for grade, remover do horário anterior
    if(data.origem === "grade") {
      horarios = horarios.filter(h => !(h.professor === data.professor && h.disciplina === data.disciplina && h.dia === data.dia && h.hora === data.hora && h.turma === turma));
      resetarGrade();
    } else {
      prof.aulasDadas++;
    }

    horarios.push({ professor: data.professor, disciplina: data.disciplina, dia, hora, turma });
    const cell = ev.target.closest(".dropzone");
    addAulaToCell(cell, { professor: data.professor, disciplina: data.disciplina, dia, hora, turma });
    atualizarPrateleira();
  }

  function addAulaToCell(cell, h) {
    const aulaDiv = document.createElement("div");
    aulaDiv.className = "aula";
    aulaDiv.innerText = `${h.disciplina}\n${h.professor}`;
    aulaDiv.draggable = true;
    aulaDiv.dataset.professor = h.professor;
    aulaDiv.dataset.disciplina = h.disciplina;
    aulaDiv.dataset.origem = "grade";
    aulaDiv.dataset.dia = h.dia;
    aulaDiv.dataset.hora = h.hora;

    aulaDiv.addEventListener("dragstart", drag);
    aulaDiv.addEventListener("dblclick", () => {
      if(confirm("Remover esta aula?")) {
        horarios = horarios.filter(x => !(x.professor === h.professor && x.disciplina === h.disciplina && x.dia === h.dia && x.hora === h.hora && x.turma === h.turma));
        const prof = professores.find(p => p.nome === h.professor);
        if(prof) prof.aulasDadas--;
        resetarGrade();
        atualizarPrateleira();
      }
    });

    cell.innerHTML = "";
    cell.appendChild(aulaDiv);
  }
</script>

</body>
</html>
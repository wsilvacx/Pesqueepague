<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sistema de Horários — metas por disciplina × turma</title>
<style>
  :root{--primary:#2463ff;--bg:#f6f8fc;--card:#fff;--ok:#138a36;--warn:#ad6400;--danger:#c0392b}
  body{font-family:Inter,Segoe UI,Roboto,Arial;color:#0f172a;background:var(--bg);margin:0;padding:18px}
  h1{margin:0 0 12px}
  .layout{display:grid;grid-template-columns:1fr 420px;gap:18px}
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(15,30,60,.08)}
  .muted{color:#63748a;font-size:13px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{background:var(--primary);color:#fff;border:none;border-radius:9px;padding:8px 10px;cursor:pointer}
  button.ghost{background:#fff;color:var(--primary);border:1px solid #dfe8ff}
  button.bad{background:#ffe8e6;color:var(--danger)}
  input,select{width:100%;padding:8px;border:1px solid #e6edf7;border-radius:9px;background:#fbfdff}
  .list{margin-top:8px;max-height:260px;overflow:auto;border-top:1px dashed #e8eefc;padding-top:8px}
  .item{display:flex;justify-content:space-between;align-items:flex-start;padding:8px 0;border-bottom:1px solid #f1f4fb;gap:8px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #e9f1ff;background:#f7faff;font-size:12px}
  .ok{color:var(--ok);font-weight:700}
  .gray{color:#9aa6b2}
  .list-mini{margin-top:4px;display:flex;flex-direction:column;gap:4px}
  .mini-row{display:flex;gap:6px;align-items:center;font-size:13px}
  .mini-row .status{margin-left:auto}
  table.schedule{width:100%;border-collapse:collapse;margin-top:10px;table-layout:fixed}
  table.schedule th,table.schedule td{border:1px solid #e6edf5;padding:6px;text-align:center}
  table.schedule th{background:#f9fbff}
  td.cell{height:68px;vertical-align:middle;position:relative}
  .assign{display:flex;flex-direction:column;gap:2px;padding:6px;border-radius:8px;border:1px solid #e8eefc;background:#f9fbff;cursor:grab}
  .assign .disc{font-weight:700}
  .assign .prof{font-size:12px;color:#556577}
  .droptarget{outline:2px dashed #9ab3ff; outline-offset:-4px}
  .modal{display:none;position:fixed;inset:0;background:rgba(6,12,30,.45);z-index:1000;justify-content:center;align-items:center}
  .modal.show{display:flex}
  .modal-card{width:720px;max-width:96%;background:#fff;border-radius:12px;padding:14px;box-shadow:0 14px 60px rgba(10,20,40,.18)}
  .modal-sm{width:460px;max-width:94%}
  .close{float:right;cursor:pointer;color:#c0392b;font-weight:800}
  .wizard-steps{display:flex;gap:8px;margin-bottom:10px}
  .step{padding:6px 8px;border-radius:8px;background:#eff5ff;font-weight:700}
  .disc-item{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid #eef2fb;border-radius:8px;cursor:grab}
  .disc-item.disabled{opacity:.55;cursor:not-allowed;}
  .danger{background:#ffecec;color:var(--danger)}
  .togglecopy{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px dashed #c9d6ff;background:#f4f7ff;font-size:12px}
  .shelf{background:#f4f6fc;border:1px solid #e6edf7;border-radius:12px;padding:8px;max-height:480px;overflow:auto}
</style>
</head>
<body>
<h1>Sistema de Horários — montagem de horários</h1>
<div class="layout">

  <!-- GRADE + PRATELEIRA -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Grade de horários</h2>
      <div class="controls">
        <label class="muted" style="display:flex;gap:8px;align-items:center">Períodos
          <select id="periodosCount">
            <option value="4">4</option><option value="5" selected>5</option><option value="6">6</option>
          </select>
        </label>
        <label class="togglecopy"><input type="checkbox" id="toggleCopy"> Copiar ao arrastar</label>
        <button id="btnRenderGrid">Gerar grade</button>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:flex-start;margin-top:12px">
      <!-- Grade -->
      <div style="flex:1" id="gridArea"></div>

      <!-- Prateleira -->
      <div class="shelf">
        <h3>Prateleira: Disciplinas × Professores</h3>
        <div id="shelfItems" style="display:flex;flex-direction:column;gap:6px"></div>
      </div>
    </div>
  </div>

  <!-- CADASTROS -->
  <div class="card">
    <h2>Cadastros</h2>
    <div class="controls" style="margin-bottom:8px">
      <button id="btnAddDisc">+ Disciplina</button>
      <button id="btnAddTurma">+ Turma</button>
      <button id="btnAddProf">+ Professor</button>
    </div>
    <h3>Disciplinas</h3>
    <div id="listaDisciplinas" class="list muted">Nenhuma disciplina.</div>
    <h3>Turmas</h3>
    <div id="listaTurmas" class="list muted">Nenhuma turma.</div>
    <h3>Professores</h3>
    <div id="listaProfessores" class="list muted">Nenhum professor.</div>

    <div class="controls" style="margin-top:10px">
      <button id="btnExport">Exportar JSON</button>
      <label class="pill" style="cursor:pointer">Importar JSON
        <input id="importFile" type="file" accept="application/json" style="display:none"/>
      </label>
      <button id="btnClearAll" class="ghost">Apagar tudo</button>
    </div>
  </div>

</div>

<script>
/* ====== STATE ====== */
const LS_KEY='horarios_meta_drag_v2';
const DAYS=['Segunda','Terça','Quarta','Quinta','Sexta','Sábado'];
let state={disciplinas:[], turmas:[], professores:[], horarios:{}};
function uid(p='id'){return p+'_'+Math.random().toString(36).slice(2,9)}
function save(){localStorage.setItem(LS_KEY, JSON.stringify(state))}
function load(){try{const raw=localStorage.getItem(LS_KEY); if(raw) state=JSON.parse(raw);}catch(e){}}
load();

/* ====== UTIL ====== */
const $=s=>document.querySelector(s);
function findDisc(id){return state.disciplinas.find(d=>d.id===id)}
function findTurma(id){return state.turmas.find(t=>t.id===id)}
function findProf(id){return state.professores.find(p=>p.id===id)}
function contarAulas(profId, discId, turmaId){
  let c=0;
  for(const tid in state.horarios){
    const h=state.horarios[tid]; if(!h) continue;
    for(const d of DAYS){ (h.grid?.[d]||[]).forEach(cell=>{if(cell && cell.professorId===profId && cell.disciplinaId===discId && tid===turmaId) c++})}
  }
  return c;
}
function isProfBusy(profId, dia, periodo, ignore){
  for(const tid in state.horarios){
    const h=state.horarios[tid]; if(!h) continue;
    const cell=h.grid?.[dia]?.[periodo]||null;
    if(!cell) continue;
    if(ignore && tid===ignore.turmaId && dia===ignore.dia && periodo===ignore.periodo) continue;
    if(cell.professorId===profId) return true;
  }
  return false;
}

/* ====== RENDER GRADE ====== */
function ensureHorario(turmaId,periodos){
  if(!state.horarios[turmaId]){
    const grid={}; DAYS.forEach(d=>grid[d]=Array(periodos).fill(null));
    state.horarios[turmaId]={periodos,grid}; save();
  } else if(state.horarios[turmaId].periodos!==periodos){
    const old=state.horarios[turmaId]; const grid={};
    DAYS.forEach(d=>grid[d]=Array.from({length:periodos},(_,i)=>old.grid[d][i]||null));
    state.horarios[turmaId]={periodos,grid}; save();
  }
}
function renderGrid(turmaId){
  const area=$('#gridArea'); area.innerHTML='';
  const h=state.horarios[turmaId]; if(!h){area.innerHTML='<div class="muted">Gerar a grade.</div>'; return;}
  const table=document.createElement('table'); table.className='schedule';
  const thead=document.createElement('thead'); const trh=document.createElement('tr');
  trh.innerHTML='<th>Período \\ Dia</th>'+DAYS.map(d=>`<th>${d}</th>`).join(''); thead.appendChild(trh); table.appendChild(thead);
  const tbody=document.createElement('tbody');
  for(let p=0;p<h.periodos;p++){
    const tr=document.createElement('tr'); tr.innerHTML=`<th>Período ${p+1}</th>`;
    DAYS.forEach(d=>{
      const td=document.createElement('td'); td.className='cell'; td.dataset.turma=turmaId; td.dataset.dia=d; td.dataset.periodo=p;
      const cell=h.grid[d][p];
      if(cell){
        const prof=findProf(cell.professorId)?.nome||'—';
        const disc=findDisc(cell.disciplinaId)?.nome||'—';
        const box=document.createElement('div'); box.className='assign'; box.draggable=true;
        box.innerHTML=`<div class="disc">${disc}</div><div class="prof">${prof}</div>`;
        box.addEventListener('dragstart', ev=>{ ev.dataTransfer.setData('text/plain', JSON.stringify({from:{turmaId,dia,period:p}, cell})); ev.dataTransfer.effectAllowed='copyMove'; });
        td.appendChild(box);
      } else td.innerHTML='<div class="muted">—</div>';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
  table.appendChild(tbody); area.appendChild(table);
}

/* ====== PRATELEIRA ====== */
function renderPrateleira(){
  const wrap=$('#shelfItems'); wrap.innerHTML='';
  state.professores.forEach(p=>{
    (p.assignments||[]).forEach(a=>{
      const disc=findDisc(a.discId)?.nome||'—'; const turma=findTurma(a.turmaId)?.nome||'—';
      const div=document.createElement('div'); div.className='disc-item'; div.draggable=true;
      div.innerHTML=`<strong>${disc}</strong> — <span>${p.nome}</span>`;
      div.addEventListener('dragstart', ev=>{ ev.dataTransfer.setData('text/plain', JSON.stringify({from:'shelf',profId:p.id,discId:a.discId})); ev.dataTransfer.effectAllowed='copy'; });
      wrap.appendChild(div);
    });
  });
}

/* ====== INIT ====== */
function refreshSelectTurma(){
  const sel=$('#selectTurma'); if(!sel) return;
  sel.innerHTML=''; state.turmas.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.nome; sel.appendChild(o);});
}
function init(){
  refreshSelectTurma(); renderPrateleira();
  const tid=$('#selectTurma')?.value; if(tid){ensureHorario(tid, parseInt($('#periodosCount').value,10)); renderGrid(tid);}
}
$('#btnRenderGrid').addEventListener('click',()=>{ const tid=$('#selectTurma').value; ensureHorario(tid, parseInt($('#periodosCount').value,10)); renderGrid(tid); });
init();
</script>
</body>
</html>
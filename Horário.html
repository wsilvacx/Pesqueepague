<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Horários Escolares — Persistência local</title>
<style>
:root{
  --primary:#1768c6;
  --bg:#f5f7fb;
  --card:#ffffff;
  --muted:#6b7280;
  --success:#16a34a;
  --danger:#ef4444;
  --shadow: 0 8px 22px rgba(23,104,198,0.06);
}
*{box-sizing:border-box}
body{font-family:Inter, "Segoe UI", Roboto, Arial; margin:0;background:var(--bg);color:#0f172a}
header{background:linear-gradient(90deg,var(--primary),#0f5fa8); color:#fff; padding:18px 20px; font-weight:700; box-shadow:0 2px 8px rgba(0,0,0,0.08)}
.container{max-width:1200px;margin:18px auto;padding:0 16px}
.tabs{display:flex;gap:8px;margin:12px 0}
.tab-btn{padding:10px 14px;border-radius:10px;border:1px solid transparent;background:transparent;color:var(--primary);cursor:pointer;font-weight:700}
.tab-btn.active{background:var(--card);box-shadow:var(--shadow);border-color:#e6eef8}
.grid-layout{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:980px){ .grid-layout{grid-template-columns:380px 1fr} }

.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow);border:1px solid #eef2f6}
.row{display:flex;gap:8px;align-items:center}
.row .col{flex:1}
.small-muted{color:var(--muted);font-size:0.95rem}

/* lists */
ul.simple{list-style:none;padding:0;margin:8px 0}
ul.simple li{background:#fbfdff;padding:8px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;border:1px solid #eef6ff}

/* buttons */
.btn{background:var(--primary);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid #e6eef8;color:var(--primary)}
.icon-btn{background:#fff;border:1px solid #e6eef8;padding:6px;border-radius:8px;cursor:pointer}

/* shelf */
.shelf{display:flex;flex-wrap:wrap;gap:10px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px dashed #e6eef8;min-height:110px}
.shelf-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;background:#f7fbff;border-left:4px solid var(--primary);cursor:grab;box-shadow:0 2px 6px rgba(11,65,130,0.04)}
.shelf-item.done{background:#ecfaf0;border-left-color:var(--success);color:#05400a}
.shelf-item .meta{font-size:0.85rem;color:var(--muted)}
.count-bubble{background:#fff;padding:4px 8px;border-radius:999px;border:1px solid #e6eef8;font-weight:700}

/* schedule */
.grid-wrap{overflow:auto}
table.schedule{width:100%;border-collapse:collapse;border-radius:8px;overflow:hidden;background:var(--card);box-shadow:var(--shadow)}
table.schedule thead th{background:var(--primary);color:#fff;padding:10px;font-weight:700;position:sticky;top:0;z-index:2}
table.schedule th, table.schedule td{border:1px solid #eef2f6;padding:8px;text-align:center;min-width:110px;vertical-align:top}
td.slot{background:#fbfdff;min-height:72px;position:relative}
td.slot.drag-over{outline:4px dashed rgba(23,104,198,0.16)}
.lesson{display:block;background:#e8f4ff;border-left:4px solid var(--primary);padding:8px;border-radius:8px;cursor:grab;font-size:13px;word-break:break-word}
.lesson .small{display:block;font-size:12px;color:var(--muted);margin-top:6px}

/* modals */
.modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;padding:20px;z-index:999}
.modal.open{display:flex}
.modal-card{background:var(--card);border-radius:12px;padding:16px;max-width:680px;width:100%;box-shadow:0 10px 30px rgba(2,6,23,0.2)}
.wizard-steps{display:flex;gap:8px;margin:8px 0}
.pill{background:#f1f5f9;padding:6px 10px;border-radius:999px;font-size:13px}

/* helpers */
.flex{display:flex;gap:8px;align-items:center}
.space-between{display:flex;justify-content:space-between;align-items:center}

@media(max-width:720px){
  table.schedule thead th, table.schedule td { min-width:80px; padding:6px; font-size:12px }
  .shelf-item{font-size:12px;padding:6px}
}
.notice-save{font-size:0.9rem;color:var(--muted);margin-left:12px}
</style>
</head>
<body>
<header>Horários Escolares — Persistência Automática</header>

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" id="tabBtnCad">Cadastro</button>
    <button class="tab-btn" id="tabBtnMont">Montar Horário</button>
    <div class="notice-save" id="saveNotice">Dados salvos localmente automaticamente.</div>
  </div>

  <div class="grid-layout">
    <!-- LEFT: Cadastro -->
    <div class="card" id="cardCadastro">
      <div class="space-between">
        <h3 style="margin:0;color:var(--primary)">Cadastro</h3>
        <div class="small-muted">CRUD de Turmas, Disciplinas e Professores</div>
      </div>

      <div style="margin-top:12px" class="row">
        <div class="col"><button class="btn ghost" onclick="openModal('modalTurma')">+ Turma</button></div>
        <div class="col"><button class="btn ghost" onclick="openModal('modalDisciplina')">+ Disciplina</button></div>
        <div class="col"><button class="btn" style="background:linear-gradient(90deg,var(--primary),#0f5fa8)" onclick="openProfessorWizard()">+ Professor</button></div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f6">

      <h4 style="margin:8px 0">Turmas</h4>
      <ul id="listaTurmas" class="simple"></ul>

      <h4 style="margin:8px 0">Disciplinas</h4>
      <ul id="listaDisciplinas" class="simple"></ul>

      <h4 style="margin:8px 0">Professores</h4>
      <ul id="listaProfessores" class="simple small-muted"></ul>
    </div>

    <!-- RIGHT: Montar Horário -->
    <div>
      <div class="card" id="cardMontar" style="display:none">
        <div class="space-between" style="margin-bottom:8px">
          <div>
            <h3 style="margin:0;color:var(--primary)">Montar Horário</h3>
            <div class="small-muted">Selecione a turma e arraste itens da prateleira para a grade.</div>
          </div>
          <div class="small-muted">Duplo-clique na aula para apagar • Arraste para mover</div>
        </div>

        <div class="row" style="margin-bottom:12px">
          <label style="font-weight:700">Turma:</label>
          <select id="selectTurma" style="padding:8px;border-radius:8px;border:1px solid #e6eef8" onchange="resetarGrade()"></select>
          <div style="flex:1"></div>
          <button class="btn ghost" onclick="exportJSON()">Exportar JSON</button>
          <button class="btn ghost" onclick="importExample()">Importar Exemplo</button>
        </div>

        <div style="margin-bottom:12px" class="card" style="padding:12px">
          <div class="shelf" id="shelf"></div>
        </div>

        <div class="grid-wrap card" style="padding:10px">
          <table class="schedule" aria-label="Grade semanal">
            <thead>
              <tr>
                <th>Horário</th>
                <th>Segunda</th>
                <th>Terça</th>
                <th>Quarta</th>
                <th>Quinta</th>
                <th>Sexta</th>
              </tr>
            </thead>
            <tbody id="grade"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Turma -->
<div class="modal" id="modalTurma">
  <div class="modal-card">
    <div class="space-between"><h3 style="margin:0">Turma</h3><button class="btn ghost" onclick="closeModal('modalTurma')">Fechar</button></div>
    <div style="margin-top:10px">
      <label>Nome da turma</label>
      <input type="text" id="inputTurmaName" placeholder="Ex: 6ºA">
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn ghost" onclick="closeModal('modalTurma')">Cancelar</button>
        <button class="btn" onclick="saveTurma()">Salvar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Disciplina -->
<div class="modal" id="modalDisciplina">
  <div class="modal-card">
    <div class="space-between"><h3 style="margin:0">Disciplina</h3><button class="btn ghost" onclick="closeModal('modalDisciplina')">Fechar</button></div>
    <div style="margin-top:10px">
      <label>Nome da disciplina</label>
      <input type="text" id="inputDiscName" placeholder="Ex: Matemática">
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn ghost" onclick="closeModal('modalDisciplina')">Cancelar</button>
        <button class="btn" onclick="saveDisciplina()">Salvar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Professor (Wizard) -->
<div class="modal" id="modalProfessor">
  <div class="modal-card">
    <div class="space-between">
      <h3 style="margin:0">Professor</h3>
      <button class="btn ghost" onclick="closeProfessorModal()">Fechar</button>
    </div>

    <div style="margin-top:10px">
      <div class="wizard-steps">
        <div class="pill" id="pill1">1. Dados</div>
        <div class="pill" id="pill2">2. Disciplinas / Meta</div>
        <div class="pill" id="pill3">3. Disponibilidade</div>
      </div>

      <div id="wiz1">
        <label>Nome</label>
        <input type="text" id="profName" placeholder="Ex: Maria Silva">
        <div style="margin-top:12px;text-align:right">
          <button class="btn ghost" onclick="closeProfessorModal()">Cancelar</button>
          <button class="btn" onclick="profNext(2)">Próximo</button>
        </div>
      </div>

      <div id="wiz2" style="display:none">
        <label>Disciplina</label>
        <select id="profDiscSelect" style="padding:8px;border-radius:8px;border:1px solid #e6eef8"></select>
        <div class="row" style="margin-top:8px">
          <input type="number" id="profMeta" placeholder="Meta de aulas (nº)" min="1" style="width:140px">
          <button class="btn ghost" onclick="addProfDisc()">Adicionar</button>
        </div>
        <ul id="profDiscList" class="simple small-muted" style="margin-top:8px"></ul>
        <div style="margin-top:12px;text-align:right">
          <button class="btn ghost" onclick="profPrev(1)">Voltar</button>
          <button class="btn" onclick="profNext(3)">Próximo</button>
        </div>
      </div>

      <div id="wiz3" style="display:none">
        <label>Disponibilidade (marque dias)</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
          <label><input type="checkbox" value="Segunda" class="disp-day"> Segunda</label>
          <label><input type="checkbox" value="Terça" class="disp-day"> Terça</label>
          <label><input type="checkbox" value="Quarta" class="disp-day"> Quarta</label>
          <label><input type="checkbox" value="Quinta" class="disp-day"> Quinta</label>
          <label><input type="checkbox" value="Sexta" class="disp-day"> Sexta</label>
        </div>
        <ul id="previewDisp" class="simple small-muted" style="margin-top:8px"></ul>

        <div style="margin-top:12px;text-align:right">
          <button class="btn ghost" onclick="profPrev(2)">Voltar</button>
          <button class="btn" onclick="saveProfessor()">Salvar</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* ===== Storage key ===== */
const STORAGE_KEY = 'horario_app_v1';

/* ===== Dados em memória ===== */
let turmas = []; // {id,name}
let disciplinas = []; // {id,name}
let professores = []; // {id,name, disciplinasMeta:[{discId,discName,meta}], disponibilidades:[dayStrings]}
let horarios = []; // {id, turmaId, turmaName, dia, inicio, fim, disciplinaId, disciplinaName, professorId, professorName}

/* temporários modal wizard */
let editingTurmaId = null;
let editingDiscId = null;
let editingProfessorId = null;
let wizardTemp = {discs: [], days: []};

/* util */
function uid(){ return 'id'+Math.random().toString(36).slice(2,9); }
function timeToMinutes(t){ const [hh,mm]=t.split(':').map(Number); return hh*60+mm; }
function minutesToTime(m){ return String(Math.floor(m/60)).padStart(2,'0')+':'+String(m%60); }

/* ========== persistence ========= */
function saveToStorage(){
  try {
    const payload = {turmas, disciplinas, professores, horarios};
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    // console.log('Saved');
  } catch(e) {
    console.error('Erro ao salvar localStorage', e);
  }
}
function loadFromStorage(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return false;
    const data = JSON.parse(raw);
    turmas = data.turmas || [];
    disciplinas = data.disciplinas || [];
    professores = data.professores || [];
    horarios = data.horarios || [];
    return true;
  } catch(e){
    console.error('Erro ao carregar localStorage', e);
    return false;
  }
}

/* load at start */
(function(){
  const ok = loadFromStorage();
  if(ok){
    renderAll();
  } else {
    renderAll(); // still render empty UI
  }
})();

/* ===== Tabs UI ===== */
const tabBtnCad = document.getElementById('tabBtnCad');
const tabBtnMont = document.getElementById('tabBtnMont');
tabBtnCad.addEventListener('click', ()=>{ showCard('cadastro') });
tabBtnMont.addEventListener('click', ()=>{ showCard('montar') });

function showCard(id){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  if(id==='cadastro') tabBtnCad.classList.add('active'); else tabBtnMont.classList.add('active');

  document.getElementById('cardCadastro').style.display = id==='cadastro' ? 'block' : 'none';
  document.getElementById('cardMontar').style.display = id==='montar' ? 'block' : 'none';
  if(id==='montar'){ atualizarSelectTurma(); renderShelf(); resetarGrade(); }
}

/* modal helpers */
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }

/* ========== TURMA CRUD ========= */
function saveTurma(){
  const name = document.getElementById('inputTurmaName').value.trim();
  if(!name){ alert('Informe nome da turma'); return;}
  if(editingTurmaId){
    const t = turmas.find(x=>x.id===editingTurmaId); if(t) t.name = name;
    editingTurmaId = null;
  } else {
    if(turmas.some(t=>t.name===name)){ alert('Turma já existe'); return; }
    turmas.push({id: uid(), name});
  }
  document.getElementById('inputTurmaName').value='';
  closeModal('modalTurma');
  renderTurmas(); atualizarSelectTurma(); renderShelf(); resetarGrade();
  saveToStorage();
}

function renderTurmas(){
  const ul = document.getElementById('listaTurmas');
  if(!turmas.length){ ul.innerHTML = '<li class="small-muted">Nenhuma turma</li>'; return; }
  ul.innerHTML = turmas.map(t=>`<li>
    <div style="display:flex;align-items:center;gap:10px;"><strong>${t.name}</strong></div>
    <div style="display:flex;gap:8px">
      <button class="btn ghost" onclick="editTurma('${t.id}')">Editar</button>
      <button class="btn ghost" onclick="deleteTurma('${t.id}')">Excluir</button>
    </div>
  </li>`).join('');
}
function editTurma(id){
  const t = turmas.find(x=>x.id===id); if(!t) return;
  editingTurmaId = id;
  document.getElementById('inputTurmaName').value = t.name;
  openModal('modalTurma');
}
function deleteTurma(id){
  if(!confirm('Excluir turma e remover horários associados?')) return;
  turmas = turmas.filter(t=>t.id!==id);
  horarios = horarios.filter(h=>h.turmaId!==id);
  renderTurmas(); atualizarSelectTurma(); renderShelf(); resetarGrade();
  saveToStorage();
}

/* ========== DISCIPLINA CRUD ========= */
function saveDisciplina(){
  const name = document.getElementById('inputDiscName').value.trim();
  if(!name){ alert('Informe nome da disciplina'); return; }
  if(editingDiscId){
    const d = disciplinas.find(x=>x.id===editingDiscId); if(d) d.name = name;
    // update references in professors and horarios
    professores.forEach(p=>{
      p.disciplinasMeta.forEach(dm=>{ if(dm.discId===editingDiscId) dm.discName = name; });
    });
    horarios.forEach(h=>{ if(h.disciplinaId===editingDiscId) h.disciplinaName = name; });
    editingDiscId = null;
  } else {
    if(disciplinas.some(d=>d.name===name)){ alert('Disciplina já existe'); return; }
    disciplinas.push({id: uid(), name});
  }
  document.getElementById('inputDiscName').value='';
  closeModal('modalDisciplina');
  renderDisciplinas(); atualizarDiscSelects(); renderShelf(); resetarGrade();
  saveToStorage();
}

function renderDisciplinas(){
  const ul = document.getElementById('listaDisciplinas');
  if(!disciplinas.length){ ul.innerHTML = '<li class="small-muted">Nenhuma disciplina</li>'; return; }
  ul.innerHTML = disciplinas.map(d=>`<li>
    <div><strong>${d.name}</strong></div>
    <div style="display:flex;gap:8px">
      <button class="btn ghost" onclick="editDisciplina('${d.id}')">Editar</button>
      <button class="btn ghost" onclick="deleteDisciplina('${d.id}')">Excluir</button>
    </div>
  </li>`).join('');
}
function editDisciplina(id){
  const d = disciplinas.find(x=>x.id===id); if(!d) return;
  editingDiscId = id;
  document.getElementById('inputDiscName').value = d.name;
  openModal('modalDisciplina');
}
function deleteDisciplina(id){
  if(!confirm('Excluir disciplina? Isso removerá associações com professores e horários.')) return;
  disciplinas = disciplinas.filter(d=>d.id!==id);
  professores.forEach(p=> p.disciplinasMeta = p.disciplinasMeta.filter(dm=>dm.discId!==id));
  horarios = horarios.filter(h=>h.disciplinaId!==id);
  renderDisciplinas(); renderProfessores(); renderShelf(); resetarGrade();
  saveToStorage();
}

/* ===== PROFESSOR WIZARD CRUD ===== */
function openProfessorWizard(profId=null){
  wizardTemp = {discs: [], days: []};
  editingProfessorId = profId || null;
  document.getElementById('profName').value = '';
  document.getElementById('profDiscList').innerHTML = '';
  document.querySelectorAll('.disp-day').forEach(chk=>chk.checked=false);
  atualizarDiscSelects();
  if(profId){
    const p = professores.find(x=>x.id===profId);
    if(p){
      document.getElementById('profName').value = p.name;
      wizardTemp.discs = JSON.parse(JSON.stringify(p.disciplinasMeta || []));
      wizardTemp.days = JSON.parse(JSON.stringify(p.disponibilidades || []));
      renderWizardDiscs(); renderWizardDays();
    }
  }
  showWizardStep(1);
  openModal('modalProfessor');
}
function profNext(n){
  if(n===2){
    const name = document.getElementById('profName').value.trim();
    if(!name){ alert('Informe o nome'); return; }
  }
  if(n===3){
    if(wizardTemp.discs.length===0){ alert('Adicione ao menos uma disciplina com meta'); return; }
  }
  showWizardStep(n);
}
function profPrev(n){ showWizardStep(n); }
function showWizardStep(n){
  document.getElementById('wiz1').style.display = n===1 ? 'block' : 'none';
  document.getElementById('wiz2').style.display = n===2 ? 'block' : 'none';
  document.getElementById('wiz3').style.display = n===3 ? 'block' : 'none';
  document.getElementById('pill1').style.opacity = n===1 ? 1:0.5;
  document.getElementById('pill2').style.opacity = n===2 ? 1:0.5;
  document.getElementById('pill3').style.opacity = n===3 ? 1:0.5;
}

function atualizarDiscSelects(){
  const sel = document.getElementById('profDiscSelect');
  sel.innerHTML = `<option value="">-- selecione --</option>` + disciplinas.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
}
function addProfDisc(){
  const selId = document.getElementById('profDiscSelect').value;
  const meta = parseInt(document.getElementById('profMeta').value,10);
  if(!selId) { alert('Selecione disciplina'); return; }
  if(!meta || meta<=0){ alert('Informe meta válida'); return; }
  if(wizardTemp.discs.some(x=>x.discId===selId)) { alert('Disciplina já adicionada'); return; }
  const discObj = disciplinas.find(d=>d.id===selId);
  wizardTemp.discs.push({discId: discObj.id, discName: discObj.name, meta});
  document.getElementById('profMeta').value='';
  renderWizardDiscs();
}
function renderWizardDiscs(){
  const el = document.getElementById('profDiscList');
  if(!wizardTemp.discs.length){ el.innerHTML = '<li class="small-muted">Nenhuma</li>'; return; }
  el.innerHTML = wizardTemp.discs.map(d=>`<li>${d.discName} — meta: ${d.meta} <button class="btn ghost" onclick="removeWizardDisc('${d.discId}')">Rem</button></li>`).join('');
}
function removeWizardDisc(dId){ wizardTemp.discs = wizardTemp.discs.filter(x=>x.discId!==dId); renderWizardDiscs(); }

function renderWizardDays(){
  const el = document.getElementById('previewDisp');
  if(!wizardTemp.days.length){ el.innerHTML = '<li class="small-muted">Nenhum dia marcado</li>'; return; }
  el.innerHTML = wizardTemp.days.map(d=>`<li>${d}</li>`).join('');
}
function addProfDayFromCheckboxes(){
  const checked = [...document.querySelectorAll('.disp-day')].filter(c=>c.checked).map(c=>c.value);
  wizardTemp.days = Array.from(new Set(checked));
  renderWizardDays();
}
document.querySelectorAll('.disp-day').forEach(chk=>chk.addEventListener('change', ()=> addProfDayFromCheckboxes()));

function saveProfessor(){
  const name = document.getElementById('profName').value.trim();
  if(!name){ alert('Informe nome'); return; }
  if(wizardTemp.discs.length===0){ alert('Adicione pelo menos 1 disciplina'); return; }
  if(wizardTemp.days.length===0){ alert('Marque ao menos 1 dia de disponibilidade'); return; }

  if(editingProfessorId){
    const p = professores.find(x=>x.id===editingProfessorId);
    if(p){
      p.name = name;
      p.disciplinasMeta = JSON.parse(JSON.stringify(wizardTemp.discs));
      p.disponibilidades = JSON.parse(JSON.stringify(wizardTemp.days));
      horarios.forEach(h=> { if(h.professorId===p.id) h.professorName = p.name; });
    }
    editingProfessorId = null;
  } else {
    if(professores.some(p=>p.name===name)){ if(!confirm('Professor com o mesmo nome já existe — continuar?')) return; }
    professores.push({ id: uid(), name, disciplinasMeta: JSON.parse(JSON.stringify(wizardTemp.discs)), disponibilidades: JSON.parse(JSON.stringify(wizardTemp.days))});
  }

  wizardTemp = {discs:[], days:[]};
  document.getElementById('profName').value='';
  document.getElementById('profDiscList').innerHTML='';
  document.querySelectorAll('.disp-day').forEach(c=>c.checked=false);
  closeProfessorModal();
  renderProfessores(); renderShelf(); resetarGrade();
  saveToStorage();
}
function closeProfessorModal(){
  editingProfessorId = null;
  wizardTemp = {discs:[], days:[]};
  closeModal('modalProfessor');
}

function renderProfessores(){
  const ul = document.getElementById('listaProfessores');
  if(!professores.length){ ul.innerHTML = '<li class="small-muted">Nenhum professor</li>'; return; }
  ul.innerHTML = professores.map(p=>{
    const discs = p.disciplinasMeta.map(dm=>`${dm.discName}(m:${dm.meta})`).join('; ');
    const days = p.disponibilidades.join(', ');
    return `<li>
      <div style="text-align:left">
        <strong>${p.name}</strong>
        <div class="small-muted">${discs}</div>
        <div class="small-muted">Disponível: ${days}</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" onclick="editProfessor('${p.id}')">Editar</button>
        <button class="btn ghost" onclick="deleteProfessor('${p.id}')">Excluir</button>
      </div>
    </li>`;
  }).join('');
}
function editProfessor(id){
  openProfessorWizard(id);
  editingProfessorId = id;
}
function deleteProfessor(id){
  if(!confirm('Excluir professor e remover horários associados?')) return;
  professores = professores.filter(p=>p.id!==id);
  horarios = horarios.filter(h=>h.professorId!==id);
  renderProfessores(); renderShelf(); resetarGrade();
  saveToStorage();
}

/* ===== PRATELEIRA (shelf) ===== */
function countAssigned(profId, discId){
  return horarios.filter(h=>h.professorId===profId && h.disciplinaId===discId).length;
}
function renderShelf(){
  const el = document.getElementById('shelf');
  el.innerHTML = '';
  const items = [];
  professores.forEach(p=>{
    p.disciplinasMeta.forEach(dm=>{
      const atrib = countAssigned(p.id, dm.discId);
      const done = atrib >= dm.meta;
      items.push({profId:p.id, profName:p.name, discId:dm.discId, discName:dm.discName, atrib, meta:dm.meta, done});
    });
  });
  if(items.length===0){ el.innerHTML = '<div class="small-muted">Cadastre professores/disciplinas (wizard) para ver itens aqui</div>'; return; }
  items.forEach(it=>{
    const node = document.createElement('div');
    node.className = 'shelf-item' + (it.done ? ' done' : '');
    node.draggable = true;
    node.dataset.profId = it.profId;
    node.dataset.discId = it.discId;
    node.dataset.origin = 'shelf';
    node.innerHTML = `<div style="display:flex;flex-direction:column;align-items:flex-start">
      <div style="font-weight:700">${it.discName}</div>
      <div class="meta">${it.profName}</div>
    </div><div class="count-bubble">${it.atrib}/${it.meta}</div>`;
    node.addEventListener('dragstart', shelfDragStart);
    el.appendChild(node);
  });
}
function shelfDragStart(e){
  const profId = e.currentTarget.dataset.profId;
  const discId = e.currentTarget.dataset.discId;
  e.dataTransfer.setData('application/json', JSON.stringify({origin:'shelf', profId, discId}));
  e.dataTransfer.effectAllowed = 'copy';
}

/* ===== GRADE functionality ===== */
const HOURS = ["07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00"];
const DAYS = ["Segunda","Terça","Quarta","Quinta","Sexta"];

function atualizarSelectTurma(){
  const sel = document.getElementById('selectTurma');
  sel.innerHTML = turmas.length ? `<option value="">-- selecione --</option>` + turmas.map(t=>`<option value="${t.id}">${t.name}</option>`).join('') : `<option value="">-- sem turmas --</option>`;
}

function resetarGrade(){
  const tbody = document.getElementById('grade');
  tbody.innerHTML = '';
  HOURS.forEach(h=>{
    const row = document.createElement('tr');
    const th = document.createElement('td'); th.textContent = h; row.appendChild(th);
    DAYS.forEach(day=>{
      const td = document.createElement('td');
      td.className = 'slot';
      td.dataset.day = day;
      td.dataset.time = h;
      td.addEventListener('dragover', slotDragOver);
      td.addEventListener('dragleave', ()=>td.classList.remove('drag-over'));
      td.addEventListener('drop', slotDrop);
      row.appendChild(td);
    });
    tbody.appendChild(row);
  });

  // place existing lessons for selected turma
  const selId = document.getElementById('selectTurma').value;
  if(!selId) return;
  horarios.filter(h=>h.turmaId===selId).forEach(h=>{
    const cell = [...document.querySelectorAll('.slot')].find(c=>c.dataset.day===h.dia && c.dataset.time===h.inicio);
    if(cell) addLessonToCell(cell, h);
  });
}

function slotDragOver(e){ e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function slotDrop(e){
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const payload = JSON.parse(e.dataTransfer.getData('application/json') || 'null');
  if(!payload) return;
  const day = e.currentTarget.dataset.day;
  const time = e.currentTarget.dataset.time;
  const turmaId = document.getElementById('selectTurma').value;
  if(!turmaId){ alert('Selecione a turma antes'); return; }

  const inicio = time;
  const fim = minutesToTime(timeToMinutes(time)+60);

  if(payload.origin === 'shelf'){
    const prof = professores.find(p=>p.id===payload.profId);
    const discMeta = prof && prof.disciplinasMeta.find(dm=>dm.discId===payload.discId);
    if(!prof || !discMeta){ alert('Dados inconsistentes'); return; }
    if(!prof.disponibilidades.includes(day)){ alert(`Professor ${prof.name} não disponível em ${day}`); return; }
    const conflict = horarios.find(h=>h.professorId===prof.id && h.dia===day && h.inicio===inicio);
    if(conflict){ alert(`Conflito: ${prof.name} já está em ${conflict.turmaName} (${conflict.inicio}–${conflict.fim})`); return; }
    const occupied = horarios.find(h=>h.turmaId===turmaId && h.dia===day && h.inicio===inicio);
    if(occupied){ alert('Célula já contém uma aula desta turma. Remova antes para mover.'); return; }
    const lesson = {
      id: uid(),
      turmaId, turmaName: turmas.find(t=>t.id===turmaId).name,
      dia: day, inicio, fim,
      disciplinaId: discMeta.discId, disciplinaName: discMeta.discName,
      professorId: prof.id, professorName: prof.name
    };
    horarios.push(lesson);
    addLessonToCell(e.currentTarget, lesson);
    renderShelf(); saveToStorage();
    return;
  }

  if(payload.origin === 'grade'){
    const lesson = horarios.find(h=>h.id===payload.id);
    if(!lesson) return;
    const prof = professores.find(p=>p.id===lesson.professorId);
    if(!prof) return;
    if(!prof.disponibilidades.includes(day)){ alert(`Professor ${prof.name} não disponível em ${day}`); return; }
    const conflict = horarios.find(h=>h.professorId===prof.id && h.dia===day && h.inicio===inicio && h.id !== lesson.id);
    if(conflict){ alert(`Conflito: ${prof.name} já está em ${conflict.turmaName}`); return; }
    const targetOcc = horarios.find(h=>h.turmaId===turmaId && h.dia===day && h.inicio===inicio && h.id !== lesson.id);
    if(targetOcc){ alert('Célula ocupada por outra aula desta turma'); return; }
    lesson.turmaId = turmaId;
    lesson.turmaName = turmas.find(t=>t.id===turmaId).name;
    lesson.dia = day;
    lesson.inicio = inicio;
    lesson.fim = fim;
    resetarGrade(); renderShelf(); saveToStorage();
  }
}

function addLessonToCell(cell, lesson){
  cell.innerHTML = '';
  const div = document.createElement('div');
  div.className = 'lesson';
  div.draggable = true;
  div.dataset.id = lesson.id;
  div.innerHTML = `<strong>${lesson.disciplinaName}</strong><div class="small">${lesson.professorName}</div><div class="small">(${lesson.inicio}–${lesson.fim})</div>`;
  div.addEventListener('dragstart', lessonDragStart);
  div.addEventListener('dblclick', ()=>{
    if(!confirm('Remover esta aula?')) return;
    horarios = horarios.filter(h=>h.id!==lesson.id);
    resetarGrade(); renderShelf(); saveToStorage();
  });
  cell.appendChild(div);
}
function lessonDragStart(e){
  const id = e.currentTarget.dataset.id;
  e.dataTransfer.setData('application/json', JSON.stringify({origin:'grade', id}));
  e.dataTransfer.effectAllowed = 'move';
}

/* ===== Render helpers & init ===== */
function renderAll(){
  renderTurmas(); renderDisciplinas(); renderProfessores(); renderShelf(); atualizarSelectTurma(); resetarGrade();
}
function renderTurmas(){ document.getElementById('listaTurmas').innerHTML = turmas.length ? turmas.map(t=>`<li><div style="display:flex;align-items:center;gap:10px"><strong>${t.name}</strong></div><div style="display:flex;gap:8px"><button class="btn ghost" onclick="editTurma('${t.id}')">Editar</button><button class="btn ghost" onclick="deleteTurma('${t.id}')">Excluir</button></div></li>`).join('') : '<li class="small-muted">Nenhuma turma</li>'; }
function renderDisciplinas(){ document.getElementById('listaDisciplinas').innerHTML = disciplinas.length ? disciplinas.map(d=>`<li><div><strong>${d.name}</strong></div><div style="display:flex;gap:8px"><button class="btn ghost" onclick="editDisciplina('${d.id}')">Editar</button><button class="btn ghost" onclick="deleteDisciplina('${d.id}')">Excluir</button></div></li>`).join('') : '<li class="small-muted">Nenhuma disciplina</li>'; }
function renderProfessores(){ document.getElementById('listaProfessores').innerHTML = professores.length ? professores.map(p=>`<li><div style="text-align:left"><strong>${p.name}</strong><div class="small-muted">${p.disciplinasMeta.map(dm=>dm.discName+`(m:${dm.meta})`).join('; ')}</div><div class="small-muted">Disponível: ${p.disponibilidades.join(', ')}</div></div><div style="display:flex;gap:8px"><button class="btn ghost" onclick="editProfessor('${p.id}')">Editar</button><button class="btn ghost" onclick="deleteProfessor('${p.id}')">Excluir</button></div></li>`).join('') : '<li class="small-muted">Nenhum professor</li>'; }
function atualizarSelectTurma(){ const sel = document.getElementById('selectTurma'); sel.innerHTML = turmas.length ? `<option value="">-- selecione --</option>` + turmas.map(t=>`<option value="${t.id}">${t.name}</option>`).join('') : `<option value="">-- sem turmas --</option>`; }

/* ===== Export / Import example (also saves) ===== */
function exportJSON(){
  const data = {turmas, disciplinas, professores, horarios};
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'horarios.json'; a.click(); URL.revokeObjectURL(url);
}
function importExample(){
  turmas = [{id:uid(),name:'6ºA'},{id:uid(),name:'7ºB'}];
  disciplinas = [{id:uid(),name:'Matemática'},{id:uid(),name:'Português'},{id:uid(),name:'Ciências'}];
  professores = [
    {id:uid(), name:'Ana Souza', disciplinasMeta:[{discId:disciplinas[0].id,discName:disciplinas[0].name,meta:5}], disponibilidades:['Segunda','Quarta','Sexta']},
    {id:uid(), name:'Carlos Lima', disciplinasMeta:[{discId:disciplinas[1].id,discName:disciplinas[1].name,meta:4}], disponibilidades:['Terça','Quinta']},
  ];
  horarios = [];
  renderAll(); saveToStorage();
  alert('Exemplo carregado — selecione uma turma para usar a grade.');
}

/* initial render if storage already loaded earlier */
renderAll();

</script>
</body>
</html>
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistema de Horários</title>
<style>
  body{font-family:Arial, sans-serif;background:#f5f7fb;margin:0;padding:20px;color:#111}
  h1{margin:0 0 20px}
  .card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);margin-bottom:20px}
  label{display:block;margin-top:8px;font-weight:bold}
  input,select,button{padding:6px 10px;margin-top:4px;border-radius:5px;border:1px solid #ccc}
  button{cursor:pointer;background:#2463ff;color:#fff;border:none}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ddd;padding:6px;text-align:center}
  th{background:#f0f0f0}
  td{cursor:pointer}
  .muted{color:#555;font-size:13px}
  .ok{color:green;font-weight:bold}
  option.disabled{color:#aaa}
  /* modal */
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center}
  .modal-content{background:#fff;padding:20px;border-radius:8px;width:340px;max-width:90%}
  .close{float:right;cursor:pointer;color:red;font-weight:bold}
</style>
</head>
<body>

<h1>Sistema de Horários</h1>

<div class="card">
  <h2>Cadastros</h2>
  <label>Nova disciplina</label>
  <input id="disciplinaNome" type="text"><button id="btnAddDisciplina">Adicionar</button>
  <div id="listaDisciplinas" class="muted"></div>

  <label>Nova turma</label>
  <input id="turmaNome" type="text"><button id="btnAddTurma">Adicionar</button>
  <div id="listaTurmas" class="muted"></div>

  <h3>Professor</h3>
  <label>Nome</label>
  <input id="profNome" type="text">

  <label>Disciplinas + Carga Horária Máxima</label>
  <div id="disciplinasCheckboxes"></div>

  <label>Dias disponíveis</label>
  <div id="diasCheckboxes">
    <label><input type="checkbox" value="Segunda">Segunda</label>
    <label><input type="checkbox" value="Terça">Terça</label>
    <label><input type="checkbox" value="Quarta">Quarta</label>
    <label><input type="checkbox" value="Quinta">Quinta</label>
    <label><input type="checkbox" value="Sexta">Sexta</label>
  </div>
  <button id="btnAddProfessor">Cadastrar professor</button>
  <div id="listaProfessores" class="muted"></div>
</div>

<div class="card">
  <h2>Montar Horário</h2>
  <label>Turma</label>
  <select id="selectTurma"></select>
  <label>Períodos por dia</label>
  <select id="periodosCount">
    <option value="4">4</option>
    <option value="5" selected>5</option>
    <option value="6">6</option>
  </select>
  <button id="btnGerarGrid">Gerar grade</button>
  <div id="gridArea"></div>
</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <span id="closeModal" class="close">&times;</span>
    <h3>Atribuir Aula</h3>
    <label>Professor disponível</label>
    <select id="modalProfessor"></select>
    <label>Disciplina</label>
    <select id="modalDisciplina"></select>
    <button id="btnSalvarCelula">Salvar</button>
  </div>
</div>

<script>
const DAYS=["Segunda","Terça","Quarta","Quinta","Sexta"];
let state={disciplinas:[], turmas:[], professores:[], horarios:{}};
function uid(){return Math.random().toString(36).substr(2,9);}
const $=s=>document.querySelector(s);

function refreshSelects(){
  let st=$("#selectTurma"); st.innerHTML="";
  state.turmas.forEach(t=>{let o=document.createElement("option");o.value=t.id;o.textContent=t.nome;st.appendChild(o);});
}

function renderDisciplinas(){
  let d=$("#listaDisciplinas"); d.innerHTML=state.disciplinas.map(x=>x.nome).join(", ");
  let c=$("#disciplinasCheckboxes"); c.innerHTML="";
  state.disciplinas.forEach(disc=>{
    let div=document.createElement("div");
    div.innerHTML=`<label><input type="checkbox" value="${disc.id}" onchange="toggleInputMax(this)"> ${disc.nome}</label> <input type="number" class="maxInput" data-disc="${disc.id}" placeholder="Máx aulas" style="display:none;width:90px">`;
    c.appendChild(div);
  });
}
function renderTurmas(){ $("#listaTurmas").innerHTML=state.turmas.map(t=>t.nome).join(", "); refreshSelects(); }
function renderProf(){ $("#listaProfessores").innerHTML=state.professores.map(p=>p.nome).join(", "); }

function toggleInputMax(chk){
  let inp=chk.parentNode.nextElementSibling;
  if(chk.checked) inp.style.display="inline-block";
  else{ inp.style.display="none"; inp.value=""; }
}

// eventos cadastros
$("#btnAddDisciplina").onclick=()=>{
  let v=$("#disciplinaNome").value.trim(); if(!v) return;
  state.disciplinas.push({id:uid(),nome:v}); $("#disciplinaNome").value=""; renderDisciplinas();
};
$("#btnAddTurma").onclick=()=>{
  let v=$("#turmaNome").value.trim(); if(!v) return;
  state.turmas.push({id:uid(),nome:v}); $("#turmaNome").value=""; renderTurmas();
};
$("#btnAddProfessor").onclick=()=>{
  let nome=$("#profNome").value.trim(); if(!nome) return;
  let discElems=[...document.querySelectorAll("#disciplinasCheckboxes input[type=checkbox]:checked")];
  let discs=discElems.map(c=>{
    let max=parseInt(c.parentNode.nextElementSibling.value||"0");
    return {id:c.value,max};
  });
  let dias=[...document.querySelectorAll("#diasCheckboxes input:checked")].map(i=>i.value);
  state.professores.push({id:uid(),nome,disciplinas:discs,dias});
  $("#profNome").value=""; renderProf();
};

// gerar grade
$("#btnGerarGrid").onclick=()=>{
  let turma=$("#selectTurma").value; if(!turma){alert("Selecione turma");return;}
  let p=parseInt($("#periodosCount").value);
  if(!state.horarios[turma]){
    state.horarios[turma]={periodos:p,grid:{}};
    DAYS.forEach(d=> state.horarios[turma].grid[d]=Array(p).fill(null));
  }
  renderGrid(turma);
};

function renderGrid(turmaId){
  let h=state.horarios[turmaId]; if(!h) return;
  let area=$("#gridArea"); area.innerHTML="";
  let table=document.createElement("table");
  let thead=document.createElement("tr");
  thead.innerHTML="<th>Período\\Dia</th>"+DAYS.map(d=>"<th>"+d+"</th>").join("");
  table.appendChild(thead);
  for(let p=0;p<h.periodos;p++){
    let tr=document.createElement("tr");
    tr.innerHTML="<th>"+(p+1)+"</th>";
    DAYS.forEach(d=>{
      let td=document.createElement("td");
      td.dataset.dia=d; td.dataset.periodo=p; td.dataset.turma=turmaId;
      let cell=h.grid[d][p];
      td.innerHTML=cell? `<b>${getDisc(cell.disciplinaId)}</b><br><span class="muted">${getProf(cell.professorId)}</span>`:"—";
      td.onclick=()=>openModal(td);
      tr.appendChild(td);
    });
    table.appendChild(tr);
  }
  area.appendChild(table);
}

function getDisc(id){return state.disciplinas.find(d=>d.id==id)?.nome||"—";}
function getProf(id){return state.professores.find(p=>p.id==id)?.nome||"—";}

let currentCell=null;
function openModal(td){
  currentCell={dia:td.dataset.dia,periodo:parseInt(td.dataset.periodo),turma:td.dataset.turma};
  let profSel=$("#modalProfessor"); profSel.innerHTML="";
  let avail=state.professores.filter(p=>{
    return p.dias.includes(currentCell.dia) && !isProfOcupado(p.id,currentCell.dia,currentCell.periodo);
  });
  avail.forEach(p=>{let o=document.createElement("option");o.value=p.id;o.textContent=p.nome;profSel.appendChild(o);});
  atualizarDisciplinas();
  $("#modal").style.display="flex";
}

function atualizarDisciplinas(){
  let profId=$("#modalProfessor").value;
  let prof=state.professores.find(p=>p.id==profId);
  let dsel=$("#modalDisciplina"); dsel.innerHTML="";
  if(prof){
    prof.disciplinas.forEach(d=>{
      let usado=contarAulas(prof.id,d.id);
      let max=d.max;
      let o=document.createElement("option");
      o.value=d.id; o.textContent=`${getDisc(d.id)} (${usado}/${max})`;
      if(usado>=max){ o.disabled=true; o.classList.add("disabled"); }
      else o.classList.add("ok");
      dsel.appendChild(o);
    });
  }
}
$("#modalProfessor").onchange=atualizarDisciplinas;

function isProfOcupado(profId,dia,periodo){
  for(let tid in state.horarios){
    let h=state.horarios[tid];
    if(h.grid[dia] && h.grid[dia][periodo] && h.grid[dia][periodo].professorId==profId){
      return true;
    }
  }
  return false;
}

function contarAulas(profId,discId){
  let count=0;
  for(let tid in state.horarios){
    let h=state.horarios[tid];
    DAYS.forEach(d=>{
      h.grid[d].forEach(c=>{
        if(c && c.professorId==profId && c.disciplinaId==discId) count++;
      });
    });
  }
  return count;
}

$("#btnSalvarCelula").onclick=()=>{
  let profId=$("#modalProfessor").value;
  let discId=$("#modalDisciplina").value;
  if(!profId||!discId){alert("Escolha professor e disciplina");return;}
  let h=state.horarios[currentCell.turma];
  h.grid[currentCell.dia][currentCell.periodo]={professorId:profId,disciplinaId:discId};
  $("#modal").style.display="none";
  renderGrid(currentCell.turma);
};
$("#closeModal").onclick=()=>$("#modal").style.display="none";
</script>
</body>
</html>